/*!
 * ConsentFriend - Consent management platform for MODX
 * Version: 1.3.3
 * Build date: 2021-06-10
 */

var consentFriend=function(e){return e=e||{},Ext.applyIf(e,{}),consentFriend.superclass.constructor.call(this,e),this};Ext.extend(consentFriend,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},util:{}}),Ext.reg("consentfriend",consentFriend),ConsentFriend=new consentFriend,ConsentFriend.combo.CodeSection=function(e){e=e||{},Ext.applyIf(e,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("consentfriend.service_section_head"),"0"],[_("consentfriend.service_section_body"),"1"]]}),displayField:"d",valueField:"v",mode:"local",triggerAction:"all",editable:!1,selectOnFocus:!1}),ConsentFriend.combo.CodeSection.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.combo.CodeSection,Ext.form.ComboBox),Ext.reg("consentfriend-combo-code_section",ConsentFriend.combo.CodeSection),ConsentFriend.combo.Purposes=function(e,t){var n=new Ext.data.JsonStore({id:"id",root:"results",fields:[{name:"id",type:"int"},{name:"title_translated",type:"string"}],pageSize:10,url:ConsentFriend.config.connectorUrl,baseParams:{action:"mgr/purposes/getlist",combo:"1"}});e=e||{},Ext.applyIf(e,{pageSize:10,xtype:"superboxselect",store:n,mode:"remote",triggerAction:"all",displayField:"title_translated",valueField:"id",lazyRender:!0,editable:!0,typeAhead:!0,minChars:2,forceSelection:!0,extraItemCls:"x-tag",expandBtnCls:"x-form-trigger",clearBtnCls:"x-form-trigger"}),ConsentFriend.combo.Purposes.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.combo.Purposes,Ext.ux.form.SuperBoxSelect),Ext.reg("consentfriend-combo-purposes",ConsentFriend.combo.Purposes),ConsentFriend.util.HiddenForm=function(e,t){var n,i;Ext.isObject(t)&&((n=Ext.getBody()).createChild({tag:"iframe",cls:"x-hidden",id:"hiddenform-iframe",name:"iframe"}),i=n.createChild({tag:"form",cls:"x-hidden",id:"hiddenform-form",action:e,target:"iframe",method:"post"}),Ext.iterate(t,function(e,t){i.createChild({tag:"input",type:"text",cls:"x-hidden",id:"hiddenform-"+e,name:e,value:t})}),i.dom.submit())},ConsentFriend.util.renderBoolean=function(e,t){return t.css=1===parseInt(e)||e?"green":"red",1===parseInt(e)||e?_("yes"):_("no")},ConsentFriend.util.renderHtml=function(e){return e},ConsentFriend.grid.JsonGrid=function(e){this.ident=(e=e||{}).ident||"jsongrid-mecitem"+Ext.id(),this.hiddenField=new Ext.form.TextArea({name:e.hiddenName||e.name,hidden:!0}),this.fieldConfig=e.fieldConfig||[{name:"key"},{name:"value"}],this.fieldConfig.push({name:"id",hidden:!0}),this.fieldColumns=[],this.fieldNames=[],Ext.each(this.fieldConfig,function(e){this.fieldNames.push(e.name),this.fieldColumns.push({header:e.header||_(e.name),dataIndex:e.name,editable:!0,menuDisabled:!0,hidden:e.hidden||!1,editor:{xtype:e.xtype||"textfield",allowBlank:e.allowBlank||!0,enableKeyEvents:!0,fieldname:e.name,listeners:{change:{fn:this.saveValue,scope:this},keyup:{fn:function(e){var t=this.getSelectionModel().getSelected();t&&(t.set(e.fieldname,e.el.dom.value),this.saveValue())},scope:this}}},renderer:function(e,t){return t.css+="x-editable-column ",e},width:e.width||100})},this),this.fieldColumns.push({width:50,menuDisabled:!0,renderer:this.actionsColumnRenderer.bind(this)}),Ext.applyIf(e,{id:this.ident+"-json-grid",fields:this.fieldNames,autoHeight:!0,store:new Ext.data.JsonStore({fields:this.fieldNames,data:this.loadValue(e.value)}),enableDragDrop:!0,ddGroup:this.ident+"-json-grid-dd",labelStyle:"position: absolute",columns:this.fieldColumns,disableContextMenuAction:!0,tbar:["->",{text:'<i class="icon icon-plus"></i> '+_("add"),cls:"primary-button",handler:this.addElement,scope:this}],listeners:{render:{fn:this.renderListener,scope:this}}}),ConsentFriend.grid.JsonGrid.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.grid.JsonGrid,MODx.grid.LocalGrid,{getMenu:function(){var e=[];return e.push({text:_("remove"),handler:this.removeElement}),e},getActions:function(){return[{action:"removeElement",icon:"trash-o",text:_("remove")}]},addElement:function(){var e=this.getStore(),t={};Ext.each(this.fieldNames,function(e){t[e]=""}),t.id=this.getStore().getCount(),this.getStore().insert(this.getStore().getCount(),new e.recordType(t)),this.getView().refresh(),this.getSelectionModel().selectRow(0)},removeElement:function(){Ext.Msg.confirm(_("remove")||"",_("confirm_remove")||"",function(e){if("yes"===e){var t=this.getStore(),n=this.getSelectionModel().getSelections();if(!n.length)return!1;for(var i=0;i<n.length;i++){var r=n[i].id,o=t.findBy(function(e){if(e.id===r)return!0});t.removeAt(o)}this.getView().refresh(),this.saveValue()}},this)},renderListener:function(d){new Ext.dd.DropTarget(d.container,{copy:!1,ddGroup:this.ident+"-json-grid-dd",notifyDrop:function(e,t,n){var i=d.store,r=d.getSelectionModel(),o=r.getSelections(),t=e.getDragData(t);if(t){t=t.rowIndex;if(void 0!==t){for(var s=0;s<o.length;s++)i.remove(i.getById(o[s].id));i.insert(t,n.selections),r.clearSelections()}}d.getView().refresh(),d.saveValue()}}),this.add(this.hiddenField),this.saveValue()},loadValue:function(n){return(n=Ext.util.JSON.decode(n))&&Array.isArray(n)?Ext.each(n,function(e,t){n[t].id=t}):n=[],n},saveValue:function(){var e=[];Ext.each(this.getStore().getRange(),function(t){var n={};Ext.each(this.fieldNames,function(e){"id"!==e&&(n[e]=t.data[e])}),e.push(n)},this),this.hiddenField.setValue(Ext.util.JSON.encode(e))},_getActionsColumnTpl:function(){return new Ext.XTemplate('<tpl for="."><tpl if="actions !== null"><ul class="x-grid-buttons"><tpl for="actions"><li><i class="x-grid-action icon icon-{icon:htmlEncode}" title="{text:htmlEncode}" data-action="{action:htmlEncode}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0})},actionsColumnRenderer:function(e,t,n,i,r,o){return this._getActionsColumnTpl().apply({actions:this.getActions()})},onClick:function(e){var t,n,i=e.getTarget();i.classList.contains("x-grid-action")&&(!i.dataset.action||(this[t="action"+i.dataset.action.charAt(0).toUpperCase()+i.dataset.action.slice(1)]&&"function"==typeof this[t]||this[t=i.dataset.action]&&"function"==typeof this[t])&&(n=this.getSelectionModel().getSelected(),i=this.store.indexOf(n),this.menu.record=n.data,this[t](n,i,e)))}}),Ext.reg("grid-json",ConsentFriend.grid.JsonGrid),Ext.reg("consentfriend-grid-json",ConsentFriend.grid.JsonGrid),ConsentFriend.panel.Home=function(e){e=e||{},Ext.applyIf(e,{cls:"container home-panel"+(ConsentFriend.config.debug?" debug":"")+" modx"+ConsentFriend.config.modxversion,defaults:{collapsible:!1,autoHeight:!0},items:[{html:"<h2>"+_("consentfriend")+"</h2>"+(ConsentFriend.config.debug?'<div class="ribbon top-right"><span>'+_("consentfriend.debug_mode")+"</span></div>":""),border:!1,cls:"modx-page-header"},{defaults:{autoHeight:!0},border:!0,items:[{xtype:"consentfriend-panel-overview"}]},{cls:"treehillstudio_about",html:'<img width="133" height="40" src="'+ConsentFriend.config.assetsUrl+'img/mgr/treehill-studio-small.png" srcset="'+ConsentFriend.config.assetsUrl+'img/mgr/treehill-studio-small@2x.png 2x" alt="Treehill Studio">',listeners:{afterrender:function(e){e.getEl().select("img").on("click",function(){var e='<span style="display: inline-block; text-align: center"><img src="'+ConsentFriend.config.assetsUrl+'img/mgr/treehill-studio.png" srcset="'+ConsentFriend.config.assetsUrl+'img/mgr/treehill-studio@2x.png 2x" alt="Treehill Studio"><br>Â© 2020-2021 by <a href="https://treehillstudio.com" target="_blank">treehillstudio.com</a></span>';Ext.Msg.show({title:_("consentfriend")+" "+ConsentFriend.config.version,msg:e,buttons:Ext.Msg.OK,cls:"treehillstudio_window",width:330})})}}}]}),ConsentFriend.panel.Home.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.panel.Home,MODx.Panel),Ext.reg("consentfriend-panel-home",ConsentFriend.panel.Home),ConsentFriend.panel.HomeTab=function(e){e=e||{},Ext.applyIf(e,{id:"consentfriend-panel-"+e.tabtype,title:e.title,items:[{html:"<p>"+e.description+"</p>",border:!1,cls:"panel-desc"},{layout:"form",cls:"x-form-label-left main-wrapper",defaults:{autoHeight:!0},border:!0,items:[{id:"consentfriend-panel-"+e.tabtype+"-grid",xtype:"consentfriend-grid-"+e.tabtype,preventRender:!0}]}]}),ConsentFriend.panel.HomeTab.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.panel.HomeTab,MODx.Panel),Ext.reg("consentfriend-panel-hometab",ConsentFriend.panel.HomeTab),ConsentFriend.panel.Overview=function(e){e=e||{},this.ident="consentfriend-panel-overview"+Ext.id(),this.panelOverviewTabs=[{xtype:"consentfriend-panel-hometab",title:_("consentfriend.services"),description:_("consentfriend.services_desc"),tabtype:"services"},{xtype:"consentfriend-panel-hometab",title:_("consentfriend.purposes"),description:_("consentfriend.purposes_desc"),tabtype:"purposes"}],ConsentFriend.config.is_admin&&this.panelOverviewTabs.push({xtype:"consentfriend-panel-settings"}),Ext.applyIf(e,{id:this.ident,items:[{xtype:"modx-tabs",border:!0,stateful:!0,stateId:"consentfriend-panel-overview",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},autoScroll:!0,deferredRender:!1,forceLayout:!0,defaults:{layout:"form",autoHeight:!0,hideMode:"offsets"},items:this.panelOverviewTabs,listeners:{tabchange:function(e,t){"consentfriend-panel-settings"===t.xtype?Ext.getCmp("consentfriend-grid-system-settings").getStore().reload():"consentfriend-panel-hometab"===t.xtype&&Ext.getCmp("consentfriend-panel-"+t.tabtype+"-grid")&&Ext.getCmp("consentfriend-panel-"+t.tabtype+"-grid").getStore().reload()}}}]}),ConsentFriend.panel.Overview.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.panel.Overview,MODx.Panel),Ext.reg("consentfriend-panel-overview",ConsentFriend.panel.Overview),ConsentFriend.grid.Services=function(e){e=e||{},this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.ident=e.ident||"consentfriend-services"+Ext.id(),Ext.applyIf(e,{id:"consentfriend-grid-services",url:ConsentFriend.config.connectorUrl,baseParams:{action:"mgr/services/getlist"},fields:["id","name","title","title_formatted","title_translated","description","description_translated","code","code_section","callback","on_accept","on_init","on_decline","active","default","required","opt_out","only_once","contextual_consent_only","purposes","purposes_formatted","cookies","sortindex"],autoHeight:!0,paging:!0,remoteSort:!1,enableDragDrop:!0,ddGroup:"consentfriend-grid-dd",autoExpandColumn:"title",showActionsColumn:!1,columns:[{header:_("consentfriend.service_name"),dataIndex:"name",width:50},{header:_("consentfriend.service_title"),dataIndex:"title_formatted",renderer:ConsentFriend.util.renderHtml,width:70},{header:_("consentfriend.service_active"),dataIndex:"active",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_default"),dataIndex:"default",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_required"),dataIndex:"required",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_opt_out"),dataIndex:"opt_out",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_only_once"),dataIndex:"only_once",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_contextual_consent_only_short"),dataIndex:"contextual_consent_only",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.service_purposes"),dataIndex:"purposes_formatted",width:70},{renderer:{fn:this.buttonColumnRenderer,scope:this},width:40},{header:_("id"),dataIndex:"id",hidden:!0,width:20}],tbar:[{text:_("consentfriend.service_create"),cls:"primary-button",handler:this.createService},{text:_("consentfriend.service_export"),cls:"secondary-button",handler:this.exportService},{text:_("consentfriend.service_import"),cls:"secondary-button",handler:this.importService},"->",{xtype:"textfield",id:this.ident+"-service-filter-search",emptyText:_("search")+"â¦",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-service-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}],listeners:{render:{fn:this.renderListener,scope:this}}}),ConsentFriend.grid.Services.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.grid.Services,MODx.grid.Grid,{windows:{},getMenu:function(){var e=[];e.push({text:_("consentfriend.service_update"),handler:this.updateService}),e.push("-"),e.push({text:_("consentfriend.service_remove"),handler:this.removeService}),this.addContextMenuItem(e)},createService:function(e,t){this.createUpdateService(e,t,!1)},updateService:function(e,t){this.createUpdateService(e,t,!0)},createUpdateService:function(e,t,n){var i;if(n){if(!this.menu.record||!this.menu.record.id)return!1;i=this.menu.record}else i={active:!0};var r=MODx.load({xtype:"consentfriend-window-service-create-update",isUpdate:n,title:n?_("consentfriend.service_update"):_("consentfriend.service_create"),record:i,listeners:{success:{fn:this.refresh,scope:this},beforeSubmit:function(e){r.beforeSubmit(e)}}});r.fp.getForm().setValues(i),r.show(t.target)},removeService:function(){if(!this.menu.record)return!1;MODx.msg.confirm({title:_("consentfriend.service_remove"),text:_("consentfriend.service_remove_confirm"),url:ConsentFriend.config.connectorUrl,params:{action:"mgr/services/remove",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}})},exportService:function(){ConsentFriend.util.HiddenForm(ConsentFriend.config.connectorUrl,{action:"mgr/services/export",limit:0,HTTP_MODAUTH:MODx.siteId})},importService:function(){MODx.load({xtype:"consentfriend-window-service-import",title:_("consentfriend.service_import"),listeners:{success:{fn:this.refresh,scope:this}}}).show()},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){this.getStore().baseParams.query="",Ext.getCmp(this.ident+"-service-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},renderListener:function(c){new Ext.dd.DropTarget(c.container,{ddGroup:"consentfriend-grid-dd",notifyDrop:function(e,t,n){var i=c.store,r=c.getSelectionModel(),o=r.getSelections(),e=e.getDragData(t);if(e){t=e.rowIndex;if(void 0!==t){for(var e=i.getAt(t),s=[],d=0;d<o.length;d++)i.remove(i.getById(o[d].id)),s.push(o[d].id);return i.insert(t,n.selections),r.clearSelections(),c.sortIndex(e.id,s),!0}}c.getView().refresh()}})},sortIndex:function(e,t){MODx.Ajax.request({url:ConsentFriend.config.connectorUrl,params:{action:"mgr/services/sortindex",targetId:e,movingIds:t.join()},listeners:{success:{fn:this.refresh,scope:this}}})},buttonColumnRenderer:function(){var e={action_buttons:[{className:"update",icon:"pencil-square-o",text:_("consentfriend.service_update")},{className:"remove",icon:"trash-o",text:_("consentfriend.service_remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var t=e.getTarget();if("icon"===t.className.split(" ")[0]){var t=t.className.split(" ")[1],n=this.getSelectionModel().getSelected();switch(this.menu.record=n.data,t){case"remove":this.removeService(n,e);break;case"update":this.updateService(n,e)}}}}),Ext.reg("consentfriend-grid-services",ConsentFriend.grid.Services),ConsentFriend.window.CreateUpdateService=function(e){this.ident=(e=e||{}).ident||"consentfriend-mecitem"+Ext.id(),Ext.applyIf(e,{id:this.ident,url:ConsentFriend.config.connectorUrl,action:e.isUpdate?"mgr/services/update":"mgr/services/create",autoHeight:!0,closeAction:"close",cls:"modx-window consentfriend-window consentfriend-window-tabs modx"+ConsentFriend.config.modxversion,width:800,keys:[{key:Ext.EventObject.ENTER,fn:function(e,t){var n=t.getTarget(),t=Ext.getCmp(n.id);if(t instanceof Ext.form.TextArea)return t.append("\n");if(-1<n.className.replace(/[\n\t]/g," ").indexOf("ace_text-input")){for(;(n=n.parentElement)&&!(-1<n.className.replace(/[\n\t]/g," ").indexOf("ace_editor")););return ace.edit(n.id).insert("\n")}this.submit()},scope:this}],fields:[{xtype:"modx-tabs",cls:"services-tabs",style:"padding-top: 15px",border:!0,stateful:!0,stateId:"consentfriend-services-create-update",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},autoScroll:!0,deferredRender:!1,forceLayout:!0,defaults:{layout:"form",autoHeight:!0,hideMode:"offsets"},items:[{title:_("consentfriend.services_tab_service"),cls:"services-tab-padding",items:[{layout:"column",items:[{columnWidth:.8,layout:"form",items:[{xtype:"textfield",fieldLabel:_("consentfriend.service_name"),description:_("consentfriend.service_name_desc"),name:"name",id:this.ident+"-name",allowBlank:!1,anchor:"100%"},{xtype:"textfield",fieldLabel:_("consentfriend.service_title"),description:_("consentfriend.service_title_desc"),emptyText:e.record.title_translated,name:"title",id:this.ident+"-title",anchor:"100%"},{xtype:"consentfriend-combo-purposes",fieldLabel:_("consentfriend.service_purposes"),description:_("consentfriend.service_purposes_desc"),name:"purposes",hiddenName:"purposes",id:this.ident+"-purposes",anchor:"100%"},{xtype:"hidden",name:"purpose_ids",id:this.ident+"-purpose_ids"},{xtype:"textarea",fieldLabel:_("consentfriend.service_description"),description:_("consentfriend.service_description_desc"),emptyText:e.record.description_translated,name:"description",id:this.ident+"-description",anchor:"100%"}]},{columnWidth:.2,layout:"form",items:[{xtype:"xcheckbox",boxLabel:_("consentfriend.service_active"),description:_("consentfriend.service_active_desc"),name:"active",id:this.ident+"-active"},{xtype:"xcheckbox",boxLabel:_("consentfriend.service_default"),description:_("consentfriend.service_default_desc"),name:"default",id:this.ident+"-default"},{xtype:"xcheckbox",boxLabel:_("consentfriend.service_required"),description:_("consentfriend.service_required_desc"),name:"required",id:this.ident+"-required"},{xtype:"xcheckbox",boxLabel:_("consentfriend.service_opt_out"),description:_("consentfriend.service_opt_out_desc"),name:"opt_out",id:this.ident+"-opt_out"},{xtype:"xcheckbox",boxLabel:_("consentfriend.service_only_once"),description:_("consentfriend.service_only_once_desc"),name:"only_once",id:this.ident+"-only_once"},{xtype:"xcheckbox",boxLabel:_("consentfriend.service_contextual_consent_only"),description:_("consentfriend.service_contextual_consent_only_desc"),name:"contextual_consent_only",id:this.ident+"-contextual_consent_only"}]}]}]},{title:_("consentfriend.services_tab_code"),cls:"services-tab-padding",items:[{xtype:"consentfriend-combo-code_section",fieldLabel:_("consentfriend.service_code_section"),description:_("consentfriend.service_code_section_desc"),name:"code_section",hiddenName:"code_section",id:this.ident+"-code_section",anchor:"100%"},{xtype:"textarea",fieldLabel:_("consentfriend.service_code"),name:"code",id:this.ident+"-code",cls:"consentfriend-code",height:400,anchor:"100%",listeners:{afterrender:function(){MODx.ux&&MODx.ux.Ace&&MODx.ux.Ace.replaceComponent(e.id+"-code","text/html",1)}}},{xtype:"label",forId:this.ident+"-code",html:_("consentfriend.service_code_desc"),cls:"desc-under"}]},{title:_("consentfriend.services_tab_cookies"),cls:"services-tab-padding services-tab-padding-cookies",items:[{html:"<p>"+_("consentfriend.service_cookies_desc")+"</p>",border:!1},{xtype:"consentfriend-grid-json",value:e.record.cookies,fieldLabel:_("consentfriend.service_cookies"),fieldConfig:[{name:"cookie",width:100,allowBlank:!1,header:_("consentfriend.service_cookie_cookie")},{name:"path",width:50,allowBlank:!0,header:_("consentfriend.service_cookie_path")},{name:"domain",width:100,allowBlank:!0,header:_("consentfriend.service_cookie_domain")}],name:"cookies",id:this.ident+"-cookies",anchor:"100%"}]},{title:_("consentfriend.services_tab_callbacks"),cls:"tab-vtabs",stateful:!0,stateId:"consentfriend-services-create-update-callbacks",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},items:[{xtype:"modx-vtabs",deferredRender:!1,items:[{title:_("consentfriend.services_tab_on_toggle"),items:[{xtype:"textarea",fieldLabel:_("consentfriend.service_callback"),name:"callback",id:this.ident+"-callback",cls:"consentfriend-callback",height:400,anchor:"100%",listeners:{afterrender:function(){MODx.ux&&MODx.ux.Ace&&MODx.ux.Ace.replaceComponent(e.id+"-callback","text/javascript",1)}}},{xtype:"label",forId:this.ident+"-callback",html:_("consentfriend.service_on_toggle_desc"),cls:"desc-under"}]},{title:_("consentfriend.services_tab_on_init"),items:[{xtype:"textarea",fieldLabel:_("consentfriend.service_callback"),name:"on_init",id:this.ident+"-on_init",cls:"consentfriend-on_init",height:400,anchor:"100%",listeners:{afterrender:function(){MODx.ux&&MODx.ux.Ace&&MODx.ux.Ace.replaceComponent(e.id+"-on_init","text/javascript",1)}}},{xtype:"label",forId:this.ident+"-on_init",html:_("consentfriend.service_on_init_desc"),cls:"desc-under"}]},{title:_("consentfriend.services_tab_on_accept"),items:[{xtype:"textarea",fieldLabel:_("consentfriend.service_callback"),name:"on_accept",id:this.ident+"-on_accept",cls:"consentfriend-on_accept",height:400,anchor:"100%",listeners:{afterrender:function(){MODx.ux&&MODx.ux.Ace&&MODx.ux.Ace.replaceComponent(e.id+"-on_accept","text/javascript",1)}}},{xtype:"label",forId:this.ident+"-on_accept",html:_("consentfriend.service_on_accept_desc"),cls:"desc-under"}]},{title:_("consentfriend.services_tab_on_decline"),items:[{xtype:"textarea",fieldLabel:_("consentfriend.service_callback"),name:"on_decline",id:this.ident+"-on_decline",cls:"consentfriend-on_decline",height:400,anchor:"100%",listeners:{afterrender:function(){MODx.ux&&MODx.ux.Ace&&MODx.ux.Ace.replaceComponent(e.id+"-on_decline","text/javascript",1)}}},{xtype:"label",forId:this.ident+"-on_decline",html:_("consentfriend.service_on_decline_desc"),cls:"desc-under"}]}]}]}]},{xtype:"hidden",name:"id",id:this.ident+"-id"}]}),ConsentFriend.window.CreateUpdateService.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.window.CreateUpdateService,MODx.Window,{beforeSubmit:function(e){e.hasOwnProperty("purposes")&&(e.purposes.isArray&&(e.purposes=e.purposes.join()),Ext.getCmp(this.ident+"-purpose_ids").setValue(e.purposes))}}),Ext.reg("consentfriend-window-service-create-update",ConsentFriend.window.CreateUpdateService),ConsentFriend.window.ImportService=function(e){e=e||{},this.ident="consentfriend-window-service-import"+Ext.id(),Ext.applyIf(e,{id:this.ident,cls:"modx-window consentfriend-window modx"+ConsentFriend.config.modxversion,url:ConsentFriend.config.connectorUrl,action:"mgr/services/import",fileUpload:!0,saveBtnText:_("consentfriend.service_import"),autoHeight:!0,closeAction:"close",fields:[{html:"<p>"+_("consentfriend.service_import_text")+"</p>",style:"padding-top: 15px"},{xtype:"fileuploadfield",id:"consentfriend-import-fileupload",fieldLabel:_("consentfriend.service_import_yaml_file"),name:"file",allowBlank:!1,anchor:"100%"},{xtype:"radiogroup",fieldLabel:_("consentfriend.service_import_mode"),columns:3,allowBlank:!1,anchor:"100%",items:[{boxLabel:_("consentfriend.service_import_append"),name:"mode",inputValue:"append",checked:!0},{boxLabel:_("consentfriend.service_import_replace"),name:"mode",inputValue:"replace"},{boxLabel:_("consentfriend.service_import_update"),name:"mode",inputValue:"update"}]}]}),ConsentFriend.window.ImportService.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.window.ImportService,MODx.Window),Ext.reg("consentfriend-window-service-import",ConsentFriend.window.ImportService),ConsentFriend.grid.Purposes=function(e){e=e||{},this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.ident=e.ident||"consentfriend-purposes"+Ext.id(),Ext.applyIf(e,{id:"consentfriend-grid-purposes",url:ConsentFriend.config.connectorUrl,baseParams:{action:"mgr/purposes/getlist"},fields:["id","key","title","title_formatted","title_translated","description","description_translated","active","sortindex"],autoHeight:!0,paging:!0,remoteSort:!1,enableDragDrop:!0,ddGroup:"consentfriend-grid-dd",autoExpandColumn:"title_formatted",showActionsColumn:!1,columns:[{header:_("consentfriend.purpose_key"),dataIndex:"key",width:100},{header:_("consentfriend.purpose_title"),dataIndex:"title_formatted",renderer:ConsentFriend.util.renderHtml,width:150},{header:_("consentfriend.purpose_active"),dataIndex:"active",renderer:ConsentFriend.util.renderBoolean,width:40},{header:_("consentfriend.purpose_sortindex"),dataIndex:"sortindex",hidden:!0,width:20},{renderer:{fn:this.buttonColumnRenderer,scope:this},width:40},{header:_("id"),dataIndex:"id",hidden:!0,width:20}],tbar:[{text:_("consentfriend.purpose_create"),cls:"primary-button",handler:this.createPurpose},{text:_("consentfriend.purpose_export"),cls:"secondary-button",handler:this.exportPurpose},{text:_("consentfriend.purpose_import"),cls:"secondary-button",handler:this.importPurpose},"->",{xtype:"textfield",id:this.ident+"-filter-search",emptyText:_("search")+"â¦",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}],listeners:{render:{fn:this.renderListener,scope:this}}}),ConsentFriend.grid.Purposes.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.grid.Purposes,MODx.grid.Grid,{windows:{},getMenu:function(){var e=[];e.push({text:_("consentfriend.purpose_update"),handler:this.updatePurpose}),e.push("-"),e.push({text:_("consentfriend.purpose_remove"),handler:this.removePurpose}),this.addContextMenuItem(e)},createPurpose:function(e,t){this.createUpdatePurpose(e,t,!1)},updatePurpose:function(e,t){this.createUpdatePurpose(e,t,!0)},createUpdatePurpose:function(e,t,n){var i;if(n){if(!this.menu.record||!this.menu.record.id)return!1;i=this.menu.record}else i={active:!0};n=MODx.load({xtype:"consentfriend-window-purpose-create-update",isUpdate:n,title:n?_("consentfriend.purpose_update"):_("consentfriend.purpose_create"),record:i,listeners:{success:{fn:this.refresh,scope:this}}});n.fp.getForm().setValues(i),n.show(t.target)},removePurpose:function(){if(!this.menu.record)return!1;MODx.msg.confirm({title:_("consentfriend.purpose_remove"),text:_("consentfriend.purpose_remove_confirm"),url:ConsentFriend.config.connectorUrl,params:{action:"mgr/purposes/remove",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}})},exportPurpose:function(){ConsentFriend.util.HiddenForm(ConsentFriend.config.connectorUrl,{action:"mgr/purposes/export",limit:0,HTTP_MODAUTH:MODx.siteId})},importPurpose:function(){MODx.load({xtype:"consentfriend-window-purpose-import",title:_("consentfriend.purpose_import"),listeners:{success:{fn:this.refresh,scope:this}}}).show()},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){this.getStore().baseParams.query="",Ext.getCmp(this.ident+"-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},renderListener:function(c){new Ext.dd.DropTarget(c.container,{ddGroup:"consentfriend-grid-dd",notifyDrop:function(e,t,n){var i=c.store,r=c.getSelectionModel(),o=r.getSelections(),e=e.getDragData(t);if(e){t=e.rowIndex;if(void 0!==t){for(var e=i.getAt(t),s=[],d=0;d<o.length;d++)i.remove(i.getById(o[d].id)),s.push(o[d].id);return i.insert(t,n.selections),r.clearSelections(),c.sortIndex(e.id,s),!0}}c.getView().refresh()}})},sortIndex:function(e,t){MODx.Ajax.request({url:ConsentFriend.config.connectorUrl,params:{action:"mgr/purposes/sortindex",targetId:e,movingIds:t.join()},listeners:{success:{fn:this.refresh,scope:this}}})},buttonColumnRenderer:function(){var e={action_buttons:[{className:"update",icon:"pencil-square-o",text:_("consentfriend.purpose_update")},{className:"remove",icon:"trash-o",text:_("consentfriend.purpose_remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var t=e.getTarget();if("icon"===t.className.split(" ")[0]){var t=t.className.split(" ")[1],n=this.getSelectionModel().getSelected();switch(this.menu.record=n.data,t){case"remove":this.removePurpose(n,e);break;case"update":this.updatePurpose(n,e)}}}}),Ext.reg("consentfriend-grid-purposes",ConsentFriend.grid.Purposes),ConsentFriend.window.CreateUpdatePurpose=function(e){this.ident=(e=e||{}).ident||"consentfriend-mecitem"+Ext.id(),Ext.applyIf(e,{id:this.ident,url:ConsentFriend.config.connectorUrl,action:e.isUpdate?"mgr/purposes/update":"mgr/purposes/create",autoHeight:!0,closeAction:"close",cls:"modx-window consentfriend-window consentfriend-window-tabs modx"+ConsentFriend.config.modxversion,fields:[{layout:"column",items:[{columnWidth:.8,layout:"form",items:[{xtype:"textfield",fieldLabel:_("consentfriend.purpose_key"),description:_("consentfriend.purpose_key_desc"),name:"key",id:this.ident+"-key",allowBlank:!1,anchor:"100%"}]},{columnWidth:.2,layout:"form",items:[{xtype:"xcheckbox",fieldLabel:_("consentfriend.purpose_active"),description:_("consentfriend.purpose_active_desc"),name:"active",id:this.ident+"-active"}]}]},{xtype:"textfield",fieldLabel:_("consentfriend.purpose_title"),description:_("consentfriend.purpose_title_desc"),emptyText:e.record.title_translated,name:"title",id:this.ident+"-title",anchor:"100%"},{xtype:"textarea",fieldLabel:_("consentfriend.purpose_description"),description:_("consentfriend.purpose_description_desc"),emptyText:e.record.description_translated,name:"description",id:this.ident+"-description",anchor:"100%"},{xtype:"hidden",name:"id",id:this.ident+"-id"}]}),ConsentFriend.window.CreateUpdatePurpose.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.window.CreateUpdatePurpose,MODx.Window),Ext.reg("consentfriend-window-purpose-create-update",ConsentFriend.window.CreateUpdatePurpose),ConsentFriend.window.ImportPurpose=function(e){e=e||{},this.ident="consentfriend-window-purpose-import"+Ext.id(),Ext.applyIf(e,{id:this.ident,cls:"modx-window consentfriend-window modx"+ConsentFriend.config.modxversion,url:ConsentFriend.config.connectorUrl,action:"mgr/purposes/import",fileUpload:!0,saveBtnText:_("consentfriend.purpose_import"),autoHeight:!0,closeAction:"close",fields:[{html:"<p>"+_("consentfriend.purpose_import_text")+"</p>",style:"padding-top: 15px"},{xtype:"fileuploadfield",id:"consentfriend-import-fileupload",fieldLabel:_("consentfriend.purpose_import_yaml_file"),name:"file",allowBlank:!1,anchor:"100%"},{xtype:"radiogroup",fieldLabel:_("consentfriend.purpose_import_mode"),columns:3,allowBlank:!1,anchor:"100%",items:[{boxLabel:_("consentfriend.purpose_import_append"),name:"mode",inputValue:"append",checked:!0},{boxLabel:_("consentfriend.purpose_import_replace"),name:"mode",inputValue:"replace"},{boxLabel:_("consentfriend.purpose_import_update"),name:"mode",inputValue:"update"}]}]}),ConsentFriend.window.ImportPurpose.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.window.ImportPurpose,MODx.Window),Ext.reg("consentfriend-window-purpose-import",ConsentFriend.window.ImportPurpose),ConsentFriend.panel.Settings=function(e){e=e||{},Ext.applyIf(e,{id:"consentfriend-panel-settings",title:_("consentfriend.settings"),items:[{html:"<p>"+_("consentfriend.settings_desc")+"</p>",border:!1,cls:"panel-desc"},{xtype:"consentfriend-grid-system-settings",id:"consentfriend-grid-system-settings",cls:"main-wrapper",preventSaveRefresh:!0}]}),ConsentFriend.panel.Settings.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.panel.Settings,MODx.Panel),Ext.reg("consentfriend-panel-settings",ConsentFriend.panel.Settings),ConsentFriend.grid.SystemSettings=function(e){e=e||{},Ext.applyIf(e,{id:"consentfriend-grid-systemsettings",url:ConsentFriend.config.connectorUrl,baseParams:{action:"mgr/settings/getlist",area:MODx.request.area},save_action:"mgr/settings/updatefromgrid",tbar:[{text:_("consentfriend.config_export"),cls:"secondary-button",handler:this.exportConfig},{text:_("consentfriend.config_import"),cls:"secondary-button",handler:this.importConfig}],queryParam:3<=ConsentFriend.config.modxversion?"query":"key"}),ConsentFriend.grid.SystemSettings.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.grid.SystemSettings,MODx.grid.SettingsGrid,{_showMenu:function(e,t,n){n.stopEvent(),n.preventDefault(),this.menu.record=this.getStore().getAt(t).data,this.getSelectionModel().isSelected(t)||this.getSelectionModel().selectRow(t),this.menu.removeAll();t=[];this.menu.record.menu?t=this.menu.record.menu:t.push({text:_("setting_update"),handler:this.updateSetting}),0<t.length&&(this.addContextMenuItem(t),this.menu.showAt(n.xy))},updateSetting:function(e,t){var n=this.menu.record;n.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var i=MODx.load({xtype:"modx-window-setting-update",url:ConsentFriend.config.connectorUrl,action:"mgr/settings/update",record:n,grid:this,listeners:{success:{fn:function(){this.refresh()},scope:this}}});i.reset(),i.setValues(n),i.show(t.target)},exportConfig:function(){ConsentFriend.util.HiddenForm(ConsentFriend.config.connectorUrl,{action:"mgr/config/export",limit:0,HTTP_MODAUTH:MODx.siteId})},importConfig:function(){MODx.load({xtype:"consentfriend-window-config-import",title:_("consentfriend.config_import"),listeners:{success:{fn:this.refresh,scope:this}}}).show()},clearFilter:function(){var e=MODx.request.area||"";this.getStore().baseParams=this.initialConfig.baseParams;var t=Ext.getCmp("modx-filter-area");t&&(t.store.load(),t.reset()),Ext.getCmp("modx-filter-"+this.config.queryParam).reset(),this.getStore().baseParams.area=e,this.getStore().baseParams[this.config.queryParam]="",this.getBottomToolbar().changePage(1)},filterByKey:function(e,t){return this.getStore().baseParams[this.config.queryParam]=t,this.getBottomToolbar().changePage(1),!0},filterByNamespace:function(){this.getStore().baseParams.area="",this.getBottomToolbar().changePage(1);var e,t=Ext.getCmp("modx-filter-area");t&&((e=t.store).removeAll(),e.load(),t.setValue(""))},listeners:{afterrender:function(){Ext.getCmp("modx-filter-namespace").hide()}}}),Ext.reg("consentfriend-grid-system-settings",ConsentFriend.grid.SystemSettings),ConsentFriend.window.ImportConfig=function(e){e=e||{},this.ident="consentfriend-window-config-import"+Ext.id(),Ext.applyIf(e,{id:this.ident,cls:"modx-window consentfriend-window modx"+ConsentFriend.config.modxversion,url:ConsentFriend.config.connectorUrl,action:"mgr/config/import",fileUpload:!0,saveBtnText:_("consentfriend.config_import"),autoHeight:!0,closeAction:"close",fields:[{html:"<p>"+_("consentfriend.config_import_text")+"</p>",style:"padding-top: 15px"},{xtype:"fileuploadfield",id:"consentfriend-import-fileupload",fieldLabel:_("consentfriend.config_import_yaml_file"),name:"file",allowBlank:!1,anchor:"100%"}]}),ConsentFriend.window.ImportConfig.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.window.ImportConfig,MODx.Window),Ext.reg("consentfriend-window-config-import",ConsentFriend.window.ImportConfig),ConsentFriend.page.Home=function(e){e=e||{},Ext.applyIf(e,{formpanel:"consentfriend-panel-home",components:[{xtype:"consentfriend-panel-home"}]}),ConsentFriend.page.Home.superclass.constructor.call(this,e)},Ext.extend(ConsentFriend.page.Home,MODx.Component),Ext.reg("consentfriend-page-home",ConsentFriend.page.Home);