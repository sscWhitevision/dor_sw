!function(d,c){c.fieldTypes.gallery=function(a,r){var s={imageCount:0,fileBrowser:!1,source:0<r.properties.source?r.properties.source:ContentBlocksConfig["image.source"],directory:r.properties.directory,init:function(){this.initUpload(),(0<r.properties.thumbnail_size||r.properties.thumbnail_size&&1<r.properties.thumbnail_size.length)&&(r.properties.thumb_size="specified"),a.find(".contentblocks-field-gallery-list").addClass("gallery-size-"+r.properties.thumb_size),a.find(".contentblocks-field-upload").on("click",function(){a.find(".contentblocks-field-upload-field").click()}),a.find(".contentblocks-field-gallery-choose").on("click",d.proxy(function(){this.chooseImage()},this)),a.find(".contentblocks-field-gallery-url").on("click",d.proxy(function(){this.promptImage()},this)),MODx.load({xtype:"modx-treedrop",target:a,targetEl:a.get(0),onInsert:function(e){s.addImageFromUrl(e)}}),d.isArray(r.images)&&d.each(r.images,function(e,i){s.imageCount++,i.id=r.generated_id+"-image"+s.imageCount,i.width=i.width||0,i.height=i.height||0,s.addImage(i,"init")}),a.find(".gallery-image-holder").sortable({connectWith:".gallery-image-holder",forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"contentblocks-gallery-placeholder",tolerance:"pointer",cursor:"move",update:function(){c.fixColumnHeights(),c.fireChange()},start:function(e,i){i.placeholder.height(i.item.height())}}),c.toBoolean(r.properties.show_description)||a.addClass("no-description"),c.toBoolean(r.properties.show_link_field)||a.addClass("no-link-field")},chooseImage:function(){var e=r.properties.max_images,i=a.find(".gallery-image-holder").find("li").length;if(0<e&&e<=i)return c.alert(_("contentblocks.max_images_reached",{max:e})),!1;e=MODx.load({xtype:"modx-browser",id:Ext.id(),multiple:!0,listeners:{select:function(e){s.chooseImageCallback(e)}},allowedFileTypes:r.properties.file_types,hideFiles:!0,title:_("contentblocks.choose_image"),source:s.source});e.setSource(s.source),e.show()},chooseImageCallback:function(e){var i=e.fullRelativeUrl;"http"!=i.substr(0,4)&&"/"!=i.substr(0,1)&&(i=MODx.config.base_url+i),s.imageCount++;var t=a.attr("id")+"-image"+s.imageCount,o=e.size,l=e.ext;this.addImage({url:i,title:e.filename,description:"",link:"",id:t,size:o,width:e.image_width,height:e.image_height,extension:l},"choose")},promptImage:function(){Ext.Msg.prompt(_("contentblocks.from_url_title"),_("contentblocks.from_url_prompt"),function(e,i,t){"ok"===e&&s.addImageFromUrl(i)},this)},addImageFromUrl:function(e){var i=a.find(".gallery-image-holder").find("li").length;if(0<r.properties.max_images&&i>=r.properties.max_images)return c.alert(_("contentblocks.max_images_reached",{max:r.properties.max_images})),!1;!e||e.length<3?c.alert("No URL provided."):(a.addClass("contentblocks-field-loading"),d.ajax({dataType:"json",url:ContentBlocksConfig.connector_url,type:"POST",beforeSend:function(e,i){i.crossDomain||e.setRequestHeader("modAuth",MODx.siteId)},data:{action:"content/image/download",field:r.field,resource:ContentBlocksResource&&ContentBlocksResource.id?ContentBlocksResource.id:0,url:e},context:this,success:function(e){var i,t;a.removeClass("contentblocks-field-loading"),e.success?(i=c.utilities.normaliseUrls(e.object.url),s.imageCount++,t=a.attr("id")+"-image"+s.imageCount,this.addImage({url:i.cleanedSrc,title:e.object.filename,description:"",link:"",id:t,size:e.object.size,width:e.object.width,height:e.object.height,extension:e.object.extension},"choose")):c.alert(e.message)}}))},addImage:function(e,i){var t=a.find(".gallery-image-holder"),o=c.utilities.normaliseUrls(e.url);e.url=o.cleanedSrc,e.description=e.description||"",e.link=e.link||"",e.thumbDisplay=r.properties.thumbnail_size?c.utilities.getThumbnailUrl(e.url,r.properties.thumbnail_size):o.displaySrc,t.append(tmpl("contentblocks-field-gallery-item",e));var l=d("#"+e.id);l.find(".contentblocks-gallery-image-delete").on("click",function(){l.fadeOut(function(){l.remove(),c.fixColumnHeights(),c.fireChange()})}),c.toBoolean(r.properties.show_link_field)&&c.initializeLinkField(l.find(".linkfield"),r)},initUpload:function(){var l=a.attr("id"),n=r.properties.max_images;a.find("#"+l+"-upload").fileupload({url:ContentBlocksConfig.connectorUrl+"?action=content/image/upload",dataType:"json",dropZone:d("#"+l),progressInterval:250,paramName:"file",multiple:!0,pasteZone:null,add:function(e,i){var t=a.find(".gallery-image-holder").find("li").length;if(0<n&&n<=t)return c.alert(_("contentblocks.max_images_reached",{max:n})),!1;s.imageCount++;t=l+"-image"+s.imageCount;i.files[0].ext=i.files[0].name.split(".").pop(),s.addImage({title:i.files[0].name,url:"",id:t,size:i.files[0].size,extension:i.files[0].ext},"upload"),i.domId="#"+t;var o=d(i.domId);o.addClass("uploading"),i.files[0].size<7e5&&window.FileReader&&((t=new FileReader).onload=function(e){o.find("img").attr("src",e.target.result),c.fixColumnHeights()},t.readAsDataURL(i.files[0])),setTimeout(function(){i.submit()},1e3),c.fireChange()},done:function(e,i){var t,o,l=d(i.domId);i.result.success?(t=i.result.object,o=c.utilities.normaliseUrls(t.url),l.find(".url").val(o.cleanedSrc),l.find(".size").val(t.size),l.find(".width").val(t.width),l.find(".height").val(t.height),l.find(".extension").val(t.extension),o=r.properties.thumbnail_size?c.utilities.getThumbnailUrl(t.url,r.properties.thumbnail_size):o.displaySrc,l.find("img").attr("src",o),l.removeClass("uploading")):(o=_("contentblocks.upload_error",{file:i.files[0].filename,message:i.result.message}),1572864<i.files[0].size&&(o+=_("contentblocks.upload_error.file_too_big")),c.alert(o),l.remove()),setTimeout(function(){c.fixColumnHeights()},150)},fail:function(e,i){var t=_("contentblocks.upload_error",{file:i.files[0].filename,message:i.result.message});1572864<i.files[0].size&&(t+=_("contentblocks.upload_error.file_too_big")),c.alert(t),d(i.domId).remove(),c.fixColumnHeights()},formData:function(){return[{name:"HTTP_MODAUTH",value:MODx.siteId},{name:"resource",value:MODx.request.id||0},{name:"field",value:r.id}]},progress:function(e,i){var t=parseInt(i.loaded/i.total*100,10)+"%";d(i.domId).find(".upload-progress .bar").width(t)}}).on("fileuploaddragover",function(){d(this).css("background","red")})},getData:function(){var o=[];return a.find(".gallery-image-holder li").each(function(e,i){var t=d(i),i=t.find("input[id].linkfield"),t={url:t.find(".url").val(),title:t.find(".title").val(),description:t.find(".description").val(),link:i.val(),linkType:c.getLinkFieldDataType(i.val()),size:t.find(".size").val(),width:t.find(".width").val(),height:t.find(".height").val(),extension:t.find(".extension").val()};o.push(t)}),{images:o}}};return s}}(vcJquery,ContentBlocks);
//# sourceMappingURL=gallery-min.js.map