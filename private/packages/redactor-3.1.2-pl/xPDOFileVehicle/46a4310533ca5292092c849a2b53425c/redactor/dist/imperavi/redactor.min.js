var CodeMirror,jQuery;void 0===CodeMirror&&(CodeMirror=void 0),void 0===jQuery&&(jQuery=void 0),function(){var i={settings:{},post:function(t){return new s("post",t)},get:function(t){return new s("get",t)},request:function(t,e){return new s(t,e)}},s=function(t,e){this.p=this.extend({method:t,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}},e),this.p=this.extend(this.p,i.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};s.prototype={extend:function(t,e){if(e)for(var i in e)t[i]=e[i];return t},prepareData:function(){-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method&&(this.p.url=this.p.data?this.p.url+"?"+this.p.data:this.p.url)},setHeaders:function(){for(var t in this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),this.p.headers)this.xhr.setRequestHeader(t,this.p.headers[t])},isFormData:function(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete:function(){return!(this.xhr.status<200||300<=this.xhr.status&&304!==this.xhr.status)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){var t;this.isComplete()?(t=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(t,this.xhr)):(t=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse:function(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson:function(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(t){}return!1},toParams:function(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}};function c(t,e){return this.parse(t,e)}var n=[0],o="data"+(new Date).getTime(),r="is-hidden",a="is-hidden-mobile";c.ready=function(t){"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)},c.prototype={get sdom(){return!0},get length(){return this.nodes.length},parse:function(t,e){var i;if(t){if(t.sdom)return this.nodes=t.nodes,t;i="string"!=typeof t?t.nodeType&&11===t.nodeType?t.childNodes:t.nodeType||t===window?[t]:t:/^\s*<(\w+|!)[^>]*>/.test(t)?this.create(t):this._query(t,e)}else i=[];this.nodes=this._slice(i)},create:function(t){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(t))return[document.createElement(RegExp.$1)];var e=[],i=document.createElement("div"),s=i.childNodes;i.innerHTML=t;for(var n=0,o=s.length;n<o;n++)e.push(s[n]);return e},add:function(t){this.nodes=this.nodes.concat(this._toArray(t))},get:function(t){return this.nodes[t||0]||!1},getAll:function(){return this.nodes},eq:function(t){return new c(this.nodes[t])},first:function(){return new c(this.nodes[0])},last:function(){return new c(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(t){for(var e=this.nodes.length,i=0;i<e;i++)t.call(this,this.nodes[i].sdom?this.nodes[i].get():this.nodes[i],i);return this},is:function(t){return 0<this.filter(t).length},filter:function(e){return void 0===e?this:new c(this.nodes.filter("function"==typeof e?e:function(t){return e instanceof Node?e===t:e&&e.sdom?-1!==e.nodes.indexOf(t):(t.matches=t.matches||t.msMatchesSelector||t.webkitMatchesSelector,1===t.nodeType&&t.matches(e||"*"))}))},not:function(e){return this.filter(function(t){return!new c(t).is(e||!0)})},find:function(s){var n=[];return this.each(function(t){for(var e=this._query(s||"*",t),i=0;i<e.length;i++)n.push(e[i])}),new c(n)},children:function(t){var s=[];return this.each(function(t){if(t.children)for(var e=t.children,i=0;i<e.length;i++)s.push(e[i])}),new c(s).filter(t)},parent:function(t){var e=[];return this.each(function(t){t.parentNode&&e.push(t.parentNode)}),new c(e).filter(t)},parents:function(i,s){s=this._getContext(s);var n=[];return this.each(function(t){for(var e=t.parentNode;e&&e!==s;)i&&!new c(e).is(i)||n.push(e),e=e.parentNode}),new c(n)},closest:function(e,i){i=this._getContext(i),e=e.sdom?e.get():e;var s=[],n=e&&e.nodeType;return this.each(function(t){do{if(n&&t===e||new c(t).is(e))return s.push(t)}while((t=t.parentNode)&&t!==i)}),new c(s)},next:function(t){return this._getSibling(t,"nextSibling")},nextElement:function(t){return this._getSibling(t,"nextElementSibling")},prev:function(t){return this._getSibling(t,"previousSibling")},prevElement:function(t){return this._getSibling(t,"previousElementSibling")},css:function(s,n){if(void 0!==n||"object"==typeof s)return this.each(function(t){var e,i={};for(e in"object"==typeof s?i=s:i[s]=n,i)t.style&&(t.style[e]=i[e])});var t=this.get();return"width"===s||"height"===s?t.style?this._getHeightOrWidth(s,t,!1)+"px":void 0:t.style?getComputedStyle(t,null)[s]:void 0},attr:function(s,n,o){if(o=o?"data-":"",void 0!==n||"object"==typeof s)return this.each(function(t){var e,i={};for(e in"object"==typeof s?i=s:i[s]=n,i)3!==t.nodeType&&("checked"===e?t.checked=i[e]:t.setAttribute(o+e,i[e]))});var t=this.get();return t&&3!==t.nodeType?"checked"===s?t.checked:this._getBooleanFromStr(t.getAttribute(o+s)):void 0},data:function(t,e){if(void 0!==t)return this.attr(t,e,!0);function i(t){return t[1].toUpperCase()}var s,n,o,r=/^data-(.+)$/,a=this.get().attributes,l={};for(s in a)a[s]&&r.test(a[s].nodeName)&&(n=a[s].nodeName.match(r)[1],o=a[s].value,n=n.replace(/-([a-z])/g,i),o=this._isObjectString(o)?this._toObject(o):this._isNumber(o)?parseFloat(o):this._getBooleanFromStr(o),l[n]=o);return l},val:function(e){if(void 0!==e)return this.each(function(t){t.value=e});var t=this.get();return t.type&&"checkbox"===t.type?t.checked:t.value},removeAttr:function(t){return this.each(function(e){t.split(" ").forEach(function(t){3!==e.nodeType&&e.removeAttribute(t)})})},removeData:function(t){return this.each(function(e){t.split(" ").forEach(function(t){3!==e.nodeType&&e.removeAttribute("data-"+t)})})},dataset:function(e,i){return this.each(function(t){n[this.dataindex(t)][e]=i})},dataget:function(t){return n[this.dataindex(this.get())][t]},dataindex:function(t){var e=t[o],i=n.length;return e||(e=t[o]=i,n[e]={}),e},addClass:function(t){return this._eachClass(t,"add")},removeClass:function(t){return this._eachClass(t,"remove")},toggleClass:function(t){return this._eachClass(t,"toggle")},hasClass:function(e){return this.nodes.some(function(t){return!!t.classList&&t.classList.contains(e)})},empty:function(){return this.each(function(t){t.innerHTML=""})},html:function(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)},text:function(e){return void 0===e?this.get().textContent||"":this.each(function(t){t.textContent=e})},after:function(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("afterend",t);else if(null!==e.parentNode)for(var i=t instanceof Node?[t]:this._toArray(t).reverse(),s=0;s<i.length;s++)e.parentNode.insertBefore(i[s],e.nextSibling);return e})},before:function(t){return this._inject(t,function(t,e){if("string"==typeof t)e.insertAdjacentHTML("beforebegin",t);else for(var i=t instanceof Node?[t]:this._toArray(t),s=0;s<i.length;s++)e.parentNode.insertBefore(i[s],e);return e})},append:function(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("beforeend",t);else for(var i=t instanceof Node?[t]:this._toArray(t),s=0;s<i.length;s++)e.appendChild(i[s]);return e})},prepend:function(t){return this._inject(t,function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("afterbegin",t);else for(var i=t instanceof Node?[t]:this._toArray(t).reverse(),s=0;s<i.length;s++)e.insertBefore(i[s],e.firstChild);return e})},wrap:function(t){return this._inject(t,function(t,e){t="string"==typeof t||"number"==typeof t?this.create(t)[0]:t instanceof Node?t:this._toArray(t)[0];return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),new c(t)})},unwrap:function(){return this.each(function(t){t=new c(t);return t.replaceWith(t.contents())})},replaceWith:function(t){return this._inject(t,function(t,e){for(var i=document.createDocumentFragment(),s="string"==typeof t||"number"==typeof t?this.create(t):t instanceof Node?[t]:this._toArray(t),n=0;n<s.length;n++)i.appendChild(s[n]);t=i.childNodes[0];return e.parentNode&&e.parentNode.replaceChild(i,e),t})},remove:function(){return this.each(function(t){t.parentNode&&t.parentNode.removeChild(t)})},clone:function(i){var s=[];return this.each(function(t){var e=this._clone(t);i&&(e=this._cloneEvents(t,e)),s.push(e)}),new c(s)},show:function(){return this.each(function(t){var e,i,s,n;t.style&&this._hasDisplayNone(t)&&(e=t.getAttribute("domTargetShow"),i=!!t.classList&&t.classList.contains(r),s=!!t.classList&&t.classList.contains(a),i?t.classList.remove(n=r):s?t.classList.remove(n=a):t.style.display=e||"block",n&&t.setAttribute("domTargetHide",n),t.removeAttribute("domTargetShow"))}.bind(this))},hide:function(){return this.each(function(t){var e,i;t.style&&!this._hasDisplayNone(t)&&(e=t.style.display,(i=t.getAttribute("domTargetHide"))===r?t.classList.add(r):i===a?t.classList.add(a):("block"!==e&&t.setAttribute("domTargetShow",e),t.style.display="none"),t.removeAttribute("domTargetHide"))})},scrollTop:function(t){var e=this.get(),i=e===window,s=9===e.nodeType,e=s?document.scrollingElement||document.body.parentNode||document.body||document.documentElement:e;if(void 0===t)return s?void 0!==window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop||document.body.scrollTop||0:i?window.pageYOffset:e.scrollTop;i?window.scrollTo(0,t):e.scrollTop=t},offset:function(){return this._getDim("Offset")},position:function(){return this._getDim("Position")},width:function(t,e){return this._getSize("width","Width",t,e)},height:function(t,e){return this._getSize("height","Height",t,e)},outerWidth:function(){return this._getInnerOrOuter("width","outer")},outerHeight:function(){return this._getInnerOrOuter("height","outer")},innerWidth:function(){return this._getInnerOrOuter("width","inner")},innerHeight:function(){return this._getInnerOrOuter("height","inner")},click:function(){return this._triggerEvent("click")},focus:function(){return this._triggerEvent("focus")},trigger:function(n){return this.each(function(t){for(var e=n.split(" "),i=0;i<e.length;i++){var s;try{s=new window.CustomEvent(e[i],{bubbles:!0,cancelable:!0})}catch(t){(s=document.createEvent("CustomEvent")).initCustomEvent(e[i],!0,!0)}t.dispatchEvent(s)}})},on:function(o,r,a){return this.each(function(t){for(var e=o.split(" "),i=0;i<e.length;i++){var s=this._getEventName(e[i]),n=this._getEventNamespace(e[i]);r=a?this._getOneHandler(r,o):r,t.addEventListener(s,r),t._e=t._e||{},t._e[n]=t._e[n]||{},t._e[n][s]=t._e[n][s]||[],t._e[n][s].push(r)}})},one:function(t,e){return this.on(t,e,!0)},off:function(o,r){function a(t,e,i){return t===i}function l(t,e,i,s){return e===s}function h(t,e,i,s){return t===i&&e===s}function e(){return!0}return void 0===o?this.each(function(t){this._offEvent(t,!1,!1,r,e)}):this.each(function(t){for(var e=o.split(" "),i=0;i<e.length;i++){var s=this._getEventName(e[i]),n=this._getEventNamespace(e[i]);"_events"===n?this._offEvent(t,s,n,r,a):s||"_events"===n?this._offEvent(t,s,n,r,h):this._offEvent(t,s,n,r,l)}})},serialize:function(t){for(var e={},i=this.get().elements,s=0;s<i.length;s++){var n=i[s];if((!/(checkbox|radio)/.test(n.type)||n.checked)&&(n.name&&!n.disabled&&"file"!==n.type)){if("select-multiple"===n.type)for(var o=0;o<n.options.length;o++){var r=n.options[o];r.selected&&(e[n.name]=r.value)}e[n.name]=this._isNumber(n.value)?parseFloat(n.value):this._getBooleanFromStr(n.value)}}return t?e:this._toParams(e)},ajax:function(t,e){if(void 0!==s){var i=this.attr("method")||"post",e={url:this.attr("action"),data:this.serialize(),success:t,error:e};return new s(i,e)}},_queryContext:function(t,e){return 3!==(e=this._getContext(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]},_query:function(t,e){if(e)return this._queryContext(t,e);if(/^[.#]?[\w-]*$/.test(t)){if("#"!==t[0])return"."===t[0]?document.getElementsByClassName(t.slice(1)):document.getElementsByTagName(t);e=document.getElementById(t.slice(1));return e?[e]:[]}return document.querySelectorAll(t)},_getContext:function(t){return(t="string"==typeof t?document.querySelector(t):t)&&t.sdom?t.get():t||document},_inject:function(t,e){for(var i=this.nodes.length,s=[];i--;){var n="function"==typeof t?t.call(this,this.nodes[i]):t,n=0===i?n:this._clone(n),n=e.call(this,n,this.nodes[i]);n&&(n.sdom?s.push(n.get()):s.push(n))}return new c(s)},_cloneEvents:function(t,e){var i=t._e;if(i)for(var s in(e._e=i)._events)for(var n=0;n<i._events[s].length;n++)e.addEventListener(s,i._events[s][n]);return e},_clone:function(t){if(void 0!==t)return"string"==typeof t?t:t instanceof Node||t.nodeType?t.cloneNode(!0):"length"in t?[].map.call(this._toArray(t),function(t){return t.cloneNode(!0)}):void 0},_slice:function(t){return t&&0!==t.length?t.length?[].slice.call(t.nodes||t):[t]:[]},_eachClass:function(t,i){return this.each(function(e){t&&t.split(" ").forEach(function(t){e.classList&&e.classList[i](t)})})},_triggerEvent:function(t){var e=this.get();return e&&3!==e.nodeType&&e[t](),this},_getOneHandler:function(t,e){var i=this;return function(){t.apply(this,arguments),i.off(e)}},_getEventNamespace:function(t){var e=t.split("."),t=e[1]||"_events";return e[2]?t+e[2]:t},_getEventName:function(t){return t.split(".")[0]},_offEvent:function(t,e,i,s,n){for(var o in t._e)for(var r in t._e[o])if(n(r,o,e,i))for(var a=t._e[o][r],l=0;l<a.length;l++)void 0!==s&&a[l].toString()!==s.toString()||(t.removeEventListener(r,a[l]),t._e[o][r].splice(l,1),0===t._e[o][r].length&&delete t._e[o][r],0===Object.keys(t._e[o]).length&&delete t._e[o])},_getInnerOrOuter:function(t,e){return this[t](void 0,e)},_getDocSize:function(t,e){var i=t.body,t=t.documentElement;return Math.max(i["scroll"+e],i["offset"+e],t["client"+e],t["scroll"+e],t["offset"+e])},_getSize:function(e,t,i,s){if(void 0!==i)return this.each(function(t){i=parseFloat(i),i+=this._adjustResultHeightOrWidth(e,t,s||"normal"),new c(t).css(e,i+"px")}.bind(this));var n=this.get();return i=3===n.nodeType?0:9===n.nodeType?this._getDocSize(n,t):n===window?window["inner"+t]:this._getHeightOrWidth(e,n,s||"normal"),Math.round(i)},_getHeightOrWidth:function(t,e,i){if(!e)return 0;var s,n,o=t.charAt(0).toUpperCase()+t.slice(1),r=0,a=getComputedStyle(e,null),l=new c(e),h=l.parents().filter(function(t){return 1===t.nodeType&&"none"===getComputedStyle(t,null).display&&t});return"none"===a.display&&h.add(e),0!==h.length?(s="visibility: hidden !important; display: block !important;",n=[],h.each(function(t){var e=new c(t),t=e.attr("style");null!==t&&n.push(t),e.attr("style",null!==t?t+";"+s:s)}),r=l.get()["offset"+o]-this._adjustResultHeightOrWidth(t,e,i),h.each(function(t,e){t=new c(t);void 0===n[e]?t.removeAttr("style"):t.attr("style",n[e])})):r=e["offset"+o]-this._adjustResultHeightOrWidth(t,e,i),r},_adjustResultHeightOrWidth:function(t,e,i){if(!e||!1===i)return 0;var s=0,n=getComputedStyle(e,null),e="border-box"===n.boxSizing;return"height"===t?(("inner"===i||"normal"===i&&e)&&(s+=(parseFloat(n.borderTopWidth)||0)+(parseFloat(n.borderBottomWidth)||0)),"outer"===i&&(s-=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0))):(("inner"===i||"normal"===i&&e)&&(s+=(parseFloat(n.borderLeftWidth)||0)+(parseFloat(n.borderRightWidth)||0)),"outer"===i&&(s-=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0))),s},_getDim:function(t){var e=this.get();return 3===e.nodeType?{top:0,left:0}:this["_get"+t](e)},_getPosition:function(t){return{top:t.offsetTop,left:t.offsetLeft}},_getOffset:function(t){var e=t.getBoundingClientRect(),i=t.ownerDocument,t=i.documentElement,i=i.defaultView;return{top:e.top+i.pageYOffset-t.clientTop,left:e.left+i.pageXOffset-t.clientLeft}},_getSibling:function(e,i){var s,n=(e=e&&e.sdom?e.get():e)&&e.nodeType;return this.each(function(t){for(;t=t[i];)if(n&&t===e||new c(t).is(e))return void(s=t)}),new c(s)},_toArray:function(t){if(t instanceof NodeList){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e}return void 0===t?[]:t.sdom?t.nodes:t},_toParams:function(t){var e,i="";for(e in t)i+="&"+this._encodeUri(e)+"="+this._encodeUri(t[e]);return i.replace(/^&/,"")},_toObject:function(t){return new Function("return "+t)()},_encodeUri:function(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_isNumber:function(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_isObjectString:function(t){return-1!==t.search(/^{/)},_getBooleanFromStr:function(t){return"true"===t||"false"!==t&&t},_hasDisplayNone:function(t){return"none"===t.style.display||"none"===(t.currentStyle||getComputedStyle(t,null)).display}};function m(t,e){return l(t,e,[].slice.call(arguments,2))}var u=0;m.app=[],m.version="3.5.2",m.options={},m.modules={},m.services={},m.classes={},m.plugins={},m.mixins={},m.modals={},m.lang={},m.dom=function(t,e){return new c(t,e)},m.ajax=i,m.Dom=c,m.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},m.env={plugin:"plugins",module:"modules",service:"services",class:"classes",mixin:"mixins"},void 0!==jQuery&&(jQuery.fn.redactor=function(t){return l(this.toArray(),t,[].slice.call(arguments,1))});var l=function(t,e,i){for(var s="redactor",n=Array.isArray(t)?t:t&&t.nodeType?[t]:document.querySelectorAll(t),o="string"==typeof e||"function"==typeof e,r=[],a=0;a<n.length;a++){var l,h,c=n[a],d=m.dom(c);(h=d.dataget(s))||o||(h=new p(c,e,u),d.dataset(s,h),m.app[u]=h,u++),h&&o&&(void 0!==(c="function"==typeof(e=(l="destroy"===e)?"stop":e)?e.apply(h,i):(i.unshift(e),h.api.apply(h,i)))&&r.push(c),l&&d.dataset(s,!1))}return 0===r.length||1===r.length?0===r.length?h:r[0]:r};m.add=function(t,e,i){if(void 0!==m.env[t])if(i.translations&&(m.lang=m.extend(!0,{},m.lang,i.translations)),i.modals&&(m.modals=m.extend(!0,{},m.modals,i.modals)),"mixin"===t)m[m.env[t]][e]=i;else{function s(){}if((s.prototype=i).mixins)for(var n=0;n<i.mixins.length;n++)m.inherit(s,m.mixins[i.mixins[n]]);m[m.env[t]][e]=s}},m.addLang=function(t,e){void 0===m.lang[t]&&(m.lang[t]={}),m.lang[t]=m.extend(m.lang[t],e)},m.create=function(t){var e=t.split("."),i=[].slice.call(arguments,1),s="classes";void 0!==m.env[e[0]]&&(s=m.env[e[0]],t=e.slice(1).join("."));s=new m[s][t];if(s.init){i=s.init.apply(s,i);return i||s}return s},m.inherit=function(t,e){function i(){}i.prototype=e;var s,n=new i;for(s in t.prototype)t.prototype.__lookupGetter__(s)?n.__defineGetter__(s,t.prototype.__lookupGetter__(s)):n[s]=t.prototype[s];return t.prototype=n,t.prototype.super=e,t},m.error=function(t){throw t},m.extend=function(){var i={},s=!1,t=0,e=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(s=arguments[0],t++);for(;t<e;t++)!function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s&&"[object Object]"===Object.prototype.toString.call(t[e])?i[e]=m.extend(!0,i[e],t[e]):i[e]=t[e])}(arguments[t]);return i},m.opts={animation:!0,lang:"en",direction:"ltr",spellcheck:!0,structure:!1,scrollTarget:!1,styles:!0,stylesClass:"redactor-styles",placeholder:!1,source:!0,showSource:!1,inline:!1,breakline:!1,markup:"p",enterKey:!0,clickToEdit:!1,clickToSave:!1,clickToCancel:!1,focus:!1,focusEnd:!1,minHeight:!1,maxHeight:!1,maxWidth:!1,plugins:[],callbacks:{},preClass:!1,preSpaces:4,tabindex:!1,tabAsSpaces:!1,tabKey:!0,autosave:!1,autosaveName:!1,autosaveData:!1,autosaveMethod:"post",toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarContext:!0,air:!1,formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,formattingHide:!1,buttons:["html","format","bold","italic","deleted","lists","image","file","link"],buttonsTextLabeled:!1,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:!1,buttonsAddBefore:!1,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:!1,imageUploadParam:"file",imageData:!1,imageEditable:!0,imageCaption:!0,imageLink:!0,imagePosition:!1,imageResizable:!1,imageFloatMargin:"10px",imageFigure:!0,imageObserve:!0,imageSrcData:!1,fileUpload:!1,fileUploadParam:"file",fileData:!1,fileAttachment:!1,uploadData:!1,dragUpload:!0,multipleUpload:!0,clipboardUpload:!0,uploadBase64:!1,linkTarget:!1,linkTitle:!1,linkNewTab:!0,linkNofollow:!1,linkSize:30,linkValidation:!0,cleanOnEnter:!0,cleanInlineOnEnter:!1,paragraphize:!0,removeScript:!0,removeNewLines:!1,removeComments:!0,replaceTags:{b:"strong",i:"em",strike:"del"},pastePlainText:!1,pasteLinkTarget:!1,pasteImages:!0,pasteLinks:!0,pasteClean:!0,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:["td","th"],pasteBlockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","figure","figcaption"],pasteInlineTags:["a","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"],activeButtons:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",u:"underline"},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:!0,autoparseStart:!0,autoparsePaste:!0,autoparseLinks:!0,autoparseImages:!0,autoparseVideo:!0,autoparseHttps:!1,shortcodes:{"p.":{format:"p"},"quote.":{format:"blockquote"},"pre.":{format:"pre"},"h1.":{format:"h1"},"h2.":{format:"h2"},"h3.":{format:"h3"},"h4.":{format:"h4"},"h5.":{format:"h5"},"h6.":{format:"h6"},"*.":{format:"ul"}},shortcodesAdd:!1,shortcuts:{"ctrl+shift+m, meta+shift+m":{api:"module.inline.clearformat"},"ctrl+b, meta+b":{api:"module.inline.format",args:"b"},"ctrl+i, meta+i":{api:"module.inline.format",args:"i"},"ctrl+u, meta+u":{api:"module.inline.format",args:"u"},"ctrl+h, meta+h":{api:"module.inline.format",args:"sup"},"ctrl+l, meta+l":{api:"module.inline.format",args:"sub"},"ctrl+k, meta+k":{api:"module.link.open"},"ctrl+alt+0, meta+alt+0":{api:"module.block.format",args:"p"},"ctrl+alt+1, meta+alt+1":{api:"module.block.format",args:"h1"},"ctrl+alt+2, meta+alt+2":{api:"module.block.format",args:"h2"},"ctrl+alt+3, meta+alt+3":{api:"module.block.format",args:"h3"},"ctrl+alt+4, meta+alt+4":{api:"module.block.format",args:"h4"},"ctrl+alt+5, meta+alt+5":{api:"module.block.format",args:"h5"},"ctrl+alt+6, meta+alt+6":{api:"module.block.format",args:"h6"},"ctrl+shift+7, meta+shift+7":{api:"module.list.toggle",args:"ol"},"ctrl+shift+8, meta+shift+8":{api:"module.list.toggle",args:"ul"}},shortcutsAdd:!1,grammarly:!0,notranslate:!1,bufferLimit:100,emptyHtml:"<p></p>",markerChar:"\ufeff",imageTypes:["image/png","image/jpeg","image/gif"],imageAttrs:["alt","title","src","class","width","height","srcset"],inlineTags:["a","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],blockTags:["pre","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","section","header","footer","aside","article","iframe"],regex:{youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&//=]*)/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim},input:!0,zindex:!1,modes:{inline:{pastePlainText:!0,pasteImages:!1,enterKey:!1,toolbar:!1,autoparse:!1,source:!1,showSource:!1,styles:!1,air:!1},original:{styles:!1}}},m.lang.en={format:"Format",image:"Image",file:"File",link:"Link",bold:"Bold",italic:"Italic",deleted:"Strikethrough",underline:"Underline",superscript:"Superscript",subscript:"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub",lists:"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab",unlink:"Unlink",cancel:"Cancel",close:"Close",insert:"Insert",save:"Save",delete:"Delete",text:"Text",edit:"Edit",title:"Alt",paragraph:"Normal text",quote:"Quote",code:"Code",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",heading6:"Heading 6",filename:"Name",optional:"optional",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",horizontalrule:"Line",upload:"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor",caption:"Caption",bulletslist:"Bullets",numberslist:"Numbers","image-position":"Position",none:"None",left:"Left",right:"Right",center:"Center",undo:"Undo",redo:"Redo"},m.buttons={html:{title:"HTML",icon:!0,api:"module.source.toggle"},undo:{title:"## undo ##",icon:!0,api:"module.buffer.undo"},redo:{title:"## redo ##",icon:!0,api:"module.buffer.redo"},format:{title:"## format ##",icon:!0,dropdown:{p:{title:"## paragraph ##",api:"module.block.format",args:{tag:"p"}},blockquote:{title:"## quote ##",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:"## code ##",api:"module.block.format",args:{tag:"pre"}},h1:{title:"## heading1 ##",api:"module.block.format",args:{tag:"h1"}},h2:{title:"## heading2 ##",api:"module.block.format",args:{tag:"h2"}},h3:{title:"## heading3 ##",api:"module.block.format",args:{tag:"h3"}},h4:{title:"## heading4 ##",api:"module.block.format",args:{tag:"h4"}},h5:{title:"## heading5 ##",api:"module.block.format",args:{tag:"h5"}},h6:{title:"## heading6 ##",api:"module.block.format",args:{tag:"h6"}}}},bold:{title:"## bold-abbr ##",icon:!0,tooltip:"## bold ##",api:"module.inline.format",args:{tag:"b"}},italic:{title:"## italic-abbr ##",icon:!0,tooltip:"## italic ##",api:"module.inline.format",args:{tag:"i"}},deleted:{title:"## deleted-abbr ##",icon:!0,tooltip:"## deleted ##",api:"module.inline.format",args:{tag:"del"}},underline:{title:"## underline-abbr ##",icon:!0,tooltip:"## underline ##",api:"module.inline.format",args:{tag:"u"}},sup:{title:"## superscript-abbr ##",icon:!0,tooltip:"## superscript ##",api:"module.inline.format",args:{tag:"sup"}},sub:{title:"## subscript-abbr ##",icon:!0,tooltip:"## subscript ##",api:"module.inline.format",args:{tag:"sub"}},lists:{title:"## lists ##",icon:!0,observe:"list",dropdown:{observe:"list",unorderedlist:{title:"&bull; ## unorderedlist ##",api:"module.list.toggle",args:"ul"},orderedlist:{title:"1. ## orderedlist ##",api:"module.list.toggle",args:"ol"},outdent:{title:"< ## outdent ##",api:"module.list.outdent"},indent:{title:"> ## indent ##",api:"module.list.indent"}}},ul:{title:"&bull; ## bulletslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ul"},ol:{title:"1. ## numberslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ol"},outdent:{title:"## outdent ##",icon:!0,api:"module.list.outdent",observe:"list"},indent:{title:"## indent ##",icon:!0,api:"module.list.indent",observe:"list"},image:{title:"## image ##",icon:!0,api:"module.image.open"},file:{title:"## file ##",icon:!0,api:"module.file.open"},link:{title:"## link ##",icon:!0,observe:"link",dropdown:{observe:"link",link:{title:"## link-insert ##",api:"module.link.open"},unlink:{title:"## unlink ##",api:"module.link.unlink"}}},line:{title:"## horizontalrule ##",icon:!0,api:"module.line.insert"}};var p=function(t,e,i){this.module={},this.plugin={},this.instances={},this.started=!1,this.stopped=!1,this.uuid=i,this.rootElement=t,this.rootOpts=e,this.dragInside=!1,this.dragComponentInside=!1,this.keycodes=m.keycodes,this.namespace="redactor",this.$win=m.dom(window),this.$doc=m.dom(document),this.$body=m.dom("body"),this.editorReadOnly=!1,this.opts=m.create("service.options",e,t),this.lang=m.create("service.lang",this),this.buildServices(),this.buildModules(),this.buildPlugins(),this.start()};p.prototype={start:function(){this.stopped=!1,this.broadcast("start"),this.broadcast("startcode"),this.opts.clickToEdit?this.broadcast("startclicktoedit"):(this.broadcast("enable"),this.opts.showSource&&this.broadcast("startcodeshow"),this.broadcast("enablefocus")),this.broadcast("started"),this.started=!0},stop:function(){this.started=!1,this.stopped=!0,this.broadcast("stop"),this.broadcast("disable"),this.broadcast("stopped")},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var t,e=["options","lang"],i=["uuid","keycodes","opts","lang","$win","$doc","$body"],s=[];for(t in m.services)-1===e.indexOf(t)&&(this[t]=m.create("service."+t,this),s.push(t),i.push(t));for(var n=0;n<s.length;n++)for(var o=s[n],r=0;r<i.length;r++){var a=i[r];o!==a&&(this[o][a]=this[a])}},buildModules:function(){for(var t in m.modules)this.module[t]=m.create("module."+t,this),this.instances[t]=this.module[t]},buildPlugins:function(){for(var t=this.opts.plugins,e=0;e<t.length;e++){var i=t[e];void 0!==m.plugins[i]&&(this.plugin[i]=m.create("plugin."+i,this),this.instances[i]=this.plugin[i])}},isDragInside:function(){return this.dragInside},setDragInside:function(t){this.dragInside=t},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(t){this.dragComponentInside=t},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=!0,this.broadcast("enablereadonly"),this.component.clearActive(),this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=!1,this.broadcast("disablereadonly"),this.toolbar.enableButtons()},callMessageHandler:function(t,e,i){var s,n=e.split(".");return 1===n.length?"function"==typeof t["on"+e]&&(s=t["on"+e].apply(t,i)):(n[0]="on"+n[0],"function"==typeof(n=this.utils.checkProperty(t,n))&&(s=n.apply(t,i))),s},broadcast:function(t){var e,i,s=[].slice.call(arguments,1);for(i in this.instances){var n=this.callMessageHandler(this.instances[i],t,s);void 0!==n&&(e=n)}var o=this.callback.trigger(t,s);return void 0!==e?e:o},on:function(t,e){this.callback.add(t,e)},off:function(t,e){this.callback.remove(t,e)},api:function(t){if((this.isStarted()||"start"===t)&&(!this.isReadOnly()||"disableReadOnly"===t)){this.broadcast("state");var e=[].slice.call(arguments,1),i=t.split("."),s=1===i.length,n="on"===i[0]||"off"===i[0],o=!n&&2===i.length,r="plugin"===i[0],a="module"===i[0];if(s){if("function"==typeof this[i[0]])return this.callInstanceMethod(this,i[0],e)}else{if(n)return"on"===i[0]?this.on(i[1],e[0]):this.off(i[1],e[0]||void 0);if(o){if(this.isInstanceExists(this,i[0]))return this.callInstanceMethod(this[i[0]],i[1],e);m.error(new Error('Service "'+i[0]+'" not found'))}else if(r){if(this.isInstanceExists(this.plugin,i[1]))return this.callInstanceMethod(this.plugin[i[1]],i[2],e);m.error(new Error('Plugin "'+i[1]+'" not found'))}else if(a){if(this.isInstanceExists(this.module,i[1]))return this.callInstanceMethod(this.module[i[1]],i[2],e);m.error(new Error('Module "'+i[1]+'" not found'))}}}},isInstanceExists:function(t,e){return void 0!==t[e]},callInstanceMethod:function(t,e,i){if("function"==typeof t[e])return t[e].apply(t,i)}},m.add("mixin","formatter",{buildArgs:function(t){this.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},this.args.class||this.args.style||this.args.attr||(this.args=!1)},applyArgs:function(t,e){return t=this.args?this[this.type](this.args,!1,t,e):this._clearAll(t,e)},clearClass:function(t,e){this.selection.save();t=e?m.dom(e):this.getElements(t,!0);return t.removeAttr("class"),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},clearStyle:function(t,e){this.selection.save();t=e?m.dom(e):this.getElements(t,!0);return t.removeAttr("style"),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},clearAttr:function(t,e){this.selection.save();t=e?m.dom(e):this.getElements(t,!0);return this._removeAllAttr(t),e=this._unwrapSpanWithoutAttr(t.getAll()),this.selection.restore(),e},set:function(t,e,i,s){!1!==s&&this.selection.save();e=i?m.dom(i):this.getElements(e);return t.class&&(e.removeAttr("class"),e.addClass(t.class)),t.style&&(e.removeAttr("style"),e.css(t.style),e.each(function(t){t=m.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))})),t.attr&&(this._removeAllAttr(e),e.attr(t.attr)),!1!==s&&this.selection.restore(),e.getAll()},toggle:function(t,e,i,s){!1!==s&&this.selection.save();var o,e=i?m.dom(i):this.getElements(e);return t.class&&(e.toggleClass(t.class),e.each(function(t){""===t.className&&t.removeAttribute("class")})),t.style&&(o=t.style,e.each(function(t){var e,i=m.dom(t);for(e in o){var s=o[e],n=i.css(e),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,""),s=this.utils.isRgb(s)?this.utils.rgb2hex(s):s.replace(/"/g,"");n=this.utils.hex2long(n),("string"==typeof(s=this.utils.hex2long(s))?s.toLowerCase():s)===("string"==typeof n?n.toLowerCase():n)?i.css(e,""):i.css(e,s)}this._convertStyleQuotes(i),this.utils.removeEmptyAttr(t,"style")?i.removeAttr("data-redactor-style-cache"):i.attr("data-redactor-style-cache",i.attr("style"))}.bind(this))),t.attr&&(o=t.attr,e.each(function(t){var e,i=m.dom(t);for(e in o)i.attr(e)?i.removeAttr(e):i.attr(e,o[e])})),!1!==s&&this.selection.restore(),e.getAll()},add:function(t,e,i,s){!1!==s&&this.selection.save();var n,e=i?m.dom(i):this.getElements(e);return t.class&&e.addClass(t.class),t.style&&(n=t.style,e.each(function(t){t=m.dom(t);t.css(n),t.attr("data-redactor-style-cache",t.attr("style")),this._convertStyleQuotes(t)}.bind(this))),t.attr&&e.attr(t.attr),!1!==s&&this.selection.restore(),e.getAll()},remove:function(t,e,i,s){!1!==s&&this.selection.save();var n,e=i?m.dom(i):this.getElements(e);return t.class&&(e.removeClass(t.class),e.each(function(t){""===t.className&&t.removeAttribute("class")})),t.style&&(n=t.style,e.each(function(t){var e=m.dom(t);e.css(n,""),this.utils.removeEmptyAttr(t,"style")?e.removeAttr("data-redactor-style-cache"):e.attr("data-redactor-style-cache",e.attr("style"))}.bind(this))),t.attr&&e.removeAttr(t.attr),i=this._unwrapSpanWithoutAttr(e.getAll()),!1!==s&&this.selection.restore(),i},_removeAllAttr:function(t){t.each(function(t){for(var e=t.attributes.length;0<e--;){var i=t.attributes[e],s=i.name;"style"!==s&&"class"!==s&&t.removeAttributeNode(i)}})},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))},_clearAll:function(t,e){!1!==e&&this.selection.save();for(var i=0;i<t.length;i++)for(var s=t[i];0<s.attributes.length;)s.removeAttribute(s.attributes[0].name);return t=this._unwrapSpanWithoutAttr(t),!1!==e&&this.selection.restore(),t},_unwrapSpanWithoutAttr:function(t){for(var e=[],i=0;i<t.length;i++){var s=t[i];s.attributes.length<=0&&3!==s.nodeType&&"SPAN"===s.tagName?m.dom(s).unwrap():e.push(s)}return e}}),m.add("mixin","dom",m.Dom.prototype),m.add("mixin","component",{get cmnt(){return!0}}),m.add("service","options",{init:function(t,e){var i=m.dom(e),i=m.extend({},m.opts,e?i.data():{},m.options);return i=m.extend(!0,i,t)}}),m.add("service","lang",{init:function(t){this.app=t,this.opts=t.opts,this.vars=this._build(this.opts.lang)},rebuild:function(t){this.opts.lang=t,this.vars=this._build(t)},extend:function(t){this.vars=m.extend(this.vars,t)},parse:function(t){if(void 0===t)return"";var e=t.match(/## (.*?) ##/g);if(e)for(var i=0;i<e.length;i++){var s=e[i].replace(/^##\s/g,"").replace(/\s##$/g,"");t=t.replace(e[i],this.get(s))}return t},get:function(t){var e="";return void 0!==this.vars[t]?e=this.vars[t]:"en"!==this.opts.lang&&void 0!==m.lang.en[t]&&(e=m.lang.en[t]),e},_build:function(t){var e=m.lang.en;return e="en"!==t?void 0!==m.lang[t]?m.lang[t]:e:e}}),m.add("service","callback",{init:function(t){this.app=t,this.opts=t.opts,this.callbacks={},this.opts.callbacks&&this._set(this.opts.callbacks,"")},stop:function(){this.callbacks={}},add:function(t,e){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e)},remove:function(t,e){if(void 0===e)delete this.callbacks[t];else{for(var i=0;i<this.callbacks[t].length;i++)this.callbacks[t].splice(i,1);0===Object.keys(this.callbacks[t]).length&&delete this.callbacks[t]}},trigger:function(t,e){t=this._loop(t,e,this.callbacks);return void 0===t&&e&&!1!==e[0]?e[0]:t},_set:function(t,e){for(var i in t){var s=""===e?i:e+"."+i;"object"==typeof t[i]?this._set(t[i],s):(this.callbacks[s]=[],this.callbacks[s].push(t[i]))}},_loop:function(t,e,i){var s,n;for(n in i)if(t===n)for(var o=0;o<i[n].length;o++)s=i[n][o].apply(this.app,e);return s}}),m.add("service","animate",{init:function(t){this.animationOpt=t.opts.animation},start:function(t,e,i,s){var n={duration:!1,iterate:!1,delay:!1,timing:!1,prefix:"redactor-"},n="function"==typeof i?n:m.extend(n,i);return new m.AnimatePlay(t,e,n,s="function"==typeof i?i:s,this.animationOpt)},stop:function(t){this.$el=m.dom(t),this.$el.removeClass("redactor-animated");t=this.$el.attr("redactor-animate-effect");this.$el.removeClass(t),this.$el.removeAttr("redactor-animate-effect");t=this.$el.attr("redactor-animate-hide");t&&this.$el.addClass(t).removeAttr("redactor-animate-hide"),this.$el.off("animationend webkitAnimationEnd")}}),(m.AnimatePlay=function(t,e,i,s,n){return this.hidableEffects=["fadeOut","flipOut","slideUp","zoomOut","slideOutUp","slideOutRight","slideOutLeft"],this.prefixes=["","-webkit-"],this.$el=m.dom(t),this.$body=m.dom("body"),this.callback=s,this.animation=n?e:this.buildAnimationOff(e),this.defaults=i,"slideUp"===this.animation&&this.$el.height(this.$el.height()),this.isInanimate()?this.inanimate():this.animate()}).prototype={buildAnimationOff:function(t){return this.isHidable(t)?"hide":"show"},buildHideClass:function(){return"redactor-animate-hide"},isInanimate:function(){return"show"===this.animation||"hide"===this.animation},isAnimated:function(){return this.$el.hasClass("redactor-animated")},isHidable:function(t){return-1!==this.hidableEffects.indexOf(t)},inanimate:function(){var t;return this.defaults.timing="linear","show"===this.animation?(t=this.buildHideClass(),this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)):(t=this.$el.attr("redactor-animate-hide"),this.$el.addClass(t).removeAttr("redactor-animate-hide")),"function"==typeof this.callback&&this.callback(this),this},animate:function(){var t=this.defaults.delay||0;return setTimeout(function(){var t;this.$body.addClass("no-scroll-x"),this.$el.addClass("redactor-animated"),this.$el.attr("redactor-animate-hide")||(t=this.buildHideClass(),this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)),this.$el.addClass(this.defaults.prefix+this.animation),this.$el.attr("redactor-animate-effect",this.defaults.prefix+this.animation),this.set(this.defaults.duration+"s",this.defaults.iterate,this.defaults.timing),this.complete()}.bind(this),1e3*t),this},set:function(t,e,i){for(var s=this.prefixes.length;s--;)!1===t&&""!==t||this.$el.css(this.prefixes[s]+"animation-duration",t),!1===e&&""!==e||this.$el.css(this.prefixes[s]+"animation-iteration-count",e),!1===i&&""!==i||this.$el.css(this.prefixes[s]+"animation-timing-function",i)},clean:function(){this.$body.removeClass("no-scroll-x"),this.$el.removeClass("redactor-animated"),this.$el.removeClass(this.defaults.prefix+this.animation),this.$el.removeAttr("redactor-animate-effect"),this.set("","","")},complete:function(){this.$el.one("animationend webkitAnimationEnd",function(){var t;this.$el.hasClass(this.defaults.prefix+this.animation)&&this.clean(),this.isHidable(this.animation)&&(t=this.$el.attr("redactor-animate-hide"),this.$el.addClass(t).removeAttr("redactor-animate-hide")),"slideUp"===this.animation&&this.$el.height(""),"function"==typeof this.callback&&this.callback(this.$el)}.bind(this))}},m.add("service","caret",{init:function(t){this.app=t},setStart:function(t){this._setCaret("Start",t)},setEnd:function(t){this._setCaret("End",t)},setBefore:function(t){this._setCaret("Before",t)},setAfter:function(t){this._setCaret("After",t)},isStart:function(t){return this._isStartOrEnd(t,"First")},isEnd:function(t){return this._isStartOrEnd(t,"Last")},setAtEnd:function(t){var e=this.inspector.parse(t).getTag(),i=document.createRange();this._isInPage(t)&&("a"===e?(e=this.utils.createInvisibleChar(),m.dom(t).after(e),i.selectNodeContents(e),i.collapse(!0)):(i.selectNodeContents(t),i.collapse(!1)),this.selection.setRange(i))},setAtStart:function(t){var e=document.createRange(),i=this.inspector.parse(t);this._isInPage(t)&&(e.setStart(t,0),e.collapse(!0),i.isInline()&&(i=this.utils.createInvisibleChar(),e.insertNode(i),e.selectNodeContents(i),e.collapse(!1)),this.selection.setRange(e))},setAtBefore:function(t){var e=this.inspector.parse(t),i=document.createRange();this._isInPage(t)&&(i.setStartBefore(t),i.collapse(!0),e.isInline()&&(e=this.utils.createInvisibleChar(),t.parentNode.insertBefore(e,t),i.selectNodeContents(e),i.collapse(!1)),this.selection.setRange(i))},setAtAfter:function(t){var e=document.createRange();this._isInPage(t)&&(e.setStartAfter(t),e.collapse(!0),t=this.utils.createInvisibleChar(),e.insertNode(t),e.selectNodeContents(t),e.collapse(!1),this.selection.setRange(e))},setAtPrev:function(t){t=t.previousSibling;(t=t&&(3===t.nodeType&&this._isEmptyTextNode(t)?t.previousElementSibling:t))&&this.setEnd(t)},setAtNext:function(t){t=t.nextSibling;(t=t&&(3===t.nodeType&&this._isEmptyTextNode(t)?t.nextElementSibling:t))&&this.setStart(t)},_setCaret:function(t,e){var i=this.inspector.parse(e),e=i.getNode();e&&(this.component.clearActive(),this["_set"+t](e,i,i.getTag()))},_setStart:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtStart(t);if("ul"===i||"ol"===i){t=e.findFirstNode("li");var s=this.utils.getFirstElement(t),n=this.inspector.parse(s);if(s&&n.isComponent())return this.setStart(n.getComponent())}else if("dl"===i)t=e.findFirstNode("dt");else{if("br"===i||"hr"===i)return this.setBefore(t);if("td"===i||"th"===i){var o=e.getFirstElement(t);if(o)return this.setStart(o)}else{if("table"===i||"tr"===i)return this.setStart(e.findFirstNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){o=e.findLastNode("pre, code");return this.editor.focus(),this.setAtStart(o)}if("figure"===i&&e.isComponentType("table")){i=e.getTable(),i=this.inspector.parse(i);return this.setStart(i.findFirstNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}this.editor.focus(),this._setInline(t,"Start")||this.setAtStart(t)},_setEnd:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtEnd(t);if("ul"===i||"ol"===i){t=e.findLastNode("li");var s=this.utils.getLastElement(t),n=this.inspector.parse(s);if(s&&n.isComponent())return this.setEnd(n.getComponent())}else if("dl"===i)t=e.findLastNode("dd");else{if("br"===i||"hr"===i)return this.setAfter(t);if("td"===i||"th"===i){var o=e.getLastElement();if(o)return this.setEnd(o)}else{if("table"===i||"tr"===i)return this.setEnd(e.findLastNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){o=e.findLastNode("pre, code");return this.editor.focus(),this.setAtEnd(o)}if("figure"===i&&e.isComponentType("table")){i=e.getTable(),i=this.inspector.parse(i);return this.setEnd(i.findLastNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}if(this.editor.focus(),!this._setInline(t,"End")){if(this.utils.isEmpty(t))return this.setStart(t);this.setAtEnd(t)}},_setBefore:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtBefore(t):e.isFirstTableCell()?this.setAtPrev(e.getComponent()):"td"===i||"th"===i?this.setAtPrev(t):e.isFirstListItem()?this.setAtPrev(e.getList()):e.isFigcaption()?this.setStart(e.getComponent()):!e.isComponentType("table")&&e.isComponent()?this.setAtPrev(e.getComponent()):e.isBlock()?this.setAtPrev(t):(this.editor.focus(),void this.setAtBefore(t))},_setAfter:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtAfter(t):e.isLastTableCell()?this.setAtNext(e.getComponent()):"td"===i||"th"===i?this.setAtNext(t):e.isFirstListItem()?this.setAtNext(e.getList()):!e.isComponentType("table")&&e.isComponent()?this.setAtNext(e.getComponent()):e.isBlock()?this.setAtNext(t):(this.editor.focus(),void this.setAtAfter(t))},_setInline:function(t,e){t=this._hasInlineChild(t,"Start"===e?"first":"last");if(t)return"Start"===e?this.setStart(t):this.setEnd(t),!0},_isStartOrEnd:function(t,e){var i=this.utils.getNode(t);if(!i)return!1;var s=this.inspector.parse(i);if((i=this._getStartEndNode(i,s,e))&&3!==i.nodeType&&"LI"!==i.tagName){t=3===i.nodeType?i.textContent:i.innerHTML;if(""===(t=this.utils.trimSpaces(t)))return!0}if(!s.isFigcaption()&&s.isComponent()&&!s.isComponentEditable())return!0;s=this.offset.get(i,!0);return!!s&&("First"===e?0===s.start:s.end===this.offset.size(i,!0))},_isInPage:function(t){return!(!t||!t.nodeType)&&(t!==document.body&&document.body.contains(t))},_hasInlineChild:function(t,e){t=this.inspector.parse(t),e="first"===e?t.getFirstNode():t.getLastNode(),t=m.dom(e);if(e&&3!==e.nodeType&&this.inspector.isInlineTag(e.tagName)&&!t.hasClass("redactor-component")&&!t.hasClass("non-editable"))return e},_isEmptyTextNode:function(t){t=t.textContent.trim().replace(/\n/,"");return""===(t=this.utils.removeInvisibleChars(t))},_getStartEndNode:function(t,e,i){return e.isFigcaption()?t=e.getFigcaption():e.isTable()?t=e["find"+i+"Node"]("th, td"):e.isList()?t=e["find"+i+"Node"]("li"):e.isComponentType("code")&&(t=e.findLastNode("pre, code")),t}});var h=function(t){return document.getSelection().containsNode(t,!0)};"containsNode"in Selection.prototype||(h=function(t){var e=document.getSelection(),i=e.anchorNode.parentNode,s=e.focusNode.parentNode,n=e.getRangeAt(0).getBoundingClientRect(),e=t.getBoundingClientRect();return!!m.dom(i).closest(t).length||(!!m.dom(s).closest(t).length||n.top<e.top&&n.height>e.height)}),m.add("service","selection",{init:function(t){this.app=t},is:function(){var t=this.get();if(t){t=t.anchorNode;return 0!==m.dom(t).closest(".redactor-in-"+this.uuid).length||t===this.editor.getElement().get()}return!1},isCollapsed:function(){var t=this.get(),e=this.getRange();return!(!t||!t.isCollapsed)||!(!e||0!==e.toString().length)},isBackwards:function(){var t,e=!1,i=this.get();return i&&!i.isCollapsed&&((t=document.createRange()).setStart(i.anchorNode,i.anchorOffset),t.setEnd(i.focusNode,i.focusOffset),e=t.collapsed,t.detach()),e},isIn:function(t){var e=m.dom(t).get(),t=this.getCurrent();return!(!t||!e)&&e.contains(t)},isText:function(){var t=this.get();if(t){var e=t.anchorNode,t=this.getBlock(e),e=this.getBlocks();if(t&&this.inspector.isTableCellTag(t.tagName)||!1===t&&0===e.length)return!0}return!1},isAll:function(t){var e=this.utils.getNode(t);if(!e)return!1;var i=this.editor.isEditor(e),t=this.inspector.parse(e);if(!t.isFigcaption()&&this.component.isNonEditable(e)&&this.component.isActive(e))return!0;if(i){var s=this.editor.getElement().html().replace(/<p><\/p>$/i,"");if(this.getHtml(!1).length!==s.length)return!1}if(i&&this.editor.isEmpty()||this.isCollapsed())return!1;s=this.offset.get(e,!0),e=this.offset.size(e,!0);return!i&&t.isComponentType("code")&&(e=this.getText().trim().length),!(!s||0!==s.start||s.end!==e)},hasNonEditable:function(){var t=this.getHtml(),t=m.dom("<div>").html(t);return!this.isCollapsed()&&0!==t.find(".non-editable").length},setRange:function(t){var e=window.getSelection();e.removeAllRanges(),e.addRange(t)},setAll:function(t){var e,i,s=this.utils.getNode(t);s&&(i=this.inspector.parse(s),this.component.clearActive(),this.editor.focus(),this.editor.saveScroll(),this.editor.disableNonEditables(),s&&"TABLE"===s.tagName?(e=i.findFirstNode("td, th"),t=i.findLastNode("td, th"),m.dom(e).prepend(this.marker.build("start")),m.dom(t).append(this.marker.build("end")),this.restoreMarkers()):!i.isFigcaption()&&this.component.isNonEditable(s)?this.component.setActive(s):(i.isComponentType("code")&&(s=i.getComponentCodeElement()).focus(),(i=document.createRange()).selectNodeContents(s),this.setRange(i)),this.editor.enableNonEditables(),this.editor.restoreScroll())},get:function(){var t=window.getSelection();return 0<t.rangeCount?t:null},getRange:function(){var t=this.get();return t&&t.getRangeAt(0)?t.getRangeAt(0):null},getTextBeforeCaret:function(t){t=void 0===t?1:t;var e=this.editor.getElement().get(),i=this.getRange(),s=!1;return i&&((i=i.cloneRange()).collapse(!0),i.setStart(e,0),s=i.toString().slice(-t)),s},getTextAfterCaret:function(t){t=void 0===t?1:t;var e,i=this.editor.getElement().get(),s=this.getRange(),n=!1;return s&&((e=s.cloneRange()).selectNodeContents(i),e.setStart(s.endContainer,s.endOffset),n=e.toString().slice(0,t)),n},getPosition:function(){var t,e=this.getRange(),i={top:0,left:0,width:0,height:0};return window.getSelection&&e.getBoundingClientRect&&(t=(e=e.cloneRange()).startOffset-1,e.setStart(e.startContainer,t<0?0:t),i={top:(e=e.getBoundingClientRect()).top,left:e.left,width:e.right-e.left,height:e.bottom-e.top}),i},getCurrent:function(){var t=!1,e=this.get(),i=this.component.getActive();return i?t=i:e&&this.is()&&(t=e.anchorNode!==this.editor.getElement().get()&&e.anchorNode),t},getParent:function(){var t=!1,e=this.getCurrent();return t=e?(e=e.parentNode)!==this.editor.getElement().get()&&e:t},getElement:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(i.isElement()&&i.isInEditor())return e;e=e.parentNode}return!1},getInline:function(t){for(var e=t||this.getCurrent(),i=!1;e;)this._isInlineNode(e)&&(i=e),e=e.parentNode;return i},getInlineFirst:function(t){for(var e=t||this.getCurrent();e;){if(this._isInlineNode(e))return e;e=e.parentNode}return!1},getInlineAll:function(t){for(var e=t||this.getCurrent(),i=[];e;)this._isInlineNode(e)&&i.push(e),e=e.parentNode;return i},getBlock:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(this.inspector.isBlockTag(e.tagName)&&i.isInEditor(e))return e;e=e.parentNode}return!1},getInlinesAllSelected:function(t){if(this.isAll())return[];var e=this.getInlines({all:!0,inside:!0}),i=this.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),s=[];if(""===i)s=e;else if(1<e.length)for(var n=0;n<e.length;n++)this._isTextSelected(e[n],i)&&s.push(e[n]);else 1===e.length&&this._isTextSelected(e[0],i)&&(s=e);return s=t&&t.tags?this._filterNodesByTags(s,t.tags):s},getInlines:function(t){for(var e,i=this.getNodes(),s=[],n=0;n<i.length;n++)if(t&&t.all)for(e=i[n];e;)this._isInlineNode(e)&&!this._isInNodesArray(s,e)&&s.push(e),e=e.parentNode;else(e=this.getInline(i[n]))&&!this._isInNodesArray(s,e)&&s.push(e);return s=t&&t.tags?this._filterNodesByTags(s,t.tags):s,s=t&&t.inside?this._filterInlinesInside(s,t):s},getBlocks:function(t){for(var e=this.getNodes(),i=this.getBlock(),e=0===e.length&&i?[i]:e,s=[],n=0;n<e.length;n++){var o=this.getBlock(e[n]);m.dom(o).hasClass("non-editable")||o&&!this._isInNodesArray(s,o)&&s.push(o)}return s=t&&t.tags?this._filterNodesByTags(s,t.tags):s,s=t&&t.first?this._filterBlocksFirst(s,t):s},getElements:function(t){for(var e=this.getNodes({textnodes:!1}),i=this.getBlock(),e=0===e.length&&i?[i]:e,s=[],n=0;n<e.length;n++)this._isInNodesArray(s,e[n])||s.push(e[n]);return s=t&&t.tags?this._filterNodesByTags(s,t.tags):s},getNodes:function(t){var e,i=[],s=this.component.getActive();return s?i=this._getNodesComponent(s):this.isCollapsed()?i=(e=this.getCurrent())?[e]:[]:this.is()&&!s&&(i=this._getRangeSelectedNodes()),i=this._filterServicesNodes(i),i=this._filterEditor(i),i=t&&t.tags?this._filterNodesByTags(i,t.tags):i,i=t&&t.textnodes?this._filterNodesTexts(i,t):i,i=t&&!t.textnodes?this._filterNodesElements(i):i},getText:function(){var t=this.get();return t?this.utils.removeInvisibleChars(t.toString()):""},getHtml:function(t){var e="",i=this.get();if(i){for(var s=document.createElement("div"),n=i.rangeCount,o=0;o<n;++o)s.appendChild(i.getRangeAt(o).cloneContents());e=s.innerHTML,e=(e=!1!==t?this.cleaner.output(e):e).replace(/<p><\/p>$/i,"")}return e},clear:function(){this.component.clearActive(),this.get().removeAllRanges()},collapseToStart:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToStart()},collapseToEnd:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToEnd()},saveActiveComponent:function(){var t=this.component.getActive();return!!t&&(this.savedComponent=t,!0)},restoreActiveComponent:function(){return!!this.savedComponent&&(this.component.setActive(this.savedComponent),!0)},save:function(){this._clearSaved();var t=this.getElement();!t||-1===["TD","TH","P","DIV","PRE","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE"].indexOf(t.tagName)||""!==t.innerHTML&&"<br>"!==t.innerHTML?this.saveActiveComponent()||(this.saved=this.offset.get()):this.savedElement=t},restore:function(){(this.saved||this.savedComponent||this.savedElement)&&(this.editor.saveScroll(),this.savedElement?this.caret.setStart(this.savedElement):this.restoreActiveComponent()||this.offset.set(this.saved),this._clearSaved(),this.editor.restoreScroll())},saveMarkers:function(){this._clearSaved(),this.saveActiveComponent()||this.marker.insert()},restoreMarkers:function(){this.editor.saveScroll(),this.restoreActiveComponent()||this.marker.restore(),this._clearSaved(),this.editor.restoreScroll()},_getNextNode:function(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null},_getNodesComponent:function(t){var e=this.getCurrent(),e=this.inspector.parse(e);return e.isFigcaption()?[e.getFigcaption()]:[t]},_getRangeSelectedNodes:function(){var t=[],e=this.getRange(),i=e.startContainer,s=e.startContainer,n=e.endContainer,o=this.editor.getElement();if(s===o.get()&&this.isAll())t=this.utils.getChildNodes(o);else if(i===n)t=[i];else{for(;i&&i!==n;)t.push(i=this._getNextNode(i));for(i=e.startContainer;i&&i!==e.commonAncestorContainer;)t.unshift(i),i=i.parentNode}return t},_isInNodesArray:function(t,e){return-1!==t.indexOf(e)},_filterEditor:function(t){for(var e=[],i=0;i<t.length;i++)this.inspector.parse(t[i]).isInEditor()&&e.push(t[i]);return e},_filterServicesNodes:function(t){for(var e=[],i=0;i<t.length;i++){var s=m.dom(t[i]),n=!1;t[i]&&3===t[i].nodeType&&this.utils.isEmpty(t[i])&&(n=!0),(n=s.hasClass("redactor-script-tag")||s.hasClass("redactor-component-caret")||s.hasClass("redactor-selection-marker")||s.hasClass("non-editable")?!0:n)||e.push(t[i])}return e},_filterNodesTexts:function(t,e){for(var i=[],s=0;s<t.length;s++)(3===t[s].nodeType||e.keepbr&&"BR"===t[s].tagName)&&(this.getInline(t[s])&&e&&!1===e.inline||i.push(t[s]));return i},_filterNodesElements:function(t){for(var e=[],i=0;i<t.length;i++)3!==t[i].nodeType&&e.push(t[i]);return e},_filterNodesByTags:function(t,e,i){for(var s,n=[],o=0;o<t.length;o++)i&&3===t[o].nodeType?n.push(t[o]):3!==t[o].nodeType&&(s=t[o].tagName.toLowerCase(),-1!==e.indexOf(s.toLowerCase())&&n.push(t[o]));return n},_filterBlocksFirst:function(t){for(var e=[],i=0;i<t.length;i++){var s=m.dom(t[i]),n=s.parent().get(),s=s.parent().hasClass("redactor-in"),n=n&&("TD"===n.tagName||"TH"===n.tagName);(s||n)&&e.push(t[i])}return e},_filterInlinesInside:function(t){for(var e=[],i=0;i<t.length;i++)h(t[i],!0)&&e.push(t[i]);return e},_isTextSelected:function(t,e){t=9!==t.nodeType?this.utils.removeInvisibleChars(t.textContent):"";return e===t||-1!==t.search(e)||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(t)+"$"))},_isInlineNode:function(t){var e=this.inspector.parse(t);return this.inspector.isInlineTag(t.tagName)&&e.isInEditor()},_clearSaved:function(){this.saved=!1,this.savedComponent=!1,this.savedElement=!1}}),m.add("service","element",{init:function(t){this.app=t,this.rootElement=t.rootElement,this.$element={},this.type="inline"},start:function(){this._build(),this._buildType()},isType:function(t){return t===this.type},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=m.dom(this.rootElement)},_buildType:function(){var t=this.$element.get().tagName;this.type="TEXTAREA"===t?"textarea":this.type,this.type="DIV"===t?"div":this.type,this.type=this.opts.inline?"inline":this.type}}),m.add("service","editor",{init:function(t){this.app=t,this.scrolltop=!1,this.pasting=!1},start:function(){this._build()},focus:function(){this.isFocus()||this._isContenteditableFocus()||(this.saveScroll(),this.$editor.focus(),this.restoreScroll())},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=!0},disablePasting:function(){this.pasting=!1},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop(),this.opts.maxHeight&&(this.scrolltopin=this.$editor.scrollTop())},restoreScroll:function(){!1!==this.scrolltop&&(this._getScrollTarget().scrollTop(this.scrolltop),this.scrolltop=!1),this.scrolltopin&&(this.$editor.scrollTop(this.scrolltopin),this.scrolltopin=!1)},disableNonEditables:function(){this.$noneditables=this.$editor.find("[contenteditable=false]"),this.$noneditables.attr("contenteditable",!0)},enableNonEditables:function(){this.$noneditables&&setTimeout(function(){this.$noneditables.attr("contenteditable",!1)}.bind(this),1)},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var t=this.$editor.contents();return t[t.length-1]},isSourceMode:function(){return this.source.getElement().hasClass("redactor-source-open")},isEditor:function(t){return m.dom(t).get()===this.$editor.get()},isEmpty:function(t){return this.utils.isEmptyHtml(this.$editor.html(),!1,t)},isFocus:function(){var t=m.dom(document.activeElement);return 0!==this.$editor.find(".redactor-component-active").length||0!==t.closest(".redactor-in-"+this.uuid).length},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?"<div>":t.get();this.$editor=m.dom(t)},_getScrollTarget:function(){var t=this.$doc;return t=this.opts.toolbarFixedTarget!==document?m.dom(this.opts.toolbarFixedTarget):this.opts.scrollTarget?m.dom(this.opts.scrollTarget):t},_isContenteditableFocus:function(){var t=this.selection.getBlock();return 0!==(t?m.dom(t).closest("[contenteditable=true]").not(".redactor-in"):[]).length}}),m.add("service","container",{init:function(t){this.app=t},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var t=this.element.isType("inline")?"<span>":"<div>";this.$container=m.dom(t)}}),m.add("service","source",{init:function(t){this.app=t,this.$source={},this.content=""},start:function(){this._build(),this._buildName(),this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr("name")},getStartedContent:function(){return this.content},setCode:function(t){return this.insertion.set(t,!0,!1)},isNameGenerated:function(){return this.name},rebuildStartedContent:function(){this._buildStartedContent()},_build:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?t.get():"<textarea>";this.$source=m.dom(t)},_buildName:function(){var t=this.element.getElement();this.name=t.attr("name"),this.$source.attr("name",this.name||"content-"+this.uuid)},_buildStartedContent:function(){var t=this.element.getElement(),t=this.element.isType("textarea")?t.val():t.html();this.content=t.trim()}}),m.add("service","statusbar",{init:function(t){this.app=t,this.$statusbar={},this.items=[]},start:function(){this.$statusbar=m.dom("<ul>"),this.$statusbar.attr("dir",this.opts.direction)},add:function(t,e){return this.update(t,e)},update:function(t,e){var i;return void 0!==this.items[t]?i=this.items[t]:(i=m.dom("<li>"),this.$statusbar.append(i),this.items[t]=i),i.html(e)},get:function(t){return this.items[t]||!1},remove:function(t){this.items[t]&&(this.items[t].remove(),delete this.items[t])},getItems:function(){return this.items},removeItems:function(){this.items={},this.$statusbar.html("")},getElement:function(){return this.$statusbar}}),m.add("service","toolbar",{init:function(t){this.app=t,this.buttons=[],this.dropdownOpened=!1,this.buttonsObservers={}},start:function(){this.is()&&(this.opts.activeButtons=this.opts.activeButtonsAdd?this._extendActiveButtons():this.opts.activeButtons,this.create())},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=m.dom("<div>"),this.$toolbar=m.dom("<div>")},observe:function(){if(this.is()){var t,e,i;for(i in this.setButtonsInactive(),this.buttonsObservers)e=this.buttonsObservers[i],t=this.getButton(i),this.app.broadcast("button."+e+".observe",t);var s=this.opts.activeButtons,n=this.selection.getInlinesAllSelected(),o=this.selection.getInline(),r=this.selection.getInlineAll();this.selection.isCollapsed()&&(o&&n.push(o),0!==r.length&&(n=n.concat(r)));var a,l=this._inlinesToTags(n);for(a in s)-1!==l.indexOf(a)&&(t=this.getButton(s[a]))&&t.setActive()}},is:function(){return!(!this.opts.toolbar||this.detector.isMobile()&&this.opts.air)},isAir:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-air")},isFixed:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-toolbar-fixed")},isContextBar:function(){return this.$body.find("#redactor-context-toolbar-"+this.uuid).hasClass("open")},isTarget:function(){return this.opts.toolbarFixedTarget!==document},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return m.dom(this.opts.toolbarFixedTarget)},getButton:function(t){t=this._findButton(".re-"+t);return 0!==t.length&&t.dataget("data-button-instance")},getButtons:function(){var e=[];return this._findButtons().each(function(t){t=m.dom(t);e.push(t.dataget("data-button-instance"))}),e},getButtonsKeys:function(){var e=[];return this._findButtons().each(function(t){t=m.dom(t);e.push(t.attr("data-re-name"))}),e},addButton:function(t,e,i,s,n){i=i||"end";var o=m.create("toolbar.button",this.app,t,e);return e.observe&&(this.opts.activeButtonsObservers[t]={observe:e.observe,button:o}),this.is()&&("first"===i?this.$toolbar.prepend(o):"after"===i?s.after(o):"before"===i?s.before(o):(t=this.opts.buttons.indexOf(t),!0!==n&&-1!==t?0===t?this.$toolbar.prepend(o):0<(t=this._findButtons().eq(t-1)).length?t.after(o):this.$toolbar.append(o):this.$toolbar.append(o))),o},addButtonFirst:function(t,e){return this.addButton(t,e,"first")},addButtonAfter:function(t,e,i){t=this.getButton(t);return t?this.addButton(e,i,"after",t):this.addButton(e,i)},addButtonBefore:function(t,e,i){t=this.getButton(t);return t?this.addButton(e,i,"before",t):this.addButton(e,i)},addButtonObserver:function(t,e){this.buttonsObservers[t]=e},setButtons:function(t){this.buttons=t},setDropdown:function(t){this.dropdownOpened=t},setButtonsInactive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setInactive()},setButtonsActive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setActive()},disableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].disable()},enableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].enable()},_findButton:function(t){return this.is()?this.$toolbar.find(t):m.dom()},_findButtons:function(){return this.is()?this.$toolbar.find(".re-button"):m.dom()},_extendActiveButtons:function(){return m.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].tagName.toLowerCase());return e}}),m.add("class","toolbar.button",{mixins:["dom"],init:function(t,e,i){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$body=t.$body,this.toolbar=t.toolbar,this.detector=t.detector,this.obj=i,this.name=e,this.dropdown=!1,this.tooltip=!1,this._init()},isActive:function(){return this.hasClass("redactor-button-active")},isDisabled:function(){return this.hasClass("redactor-button-disabled")},hasIcon:function(){return this.obj.icon&&!this.opts.buttonsTextLabeled},setDropdown:function(t){this.obj.dropdown=t,this.obj.message=!1,this.dropdown=m.create("toolbar.dropdown",this.app,this.name,this.obj.dropdown),this.attr("data-dropdown",!0)},setMessage:function(t,e){this.obj.message=t,this.obj.args=e,this.obj.dropdown=!1},setApi:function(t,e){this.obj.api=t,this.obj.args=e,this.obj.dropdown=!1},setTitle:function(t){this.obj.title=this.lang.parse(t),this.obj.tooltip=this.obj.title,this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip}),this.attr("data-re-icon")||this.html(this.obj.title)},setTooltip:function(t){this.obj.tooltip=this.lang.parse(t),this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip})},setIcon:function(t){this.opts.buttonsTextLabeled||(this.obj.icon=!0,this.$icon=m.dom(t),this.html(""),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon"),this.setTooltip(this.obj.title),this._buildTooltip())},setActive:function(){this.addClass("redactor-button-active")},setInactive:function(){this.removeClass("redactor-button-active")},hideTooltip:function(){this.$body.find(".re-button-tooltip").remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass("redactor-button-disabled")},enable:function(){this.removeClass("redactor-button-disabled")},toggle:function(t){t&&t.preventDefault(),this.isDisabled()||(this.obj.dropdown?this.dropdown.toggle(t):this.obj.api?this.app.api(this.obj.api,this.obj.args,this.name):this.obj.message&&this.app.broadcast(this.obj.message,this.obj.args,this.name),this.hideTooltip())},_init:function(){this._parseTitle(),this._parseTooltip(),this._build(),this._buildCallback(),this._buildAttributes(),this._buildObserver(),this.hasIcon()?(this._buildIcon(),this._buildTooltip()):this.html(this.obj.title)},_parseTooltip:function(){this.obj.tooltip=this.obj.tooltip?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse("<a>"),this.addClass("re-button re-"+this.name),this.attr("data-re-name",this.name),this.dataset("data-button-instance",this),this.obj.dropdown&&this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on("click",this.toggle.bind(this))},_buildAttributes:function(){var t={href:"#",alt:this.obj.tooltip,rel:this.name,role:"button","aria-label":this.obj.tooltip,tabindex:"-1"};this.attr(t)},_buildObserver:function(){void 0!==this.obj.observe&&this.toolbar.addButtonObserver(this.name,this.obj.observe)},_buildIcon:function(){var t=this.obj.icon,e=/(<([^>]+)>)/gi.test(t);this.$icon=m.dom(e?t:"<i>"),e||this.$icon.addClass("re-icon-"+this.name),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon")},_buildTooltip:function(){this.detector.isDesktop()&&(this.tooltip=m.create("toolbar.button.tooltip",this.app,this))}}),m.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(t,e){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$body=t.$body,this.toolbar=t.toolbar,this.$button=e,this.created=!1,this._init()},open:function(){var t,e,i;this.$button.hasClass("redactor-button-disabled")||this.$button.hasClass("redactor-button-active")||(this.created=!0,this.parse("<span>"),this.addClass("re-button-tooltip re-button-tooltip-"+this.uuid),this.$body.append(this),this.html(this.$button.attr("alt")),t=this.$button.offset(),e=this.$button.height(),i=this.$button.width(),this.css({top:t.top+e+4+"px",left:t.left+i/2-this.width()/2+"px",position:"absolute"}),this.show())},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this)),this.$button.on("mouseout",this.close.bind(this))}}),m.add("class","toolbar.dropdown",{mixins:["dom"],init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.animate=t.animate,this.toolbar=t.toolbar,this.name=e,this.started=!1,this.items="format"===e?m.extend({},!0,i):i,this.$items=[]},toggle:function(t){this.started||this._build(),this.isOpened()&&this.isActive()?this.close(!1):this.open(t)},isOpened:function(){var t=this.$body.find(".redactor-dropdown-"+this.uuid+".open");return 0!==t.length&&t.attr("data-re-name")===this.name},isActive:function(){return 0!==this.$body.find("#redactor-dropdown-"+this.uuid+"-"+this.name+".open").length},getName:function(){return this.attr("data-re-name")},getItem:function(t){return this.$items[t]},getItemsByClass:function(t){var e,i=[];for(e in this.$items){var s=this.$items[e];"object"==typeof s&&s.attr("data-re-name")&&s.hasClass(t)&&i.push(s)}return i},open:function(t){this._closeAll(),this.$btn=this.toolbar.getButton(this.name),this.app.broadcast("dropdown.open",t,this,this.$btn),this.toolbar.setDropdown(this),this.show(),this.removeClass("redactor-animate-hide"),this.addClass("open"),this._observe(),this.$btn.hideTooltip(),this.$btn.setActive(),this.$doc.on("keyup.redactor.dropdown-"+this.uuid,this._handleKeyboard.bind(this)),this.$doc.on("click.redactor.dropdown-"+this.uuid,this.close.bind(this)),this.updatePosition(),this.app.broadcast("dropdown.opened",t,this,this.$btn)},close:function(t,e){if(t){var i=m.dom(t.target);if(this._isButton(t)||i.hasClass("redactor-dropdown-not-close")||i.hasClass("redactor-dropdown-item-disabled"))return void t.preventDefault()}this.app.broadcast("dropdown.close",this,this.$btn),this.toolbar.setDropdown(!1),this.$btn.setInactive(),!1===e?this._close():this.animate.start(this,"fadeOut",this._close.bind(this))},updatePosition:function(){this.toolbar.isFixed(),this.toolbar.isTarget();var t=this.$btn.height(),e=this.$btn.width(),i=this.$btn.offset(),s=i.left+0,n=parseFloat(this.css("width")),e=s-(this.$win.width()<s+n?n-e:0),i=i.top+t+2,e=e<0?4:e;this.css({maxHeight:"",position:"absolute",top:i+"px",left:e+"px"});t=this.$win.height(),e=this.$doc.scrollTop();this.css("max-height",t-(i-e)-10+"px")},_build:function(){this.parse("<div>"),this.attr("dir",this.opts.direction),this.attr("id","redactor-dropdown-"+this.uuid+"-"+this.name),this.attr("data-re-name",this.name),this.addClass("redactor-dropdown redactor-dropdown-"+this.uuid+" redactor-dropdown-"+this.name),this.dataset("data-dropdown-instance",this),this.items.sdom||"string"==typeof this.items?this._buildDom():this._buildItems(),this.$body.append(this),this.started=!0},_buildDom:function(){this.html("").append(m.dom(this.items))},_buildItems:function(){for(var t in this.items="format"===this.name?this._buildFormattingItems():this.items,this.items){var e=this.items[t];"observe"===t?this.attr("data-observe",this.items[t]):(e=m.create("toolbar.dropdown.item",this.app,t,e,this),this.$items[t]=e,this.append(e))}},_buildFormattingItems:function(){for(var t in this.items)-1===this.opts.formatting.indexOf(t)&&delete this.items[t];if(this.opts.formattingHide)for(var t in this.items)-1!==this.opts.formattingHide.indexOf(t)&&delete this.items[t];if(this.opts.formattingAdd)for(var t in this.opts.formattingAdd)this.items[t]=this.opts.formattingAdd[t];return this.items},_handleKeyboard:function(t){27===t.which&&this.close()},_isButton:function(t){return m.dom(t.target).closest(".re-button").get()===this.$btn.get()},_close:function(){this.$btn.setInactive(),this.$doc.off(".redactor.dropdown-"+this.uuid),this.removeClass("open"),this.addClass("redactor-animate-hide"),this.app.broadcast("dropdown.closed",this,this.$btn)},_closeAll:function(){this.$body.find(".redactor-dropdown-"+this.uuid+".open").each(function(t){m.dom(t).dataget("data-dropdown-instance")._close()})},_observe:function(){var t=this.attr("data-observe");t&&this.app.broadcast("dropdown."+t+".observe",this)}}),m.add("class","toolbar.dropdown.item",{mixins:["dom"],init:function(t,e,i,s){this.app=t,this.lang=t.lang,this.dropdown=s,this.name=e,this.obj=i,this._init()},setTitle:function(t){this.$span.html(t)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass("redactor-dropdown-item-disabled")},disable:function(){this.addClass("redactor-dropdown-item-disabled")},toggle:function(t){t&&t.preventDefault(),this.hasClass("redactor-dropdown-item-disabled")||(this.obj.message?this.app.broadcast(this.obj.message,this.obj.args,this.name):this.obj.api&&this.app.api(this.obj.api,this.obj.args,this.name))},_init:function(){this.parse("<a>"),this.attr("href","#"),this.addClass("redactor-dropdown-item-"+this.name),this.obj.classname&&this.addClass(this.obj.classname),this.attr("data-re-name",this.name),this.on("click",this.toggle.bind(this)),this.$span=m.dom("<span>"),this.append(this.$span),this.setTitle(this.lang.parse(this.obj.title))}}),m.add("service","cleaner",{init:function(t){this.app=t,this.opts=t.opts,this.storedComponents=[],this.storedComments=[],this.storedImages=[],this.storedLinks=[],this.deniedTags=["font","html","head","link","title","body","meta","applet"],this.convertRules={},this.unconvertRules={},this.reComments=/<!--[\s\S]*?-->\n?/g,this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i,this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(t,e){this.convertRules[t]=e},addUnconvertRules:function(t,e){this.unconvertRules[t]=e},input:function(t,e,i){t=t.replace(/¤t/gi,"&current");var s=[];t=this.storeComments(t,s),t=this.encodeCode(t);var n=this.utils.buildWrapper(t);n.find("a, b, i, strong, em, img, svg, details, audio").removeAttr("onload onerror ontoggle onwheel onmouseover oncopy"),n.find("a, iframe, embed").each(function(t){var e=m.dom(t),i=e.attr("href"),t=e.attr("src");i&&-1!==i.trim().search(/^data|javascript:/i)&&e.attr("href",""),t&&-1!==t.trim().search(/^data|javascript:/i)&&e.attr("src","")});var o=["alt","title","src","class","width","height","srcset","style","usemap"];return n.find("img").each(function(t){if(0<t.attributes.length)for(var e=t.attributes,i=e.length-1;0<=i;i--){var s=-1===e[i].name.search(/^data-/)&&-1===o.indexOf(e[i].name),n="src"===e[i].name&&-1!==e[i].value.search(/^data|javascript:/i);this.opts.imageSrcData&&(n=!1),(s||n)&&t.removeAttribute(e[i].name)}}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(n)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&"),t=m.create("cleaner.figure",this.app).convert(t,this.convertRules),t=this.storeComponents(t),t=this.replaceTags(t,this.opts.replaceTags),t=this._setSpanAttr(t),t=this._setStyleCache(t),t=this.removeTags(t,this.deniedTags),t=this.opts.removeScript?this._removeScriptTag(t):this._replaceScriptTag(t),t=this.opts.removeComments?this.removeComments(t):t,t=this._isSpacedEmpty(t)?this.opts.emptyHtml:t,t=this.restoreComponents(t),t=this._cleanWrapped(t),t=this.restoreComments(t,s),t=e?this.paragraphize(t):t},output:function(t,e){return t=this.removeInvisibleSpaces(t),t=(t=this.opts.breakline?(t=t.replace(/<\/(span|strong|b|i|em)><br\s?\/?><\/div>/gi,"</$1></div>")).replace(/<br\s?\/?><\/(span|strong|b|i|em)><\/div>/gi,"</$1></div>"):t).replace(/&#36;/g,"$"),this._isSpacedEmpty(t)||this._isParagraphEmpty(t)?"":(t=this.removeServiceTagsAndAttrs(t,e),t=this.storeComponents(t),t=this.removeSpanWithoutAttributes(t),t=this.removeFirstBlockBreaklineInHtml(t),t=this.opts.removeScript?t:this._unreplaceScriptTag(t),t=this.opts.preClass?this._setPreClass(t):t,t=this.opts.linkNofollow?this._setLinkNofollow(t):t,t=this.opts.removeNewLines?this.cleanNewLines(t):t,t=this.restoreComponents(t),t=m.create("cleaner.figure",this.app).unconvert(t,this.unconvertRules),t=this.removeEmptyAttributes(t,["style","class","rel","alt","title"]),t=this.cleanSpacesInPre(t),t=(t=this.tidy(t)).replace(/&amp;/g,"&"),t=""===(t=this.opts.breakline?(t=t.replace(/<br\s?\/?>/gi,"<br>\n")).replace(/<br\s?\/?>\n+/gi,"<br>\n"):t).replace(/\n/g,"")?"":t)},paste:function(t){t=(t=this.storeComponents(t)).replace(/<!--[\s\S]*?-->/g,"");var e=this.deniedTags.concat(["iframe"]);t=(t=(t=(t=this.removeTags(t,e)).replace(new RegExp("<!doctype([\\s\\S]+?)>","gi"),"")).replace(new RegExp("<style([\\s\\S]+?)</style>","gi"),"")).replace(new RegExp("</p><br /><p","gi"),"</p><p");var i=this._isHtmlMsWord(t);if(t=i?t:this._cleanGDocs(t),t=i?this._cleanMsWord(t):t,!this.opts.pasteClean)return t=this.restoreComponents(t);if(this.opts.pastePlainText)return t=this.restoreComponents(t),this.pastePlainText(t);var s=this.utils.buildWrapper(t);s.find("*").removeAttr("style"),s.find("[data-redactor-tag]").each(function(t){var e=m.dom(t);e.removeAttr("data-redactor-tag"),(this.utils.isEmptyHtml(e.html())?e.html("<br>"):t.lastChild&&"BR"===t.lastChild.tagName?e:e.append("<br>")).unwrap()}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(s)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>");var n=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);t=this.removeTagsExcept(t,n),t=this.opts.pasteLinks?t:this.removeTags(t,["a"]),t=this.opts.pasteImages?t:this.removeTags(t,["img"]);e=(s=this.utils.buildWrapper(t)).find("*"),n=0!==this.opts.pasteKeepStyle.length?","+this.opts.pasteKeepStyle.join(","):"";e.not("[data-redactor-style-cache]"+n).removeAttr("style");n=0!==this.opts.pasteKeepClass.length?","+this.opts.pasteKeepClass.join(","):"";e.not("[data-redactor-style-cache], span.redactor-component"+n).removeAttr("class");n=0!==this.opts.pasteKeepAttrs.length?","+this.opts.pasteKeepAttrs.join(","):"";e.not("img, a, span.redactor-component, [data-redactor-style-cache]"+n).each(function(t){for(var e=t.attributes,i=e.length-1;0<=i;i--)"class"!==t.attributes[i].name&&"dir"!==t.attributes[i].name&&t.removeAttribute(e[i].name)}),this.opts.pasteLinks&&!1!==this.opts.pasteLinkTarget&&s.find("a").attr("target",this.opts.pasteLinkTarget),s.find("[data-redactor-style-cache]").each(function(t){var e=t.getAttribute("data-redactor-style-cache");t.setAttribute("style",e)});var o=this.opts.imageAttrs;return s.find("img").each(function(t){if(0<t.attributes.length)for(var e=t.attributes,i=e.length-1;0<=i;i--)-1===o.indexOf(e[i].name)&&t.removeAttribute(e[i].name)}),s.find("span").each(function(t){0===t.attributes.length&&m.dom(t).unwrap()}),s.find(this.opts.inlineTags.join(",")).each(function(t){0===t.attributes.length&&this.utils.isEmptyHtml(t.innerHTML)&&m.dom(t).unwrap()}.bind(this)),s.find("ul, ol").each(function(t){var e=t.previousSibling;e&&"LI"===e.tagName&&((e=m.dom(e)).find("p").unwrap(),e.append(t))}),t=(t=(t=(t=(t=this.utils.getWrapperHtml(s)).replace(/<li><p>/gi,"<li>")).replace(/<\/p><\/li>/gi,"</li>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>"),t=(t=(t=this.opts.breakline?t.replace(/\n/g,"<br>"):t).replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>"),i&&(t=(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")).replace(/<td\n/gi,"<td ")),t=this.restoreComponents(t)},pastePlainText:function(t){return t=this.opts.pasteLinks?this.storeLinks(t):t,t=this.opts.pasteImages?this.storeImages(t):t,t=this.getPlainText(t),t=this._replaceNlToBr(t),t=this.opts.pasteLinks?this.restoreLinks(t):t,t=this.opts.pasteImages?this.restoreImages(t):t},tidy:function(t){return t},paragraphize:function(t){return t=m.create("cleaner.paragraphize",this.app).convert(t)},storeComments:function(t,e){var i=t.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null!==i)for(var s=0;s<i.length;s++)t=t.replace(i[s],"#####xstarthtmlcommentzz"+s+"xendhtmlcommentzz#####"),e.push(i[s]);return t},restoreComments:function(t,e){for(var i=0;i<e.length;i++)t=t.replace("#####xstarthtmlcommentzz"+i+"xendhtmlcommentzz#####",e[i]);return t},getFlatText:function(t){var e=m.dom("<div>");return t.nodeType||t.dom?e.append(t):(t=(t=t.toString()).trim(),e.html(t)),void 0===(t=e.get().textContent||e.get().innerText||"")?"":t},getPlainText:function(t){t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<p><\/p>/g,"")).replace(/<\/div>|<\/li>|<\/td>/gi,"\n")).replace(/<\/p>/gi,"\n\n")).replace(/<\/H[1-6]>/gi,"\n\n");var e=document.createElement("div");return e.innerHTML=t,(t=e.textContent||e.innerText).trim()},replaceTags:function(t,e){var i,s,n;return e&&(i=this,s=Object.keys(e),(n=this.utils.buildWrapper(t)).find(s.join(",")).each(function(t){i.utils.replaceToTag(t,e[t.tagName.toLowerCase()])}),t=this.utils.getWrapperHtml(n)),t},replaceNbspToSpaces:function(t){return t.replace("&nbsp;"," ")},replaceBlocksToBr:function(t){return t=(t=(t=t.replace(/<div[^>]*><\/div>/gi,"")).replace(/<td[^>]*><\/td>/gi,"")).replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,"<br>")},cleanNewLines:function(t){return t.replace(/\r?\n/g,"")},cleanSpacesInPre:function(t){return t.replace("&nbsp;&nbsp;&nbsp;&nbsp;","    ")},removeInvisibleSpaces:function(t){return t=(t=this.utils.removeInvisibleChars(t)).replace(/&#65279;/gi,"")},removeNl:function(t){return t=(t=t.replace(/\n/g," ")).replace(/\s+/g,"s")},removeBrAtEnd:function(t){return t=(t=t.replace(/<br\s?\/?>$/gi," ")).replace(/<br\s?\/?><li/gi,"<li")},removeTags:function(t,i){return t.replace(i?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,i?function(t,e){return-1===i.indexOf(e.toLowerCase())?t:""}:"")},removeTagsExcept:function(t,i){if(void 0===i)return t.replace(/(<([^>]+)>)/gi,"");return t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,e){return-1===i.indexOf(e.toLowerCase())?"":t})},removeComments:function(t){return t.replace(this.reComments,"")},removeServiceTagsAndAttrs:function(t,e){var t=this.utils.buildWrapper(t),i=this;return!1!==e&&t.find(".redactor-selection-marker").each(function(t){t=m.dom(t);return""===i.utils.removeInvisibleChars(t.text())?t.remove():t.unwrap()}),t.find("[data-redactor-style-cache]").removeAttr("data-redactor-style-cache"),this.utils.getWrapperHtml(t)},removeSpanWithoutAttributes:function(t){t=this.utils.buildWrapper(t);return t.find("span").removeAttr("data-redactor-span data-redactor-style-cache").each(function(t){0===t.attributes.length&&m.dom(t).unwrap()}),this.utils.getWrapperHtml(t)},removeFirstBlockBreaklineInHtml:function(t){return t.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>")},removeEmptyAttributes:function(t,e){for(var i=this.utils.buildWrapper(t),s=0;s<e.length;s++)i.find("["+e[s]+'=""]').removeAttr(e[s]);return this.utils.getWrapperHtml(i)},encodeHtml:function(t){return t=(t=(t=(t=(t=(t=t.replace(/<br\s?\/?>/g,"\n")).replace(/&nbsp;/g," ")).replace(/”/g,'"')).replace(/“/g,'"')).replace(/‘/g,"'")).replace(/’/g,"'"),t=(t=this.encodeEntities(t)).replace(/\$/g,"&#36;"),t=this.opts.preSpaces?t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):t},encodeCode:function(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)},_encodeCode:function(t){t=this.utils.buildWrapper(t);return t.find("pre code, pre, code").each(this._encodeNode.bind(this)),this.utils.getWrapperHtml(t)},_encodeNode:function(t){var e=t.firstChild,i=t.innerHTML;"PRE"===t.tagName&&e&&"CODE"===e.tagName||(i=(i=i.replace(/xtagstartz/g,"<")).replace(/xtagendz/g,">"),i=this.decodeEntities(i),t.textContent=this._encodeNodeHtml(i))},_encodeNodeHtml:function(t){return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),t=this.opts.preSpaces?t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):t},encodeAttrSings:function(t){var e=t.match(/="(.*?)"/g);if(null!==e)for(var i,s=0;s<e.length;s++)-1===e[s].search(/^"</)&&-1===e[s].search(/>"$/)&&(i=(i=e[s].replace(">","xmoresignz")).replace("<","xlesssignz"),t=t.replace(e[s],i));return t},encodeEntities:function(t){return t=(t=this.decodeEntities(t)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhpCode:function(t){return t=(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;")},decodeAttrSings:function(t){return t=(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<")},decodeEntities:function(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},storeComponents:function(t){var e=this.utils.getElementsFromHtml(t,"figure","table");return this._storeMatched(t,e,"Components","figure")},restoreComponents:function(t){return this._restoreMatched(t,"Components","figure")},storeLinks:function(t){var e=this.utils.getElementsFromHtml(t,"a");return this._storeMatched(t,e,"Links","a")},storeImages:function(t){var e=this.utils.getElementsFromHtml(t,"img");return this._storeMatched(t,e,"Images","img")},restoreLinks:function(t){return this._restoreMatched(t,"Links","a")},restoreImages:function(t){return this._restoreMatched(t,"Images","img")},_cleanWrapped:function(t){return t=t.replace(new RegExp("<p><figure([\\w\\W]*?)</figure></p>","gi"),"<figure$1</figure>")},_cleanGDocs:function(t){return t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?bold|font-weight:\s?bold;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?600|font-weight:\s?600;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?700|font-weight:\s?700;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?bold[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?700[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?600[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")},_cleanMsWord:function(t){t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(t,e){return 0<e.length?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join(" "):""});var e=this.utils.buildWrapper(t);e.find(".MsoFootnoteText").each(function(t){var e=m.dom(t),t=e.parent();0!==t.length&&-1!==t.attr("style").search(/mso-element:footnote/)&&e.find("a").attr("id","_"+t.attr("id"))}),e.find(".MsoFootnoteReference").each(function(t){t=m.dom(t).parent();0!==t.length&&"A"===t.get().tagName&&t.attr("id",t.attr("name"))}),e.find("p").each(function(t){var e=m.dom(t),t=e.attr("style"),t=/mso-list:\w+ \w+([0-9]+)/.exec(t);t&&e.attr("data-listLevel",parseInt(t[1],10))}),this._parseWordLists(e),e.find("[align]").removeAttr("align"),e.find("[name]").removeAttr("name"),e.find("span").each(function(t){var e=m.dom(t),t=e.attr("style");/mso-list:Ignore/.exec(t)?e.remove():e.unwrap()}),e.find("[style]").removeAttr("style"),e.find("[class^='Mso']").removeAttr("class"),e.find("a").filter(function(t){return!t.hasAttribute("href")}).unwrap();for(var i="",s=(t=(t=(t=(t=(t=this.utils.getWrapperHtml(e)).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>·/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),n=0;n<s.length;n++){var o=""!==s[n]&&-1===s[n].search(/>$/)?" ":"\n";i+=s[n]+o}return i},_parseWordLists:function(t){var o,r=0,a=null,l=null;t.find("p").each(function(t){var e=m.dom(t),i=e.attr("data-listLevel");if(null!==(i=null===i&&e.hasClass("MsoListParagraphCxSpMiddle")?1:i)){t=e.text(),t=/^\s*\w+\./.test(t)?"<ol></ol>":"<ul></ul>";if(e.hasClass("MsoListParagraphCxSpFirst")||e.hasClass("MsoNormal")?(l=m.dom(t),e.before(l)):r<i&&0!==r&&(o=m.dom(t),a.append(o),l=o),i<r)for(var s=r-i+1,n=0;n<s;n++)l=l.parent();e.find("span").first().unwrap(),a=m.dom("<li>"+e.html().trim()+"</li>"),null===l&&(e.before(t),l=e.prev()),l.append(a),e.remove(),r=i}else l=null,r=0})},_isSpacedEmpty:function(t){return-1!==t.search(this.reSpacedEmpty)},_isParagraphEmpty:function(t){return-1!==t.search(/^<p><\/p>$/i)},_isHtmlMsWord:function(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(t){t=this.utils.buildWrapper(t);return t.find("span").attr("data-redactor-span",!0),this.utils.getWrapperHtml(t)},_setStyleCache:function(t){t=this.utils.buildWrapper(t);return t.find("[style]").each(function(t){t=m.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))}),this.utils.getWrapperHtml(t)},_setPreClass:function(t){t=this.utils.buildWrapper(t);return t.find("pre").addClass(this.opts.preClass),this.utils.getWrapperHtml(t)},_setLinkNofollow:function(t){t=this.utils.buildWrapper(t);return t.find("a").attr("rel","nofollow"),this.utils.getWrapperHtml(t)},_replaceScriptTag:function(t){return t.replace(this.reScriptTag,'<script class="redactor-script-tag" $1>$2<\/script>')},_unreplaceScriptTag:function(t){return t.replace(/<script class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/script>/gi,"<script$1>$2<\/script>")},_replaceNlToBr:function(t){return t.replace(/\n/g,"<br />")},_removeScriptTag:function(t){return t.replace(this.reScriptTag,"")},_storeMatched:function(t,e,i,s){if(this["stored"+i]=[],e)for(var n=0;n<e.length;n++)this["stored"+i][n]=e[n],t=t.replace(e[n],"####"+s+n+"####");return t},_restoreMatched:function(t,e,i){if(this["stored"+e])for(var s=0;s<this["stored"+e].length;s++)t=t.replace("####"+i+s+"####",this["stored"+e][s]);return t}}),m.add("class","cleaner.figure",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.detector=t.detector},convert:function(t,e){t=this.utils.buildWrapper(t);return t.find("img").each(this._convertImage.bind(this)),t.find("hr").each(this._convertLine.bind(this)),t.find("iframe").each(this._convertIframe.bind(this)),t.find("table").each(this._convertTable.bind(this)),t.find("form").each(this._convertForm.bind(this)),t.find("figure pre").each(this._convertCode.bind(this)),t.find("[data-redactor-type=variable]").addClass("redactor-component"),t.find("figure").not(".redactor-component, .redactor-figure-code").each(this._convertWidget.bind(this)),t.find("figure pre").each(this._setContenteditableCode.bind(this)),t.find(".redactor-component, .non-editable").attr("contenteditable",!1),this.detector.isIe()&&t.find("[data-redactor-type=table]").removeAttr("contenteditable"),t.find("figcaption, td, th").attr("contenteditable",!0),t.find(".redactor-component, figcaption").attr("tabindex","-1"),this._acceptExtraRules(t,e),this.utils.getWrapperHtml(t)},unconvert:function(t,e){t=(t=t.replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")).replace(/<\/([^>]+)><p/g,"</$1>\n<p");var i=this.utils.buildWrapper(t);return i.find("th, td, figcaption, figure, pre, code, .redactor-component").removeAttr("contenteditable tabindex"),i.find("figure").removeClass("redactor-component redactor-component-active redactor-uploaded-figure"),i.find("[data-redactor-type=variable]").removeClass("redactor-component redactor-component-active"),i.find("figure[data-redactor-type=line]").unwrap(),i.find("figure[data-redactor-type=widget]").each(this._unconvertWidget.bind(this)),i.find("figure[data-redactor-type=form]").each(this._unconvertForm.bind(this)),i.find("figure[data-redactor-type=table]").each(this._unconvertTable.bind(this)),i.find("figure[data-redactor-type=image]").removeAttr("rel").each(this._unconvertImages.bind(this)),i.find("img").removeAttr("data-redactor-type").removeClass("redactor-component"),i.find(".non-editable").removeAttr("contenteditable"),i.find("figure").each(this._removeTypes.bind(this)),i.find("span.redactor-component-caret").remove(),i=this._unconvertBreakTag(i),this._acceptExtraRules(i,e),t=(t=(t=this.utils.getWrapperHtml(i)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>")},_convertImage:function(t){var e,i,s=m.dom(t);this._isNonEditable(s)||(this.opts.imageObserve&&!s.attr("data-image")&&s.attr("data-image",this.utils.getRandomId()),e=s.closest("a"),0===(i=s.closest("figure")).children().not("a, img, br, figcaption").length&&(0===i.length?(t=(0!==e.length?e:s).closest("p"),!1===this.opts.imageFigure&&0!==t.length?(i=this.utils.replaceToTag(t,"figure")).addClass("redactor-replace-figure"):(0!==t.length&&t.unwrap(),i=(0!==e.length?e:s).wrap("<figure>"))):i.hasClass("redactor-uploaded-figure")?i.removeClass("redactor-uploaded-figure"):i.addClass("redactor-keep-figure"),this._setFigure(i,"image")))},_convertTable:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"table"))},_convertLine:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"line"))},_convertForm:function(t){this._isNonEditable(t)||(t=this.utils.replaceToTag(t,"figure"),this._setFigure(t,"form"))},_convertIframe:function(t){var e;this._isNonEditable(t)||0===m.dom(t).closest(".redactor-component").length&&(e=(e=t.getAttribute("src"))&&(e.match(this.opts.regex.youtube)||e.match(this.opts.regex.vimeo)),t=this._wrapFigure(t),e&&this._setFigure(t,"video"))},_convertCode:function(t){this._isNonEditable(t)||(t=this._wrapFigure(t),this._setFigure(t,"code"))},_convertWidget:function(t){var e;this._isNonEditable(t)||((e=m.dom(t)).addClass("redactor-component"),e.attr("data-redactor-type","widget"),e.attr("data-widget-code",encodeURI(t.innerHTML.trim())))},_unconvertBreakTag:function(t){return t.find("[data-redactor-tag]").each(function(t){var e,i=m.dom(t);i.removeAttr("data-redactor-tag"),0===t.attributes.length?(t.lastChild&&"BR"===t.lastChild.tagName||0!==(e=i.nextElement()).length&&e.attr("data-redactor-tag")&&t.appendChild(document.createElement("br")),i.unwrap()):t.lastChild&&"BR"===t.lastChild.tagName&&m.dom(t.lastChild).remove()}.bind(this)),t},_unconvertForm:function(t){this.utils.replaceToTag(t,"form")},_unconvertTable:function(t){m.dom(t).unwrap()},_unconvertWidget:function(t){t=m.dom(t);t.html(decodeURI(t.attr("data-widget-code"))),t.removeAttr("data-widget-code")},_unconvertImages:function(t){var e=m.dom(t);e.removeClass("redactor-component");var i=0!==e.closest("li").length,s=0!==e.closest("table").length,n=0!==e.find("figcaption").length,o=e.attr("style"),t=!(null===o||""===o),o=""!==e.attr("class");!i&&(!s||n||t||o)||e.unwrap()},_removeTypes:function(t){var e=m.dom(t),t=e.attr("data-redactor-type");t&&-1!==["image","widget","line","video","code","form","table"].indexOf(t)&&e.removeAttr("data-redactor-type"),e.hasClass("redactor-keep-figure")?e.removeClass("redactor-keep-figure"):"image"===t&&!1===this.opts.imageFigure&&(0!==e.find("figcaption").length||(e.hasClass("redactor-replace-figure")&&e.removeClass("redactor-replace-figure"),this.utils.replaceToTag(e,"p"))),e.removeClass("redactor-replace-figure")},_wrapFigure:function(t){var e=m.dom(t),t=e.closest("figure");return 0===t.length?e.wrap("<figure>"):t},_setFigure:function(t,e){t.addClass("redactor-component"),t.attr("data-redactor-type",e)},_setContenteditableCode:function(t){var e;this._isNonEditable(t)||(0!==(t=(e=m.dom(t)).children("code").first()).length?t:e).attr("contenteditable",!0).attr("tabindex","-1")},_acceptExtraRules:function(t,e){for(var i in e)"function"==typeof e[i]&&e[i](t)},_isNonEditable:function(t){return 0!==m.dom(t).closest(".non-editable").length}}),m.add("class","cleaner.paragraphize",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.cleaner=t.cleaner,this.element=t.element,this.stored=[],this.remStart="#####replace",this.remEnd="#####",this.paragraphizeTags=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"]},convert:function(t){var e=!0===(e=this._isConverted(t))?this._convert(t):e;return e=this._convertTable(e)},_convert:function(t,e){var i=this.opts.breakline||e?"sdivtag":this.opts.markup,s=e?"tbr":"br";t=this._storeTags(t);var n=[];t=(t=this.cleaner.storeComments(t,n)).trim(),t=this._trimLinks(t);e=this.opts.inlineTags.join("|");t=(t=(t=(t=(t=t.replace(new RegExp("<("+e+")(.*?[^>]?)>\n</("+e+")>","gi"),"<$1$2></$3>")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n");for(var o="",r=(t=this.opts.breakline?(t=(t=t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n")).replace(/<br\s?\/?>/gi,"xbreakmarkerz\n")).replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):t.replace(/[\n]+/g,"\n")).split("\n"),a=0;a<r.length;a++)o+="<"+i+">"+r[a]+"</"+i+">\n";return t=(t=(t=(t=o.replace(/\n$/,"")).replace(new RegExp("<"+i+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+i+">#####","gi"),"#####")).replace(new RegExp("#####</"+i+">","gi"),"#####"),t=this.opts.breakline?t.replace(/xbreakmarkerz/gi,"<br>"):t,t=this._restoreTags(t),t=this.cleaner.restoreComments(t,n),t=(t=(t=(t=this.opts.breakline?t.replace(new RegExp("<"+i+"></"+i+">","gi"),"<"+i+"><br></"+i+">"):t).replace(new RegExp("<sdivtag>","gi"),'<div data-redactor-tag="'+s+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")},_convertTable:function(t){var e=this.utils.buildWrapper(t);return e.find("td, th").each(this._convertCell.bind(this)),t=this.utils.getWrapperHtml(e)},_convertCell:function(t){var e=m.dom(t);this.stored=[];t=this._convert(e.html(),!0);e.html(t)},_storeTags:function(t){var i=this,t=this.utils.buildWrapper(t);return t.find(this.paragraphizeTags.join(", ")).each(function(t,e){e=document.createTextNode(i.remStart+e+i.remEnd+"xparagraphmarkerz");i.stored.push(t.outerHTML),t.parentNode.replaceChild(e,t)}),this.utils.getWrapperHtml(t)},_restoreTags:function(t){for(var e=0;e<this.stored.length;e++)this.stored[e]=this.stored[e].replace(/\$/g,"&#36;"),t=t.replace(this.remStart+e+this.remEnd,this.stored[e]);return t},_trimLinks:function(t){var e=this.utils.buildWrapper(t);return e.find("a").each(this._trimLink.bind(this)),t=this.utils.getWrapperHtml(e)},_trimLink:function(t){t=m.dom(t);t.html(t.html().trim())},_isConverted:function(t){return this._isDisabled(t)?t:!this._isEmptyHtml(t)||this.opts.emptyHtml},_isDisabled:function(){return!1===this.opts.paragraphize||this.element.isType("inline")},_isEmptyHtml:function(t){return""===t||"<p></p>"===t||"<div></div>"===t}}),m.add("service","detector",{init:function(t){this.app=t,this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return-1<this.userAgent.indexOf("firefox")},isIe:function(t){if(document.documentMode||/Edge/.test(navigator.userAgent))return"edge";t=RegExp("msie"+(isNaN(t)?"":"\\s"+t),"i").test(navigator.userAgent);return t=t||!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}}),m.add("service","offset",{init:function(t){this.app=t},get:function(t,e){var i={start:0,end:0},s=this.utils.getNode(t);if(!s)return!1;var n=this.editor.isEditor(s),o=!!n||this.selection.isIn(s),t=this.selection.getRange();return n||o?this.selection.is()&&o&&(n=m.dom(t.startContainer).hasClass("redactor-component")?t.startOffset:0,(o=t.cloneRange()).selectNodeContents(s),o.setEnd(t.startContainer,t.startOffset),t=this._getString(t,e),i.start=this._getString(o,e).length-n,i.end=i.start+t.length+n):i=!1,i},set:function(t,e){if(!this._setComponentOffset(e)){this.component.clearActive();var i=this.utils.getNode(e);if(i){var e=this.size(i),s=0,n=document.createRange();t.end=t.end>e?e:t.end,n.setStart(i,0),n.collapse(!0);for(var o=[i],r=!1,a=!1;!a&&(i=o.pop());)if(3===i.nodeType){var l=s+i.length;!r&&!this._isFigcaptionNext(i)&&t.start>=s&&t.start<=l&&(n.setStart(i,t.start-s),r=!0),r&&t.end>=s&&t.end<=l&&(n.setEnd(i,t.end-s),a=!0),s=l}else for(var h=i.childNodes.length;h--;)o.push(i.childNodes[h]);this.selection.setRange(n)}}},size:function(t,e){var i=this.utils.getNode(t);if(i){t=document.createRange().cloneRange();return t.selectNodeContents(i),this._getString(t,e).length}return 0},_getString:function(t,e){t=t.toString(),t=this.editor.isEmpty()?t.replace(/\uFEFF/g,""):t;return t=e?t.trim():t},_setComponentOffset:function(t){return!!this.component.isNonEditable(t)&&this.component.setActive(t)},_isFigcaptionNext:function(t){var e=t.nextSibling;return""===t.nodeValue.trim()&&e&&"FIGCAPTION"===e.tagName}}),m.add("service","inspector",{init:function(t){this.app=t},parse:function(t){return m.create("inspector.parser",this.app,this,t)},isText:function(t){if("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))return!0;t=m.dom(t).get();return t&&3===t.nodeType},isInlineTag:function(t,e){e=this._extendTags(this.opts.inlineTags,e);return this._isTag(t)&&-1!==e.indexOf(t.toLowerCase())},isBlockTag:function(t,e){e=this._extendTags(this.opts.blockTags,e);return this._isTag(t)&&-1!==e.indexOf(t.toLowerCase())},isTableCellTag:function(t){return-1!==["td","th"].indexOf(t.toLowerCase())},isHeadingTag:function(t){return-1!==["h1","h2","h3","h4","h5","h6"].indexOf(t.toLowerCase())},_isTag:function(t){return void 0!==t&&t},_extendTags:function(t,e){if(t=t.concat(t),e)for(var i=0;i<e.length;i++)t.push(e[i]);return t}}),m.add("class","inspector.parser",{init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.selection=t.selection,this.inspector=e;e=this.editor.getElement();this.el=i,this.$el=m.dom(this.el,e),this.node=this.$el.get(),this.node&&8===this.node.nodeType&&(this.node=!1),this.$component=this.$el.closest(".redactor-component",e)},isEditor:function(){return this.node===this.editor.getElement().get()},isInEditor:function(){return 0!==this.$el.parents(".redactor-in-"+this.uuid).length},isComponent:function(){return 0!==this.$component.length},isComponentType:function(t){return this.getComponentType()===t},isComponentActive:function(){return this.isComponent()&&this.$component.hasClass("redactor-component-active")},isComponentEditable:function(){var t=this.getComponentType();return this.isComponent()&&-1!==["code","table"].indexOf(t)},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var t=this.$el.closest("code"),e=t.parent("pre");return 0!==t.length&&0===e.length},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem("first")},isLastListItem:function(){return this._getLastOrFirstListItem("last")},isFirstTableCell:function(){return this._getLastOrFirstTableCell("first")},isLastTableCell:function(){return this._getLastOrFirstTableCell("last")},isTable:function(){return this.isComponentType("table")||this.getTable()},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var t=this.opts.inlineTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isBlock:function(){var t=this.opts.blockTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isElement:function(){return this.node&&this.node.nodeType&&3!==this.node.nodeType},hasParent:function(t){return 0!==this.$el.closest(t.join(",")).length},getNode:function(){return this.node},getTag:function(){return!!this.isElement()&&this.node.tagName.toLowerCase()},getComponent:function(){return!!this.isComponent()&&this.$component.get()},getComponentType:function(){return!!this.isComponent()&&this.$component.attr("data-redactor-type")},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode("figcaption")},getPre:function(){return this._getClosestNode("pre")},getCode:function(){return this._getClosestNode("code")},getList:function(){return this._getClosestNode("ul, ol")},getParentList:function(){return this._getClosestUpNode("ul, ol")},getListItem:function(){return this._getClosestNode("li")},getTable:function(){return this.getComponentType("table")?this.$component.find("table").get():this._getClosestNode("table")},getTableCell:function(){var t=this.$el.closest("td, th");return 0!==t.length&&t.get()},getComponentCodeElement:function(){return!!this.isComponentType("code")&&this.$component.find("pre code, pre").last().get()},getImageElement:function(){return!!this.isComponentType("image")&&this.$component.find("img").get()},getParagraph:function(){return this._getClosestNode("p")},getHeading:function(){return this._getClosestNode("h1, h2, h3, h4, h5, h6")},getDl:function(){return this._getClosestNode("dl")},getBlockquote:function(){return this._getClosestNode("blockquote")},getLink:function(){var t=this.isComponent()&&!this.isFigcaption();if(!this.isComponentType("table")&&t)return!1;t=this._getClosestElement("a");return!(!t||t.attr("data-file"))&&t.get()},getFile:function(){var t=this.isComponent();if(!this.isComponentType("table")&&t)return!1;t=this._getClosestElement("a");return!(!t||!t.attr("data-file"))&&t.get()},findFirstNode:function(t){return this.$el.find(t).first().get()},findLastNode:function(t){return this.$el.find(t).last().get()},_getLastOrFirstListItem:function(t){var e=this.getList(),i=this.getTag();if(e&&"li"===i){t=m.dom(e).find("li")[t]().get();if(t&&this.node===t)return!0}return!1},_getLastOrFirstTableCell:function(t){var e=this.getTable(),i=this.getTag();if(e&&("td"===i||"th"===i)){t=m.dom(e).find("td, th")[t]().get();if(t&&this.node===t)return!0}return!1},_getClosestUpNode:function(t){var e=this.editor.getElement(),e=this.$el.parents(t,e).last();return 0!==e.length&&e.get()},_getClosestNode:function(t){var e=this.editor.getElement(),e=this.$el.closest(t,e);return 0!==e.length&&e.get()},_getClosestElement:function(t){var e=this.editor.getElement(),e=this.$el.closest(t,e);return 0!==e.length&&e}}),m.add("service","marker",{init:function(t){this.app=t},build:function(t,e){var i=document.createElement("span");return i.id="selection-marker-"+this._getPos(t),i.className="redactor-selection-marker",i.innerHTML=this.opts.markerChar,e?i.outerHTML:i},buildHtml:function(t){return this.build(t,!0)},insert:function(t){this.remove();var e="both"!==t&&("start"===t||this.selection.isCollapsed());this.selection.is()||this.editor.focus();var i=this.selection.getRange();if(i){var s=this.build("start"),n=this.build("end"),t=i.cloneRange();return e||(t.collapse(!1),t.insertNode(n)),t.setStart(i.startContainer,i.startOffset),t.collapse(!0),t.insertNode(s),i.setStartAfter(s),e||i.setEndBefore(n),this.selection.setRange(i),s}},find:function(t,e){var i=this.editor.getElement(),t=(e||i).find("span#selection-marker-"+this._getPos(t));return 0!==t.length&&t.get()},restore:function(){var t,e,i=this.find("start"),s=this.find("end"),n=this.selection.getRange();n&&this.selection.is()||(this.editor.focus(),n=document.createRange()),i&&(t=!!s&&s.previousSibling,e=(!(e=i.nextSibling)||3!==e.nodeType||""!==e.textContent.replace(/[\n\t]/g,""))&&e,s?e&&"selection-marker-end"===e.id?this._restoreInject(n,i):t&&e?(n.selectNodeContents(t),n.collapse(!1),n.setStart(e,0)):t&&!e?(n.selectNodeContents(t),n.collapse(!1),n.setStartAfter(i)):(n.setStartAfter(i),n.setEndBefore(s)):e?(n.selectNodeContents(e),n.collapse(!0)):this._restoreInject(n,i),this.selection.setRange(n),i&&i.parentNode.removeChild(i),s&&s.parentNode.removeChild(s))},remove:function(){var t=this.find("start"),e=this.find("end");t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)},_getPos:function(t){return void 0===t?"start":t},_restoreInject:function(t,e){var i=this.utils.createInvisibleChar();m.dom(e).after(i),t.selectNodeContents(i),t.collapse(!1)}}),m.add("service","component",{init:function(t){this.app=t,this.activeClass="redactor-component-active"},create:function(t,e){return m.create(t+".component",this.app,e)},build:function(t){var e,i=m.dom(t).attr("data-redactor-type");return(e=i?this.create(i,t):e)||t},remove:function(t,e){var i=m.dom(t).closest(".redactor-component"),s=i.attr("data-redactor-type"),n=i.parent(),o=this.inspector.parse(n),t=this.utils.findSiblings(i,"prev"),n=this.utils.findSiblings(i,"next");!1!==this.app.broadcast(s+".delete",i)&&(i.remove(),this.app.broadcast(s+".deleted",i),this.app.broadcast("contextbar.close"),this.app.broadcast("imageresizer.stop"),!1!==e&&((o=o.getTableCell())&&this.utils.isEmptyHtml(o.innerHTML)?this.caret.setStart(o):n?this.caret.setStart(n):t?this.caret.setEnd(t):this.editor.startFocus()),this.editor.isEmpty()&&(this.editor.setEmpty(),this.editor.startFocus(),this.app.broadcast("empty")))},isNonEditable:function(t){t=this.inspector.parse(t);return t.isComponent()&&!t.isComponentEditable()},isActive:function(t){if(t){t=this.inspector.parse(t);return m.dom(t.getComponent()).hasClass(this.activeClass)}return 0!==this._find().length},getActive:function(t){var e=this._find();return 0!==e.length&&(t?e:e.get())},setActive:function(t){this.clearActive(),this.editor.focus();var e=this.inspector.parse(t),t=e.getComponent(),t=m.dom(t);e.isFigcaption()||(0===(e=t.find(".redactor-component-caret")).length&&(e=this._buildCaret(),t.prepend(e)),this.caret.setAtStart(e.get())),t.addClass(this.activeClass)},clearActive:function(){var t=this._find();t.removeClass(this.activeClass),t.find(".redactor-component-caret").remove(),this.app.broadcast("imageresizer.stop")},setOnEvent:function(t,e){this.clearActive();var i=this.inspector.parse(t.target);i.isFigcaption()||i.isComponentEditable()||i.isComponent()&&(this.setActive(t.target),!0!==e&&t.preventDefault())},executeScripts:function(t){if(void 0===t){t=this.editor.getElement().find("[data-redactor-type]").find("script").getAll();this.executeScripts.call(this,t)}else for(var e=0;e<t.length;e++)if(""!==t[e].src){var i=t[e].src;this.$doc.find('head script[src="'+i+'"]').remove();var s=m.dom("<script>");s.attr("src",i),s.attr("async defer"),s.get().onload=function(){-1!==i.search("instagram")&&window.instgrm.Embeds.process(),this.executeScripts(t.slice(e+1))}.bind(this);var n=document.getElementsByTagName("head")[0];n&&n.appendChild(s.get());break}},_find:function(){return this.editor.getElement().find("."+this.activeClass)},_buildCaret:function(){var t=m.dom("<span>");return t.addClass("redactor-component-caret"),t.attr("contenteditable",!0),t}}),m.add("service","insertion",{init:function(t){this.app=t},set:function(t,e,i){return null===t&&(t=""),t=!1!==e?this.cleaner.input(t):t,t=!1!==e?this.cleaner.paragraphize(t):t,this.editor.getElement().html(t),!1!==i&&this.editor.endFocus(),t},insertNode:function(t,e){this.editor.focus();t=this.utils.isFragment(t)?t:this.utils.createFragment(t);return this._collapseSelection(),this._insertFragment(t),this._setCaret(e,t),this._sendNodes(t.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement("br"),"after")},insertNewline:function(){return this.insertNode(document.createTextNode("\n"),"after")},insertText:function(t){return this.insertHtml(this.cleaner.getFlatText(t))},insertChar:function(t){return this.insertNode(t,"after")},insertRaw:function(t){return this.insertHtml(t,!1)},insertToEnd:function(t,e){t&&(3===t.nodeType&&-1!==t.nodeValue.search(/^\n/)&&(t=t.previousElementSibling),(t=m.dom(t)).attr("data-redactor-type")===e&&(e=this.opts.breakline?"<br>":"<p>",e=m.dom(e),t.after(e),this.caret.setStart(e)))},insertPoint:function(t){var e,i,s=this.marker.build("start"),n=!1,o=t.clientX,r=t.clientY;return document.caretPositionFromPoint?(i=document.caretPositionFromPoint(o,r),t=document.getSelection(),this.inspector.parse(i.offsetNode).isInEditor()&&((e=t.getRangeAt(0)).setStart(i.offsetNode,i.offset),e.collapse(!0),e.insertNode(s),n=!0)):document.caretRangeFromPoint&&(e=document.caretRangeFromPoint(o,r),this.inspector.parse(e.startContainer).isInEditor()&&(e.insertNode(s),n=!0)),n},insertToPoint:function(t,e,i,s){return!0===i||this.insertPoint(t)||(t=this.editor.getLastNode(),m.dom(t).after(this.marker.build("start"))),this.component.clearActive(),this.selection.restoreMarkers(),this.insertHtml(e,s)},insertToOffset:function(t,e){return this.offset.set({start:t,end:t}),this.insertHtml(e)},insertHtml:function(t,e){if(this.opts.input){var i=this.utils.parseHtml(t);if(this.selection.isAll())return this._insertToAllSelected(i);this.selection.is()||(h=m.dom("<p>"),this.editor.getElement().append(h),this.caret.setStart(h));var s=this.selection.isCollapsed(),n=this.selection.isText(),o=this.selection.getCurrent(),r=this.selection.getBlock(),a=this.inspector.parse(o);this._collapseSelection();var i=this._getCleanedInput(i,a,e),l=this._isFigure(i.html),t=this._isComponentSpan(i.html),h=this.inspector.isText(i.html);if(this.editor.isEmpty())return this._insertToEmptyEditor(i.html);if(a.isComponent()&&!a.isComponentEditable())return this._insertToWidget(o,a,i.html);if(t)return this.insertNode(i.nodes,"end");if(l&&!n&&!a.isList())return a.isInline()?this._insertToInline(o,i):(c=this.utils.createFragment(i.html),this.utils.splitNode(o,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes));if(a.isCode())return this._insertToCode(i,o,e);if(a.isPre())return this._insertToPre(i,e);if(a.isHeading()||a.isFigcaption())return i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,["a"]):i.html,i.html=!1!==e?this.cleaner.replaceNbspToSpaces(i.html):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end");if(this.opts.breakline&&r&&"DIV"===r.tagName){if(this._isPlainHtml(i.html))return this.insertNode(i.nodes,"end");i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html;var c=this.utils.createFragment(i.html),r=this.selection.getRange();return r&&!this.selection.isCollapsed()&&r.deleteContents(),this.utils.splitNode(o,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes)}if(h)return!n&&"br"!==this.opts.markup&&this._hasBlocksAndImages(i.nodes)?(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.utils.splitNode(o,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes)):(i.html=!1!==e?i.html.replace(/\n/g,"<br>"):i.html,c=this.utils.createFragment(i.html),this.insertNode(c.nodes,"end"));if(!s&&!l)return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end"));if(a.isInline()&&!this._isPlainHtml(i.html))return this._insertToInline(o,i);if(a.isBlockquote()||a.isDl())return(d=this.opts.inlineTags).concat(["br"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,d):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end");if(a.isParagraph())return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.utils.splitNode(o,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes));if(a.isList()&&(d=(d=this.opts.inlineTags).concat(["br","li","ul","ol","img"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,d):i.html,i.html=!1!==e?this.cleaner.removeBrAtEnd(i.html):i.html,c=this.utils.createFragment(i.html),i.nodes=c.nodes,this._containsTags(i.html,["ul","ol","li"]))){var d=this.selection.getElement(o);if(d&&"LI"===d.tagName&&this.caret.isStart(d)){i.nodes=m.dom(c.nodes).unwrap("ul, ol").getAll(),m.dom(d).before(i.nodes);e=i.nodes[i.nodes.length-1];return this.caret.setEnd(e),this._sendNodes(i.nodes)}return this._isPlainHtml(i.html)?this.insertNode(c,"end"):(c=this._buildList(i,d,c),this.utils.splitNode(o,c,!0),this.caret.setEnd(c.last),this._sendNodes(c.nodes))}return this.insertNode(i.nodes,"end")}},_insertToAllSelected:function(t){t=this.set(t.html),t=this.utils.parseHtml(t);return this._sendNodes(t.nodes)},_insertToEmptyEditor:function(t){t=this.cleaner.paragraphize(t);var e=this.utils.createFragment(t),t=this.editor.getElement();return t.html(""),t.append(e.frag),this.caret.setEnd(e.last),this._sendNodes(e.nodes)},_insertToInline:function(t,e){e=this.utils.createFragment(e.html);return this.utils.splitNode(t,e,!1,!0),this.caret.setEnd(e.last),this._sendNodes(e.nodes)},_insertToCode:function(t,e,i){t.html=!1!==i?this.cleaner.encodeHtml(t.html):t.html,t.html=!1!==i?this.cleaner.removeNl(t.html):t.html;t=this.utils.createFragment(t.html),t=this.insertNode(t,"end");return this.utils.normalizeTextNodes(e),t},_insertToPre:function(t,e){t.html=!1!==e?this.cleaner.encodeHtml(t.html):t.html;t=this.utils.createFragment(t.html);return this.insertNode(t,"end")},_insertToWidget:function(t,e,i){i=this._isComponentSpan(i)?i:this.cleaner.paragraphize(i);i=this.utils.createFragment(i),e=e.getComponent(),e=m.dom(e);return e.after(i.frag),e.remove(),this.caret.setEnd(i.last),this._sendNodes(i.nodes)},_insertFragment:function(t){var e,i=this.selection.getRange();i&&(this.selection.isCollapsed()?3!==(e=i.startContainer).nodeType&&"BR"===e.tagName&&(this.caret.setAfter(e),e.parentNode.removeChild(e)):i.deleteContents(),i.insertNode(t.frag))},_sendNodes:function(t){for(var e=0;e<t.length;e++){var i=t[e],s=3!==i.nodeType&&"function"==typeof i.getAttribute&&i.getAttribute("data-redactor-type");s&&this.app.broadcast(s+".inserted",this.component.build(i))}return this.detector.isIe()&&this.editor.getElement().find("[data-redactor-type=table]").attr("contenteditable",!0),this.app.broadcast("inserted",t),this.component.executeScripts(),t},_setCaret:function(t,e){var i=this._isLastInline(e);t?this.caret["set"+this.utils.ucfirst(t=i&&"end"===t?"after":t)](e.last):!1!==t&&i&&this.caret.setAfter(e.last)},_isLastInline:function(t){return!!t.last&&this.inspector.parse(t.last).isInline()},_getCleanedInput:function(t,e,i){e=e.isCode()||e.isPre();return t.html=t.html.replace(/&nbsp;/g," "),t.html=e||!1===i?t.html:this.cleaner.input(t.html),t=e||!1===i?t:this.utils.parseHtml(t.html)},_getContainer:function(t){return m.dom(this.utils.createTmpContainer(t))},_buildList:function(t,e,i){t=t.nodes[0];if(t&&3!==t.nodeType&&"li"===t.tagName){e=m.dom(e).get().tagName.toLowerCase(),e=m.dom("<"+e+" />");return e.append(i.nodes),this.utils.createFragment(e.get().outerHTML)}return i},_containsTags:function(t,e){return 0!==this._getContainer(t).find(e.join(",")).length},_collapseSelection:function(){},_hasFigureOrTable:function(t){return 0!==this._getContainer(t).find("figure, table").length},_hasBlocks:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")).length},_hasBlocksAndImages:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")+",img").length},_isPlainHtml:function(t){return 0===this._getContainer(t).find(this.opts.blockTags.join(",")+", img").length},_isFigure:function(t){if(this._isHtmlString(t))return 0!==m.dom(t).closest("figure").length},_isComponentSpan:function(t){if(this._isHtmlString(t))return 0!==m.dom(t).closest("span.redactor-component").length},_isHtmlString:function(t){return!("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))}}),m.add("service","block",{init:function(t){this.app=t,this.tags=["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6"]},format:function(t){return this.params={args:!1},this.params.type=t.type||"set",this.params.tag="string"==typeof t?t:t.tag||this.opts.markup,this.params.tag=this.params.tag.toLowerCase(),this.params.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},t.class||t.style||t.attr||(this.params.args=!1),this._format()},add:function(t,e,i){return this._apply("add",t,e,!0,i)},set:function(t,e){return this._apply("set",t,e)},toggle:function(t,e){return this._apply("toggle",t,e)},remove:function(t,e){return this._apply("remove",t,e)},clearFormat:function(t){return this._clear(t,"all")},clearStyle:function(t){return this._clear(t,"style")},clearClass:function(t){return this._clear(t,"class")},clearAttr:function(t){return this._clear(t,"attr")},_format:function(){this.collapsed=this.selection.isCollapsed(),this.selection.save();this.selection.getBlock();var t=this._getBlocks(),e=this._isToggleFormatType(t)?"toggle":"set",e=this._getReplacedTag(e),i=this._replaceBlocks(t,e);return i=this._buildNodes(i),this._restoreSelection(i),i},_clear:function(t,e,i,s){!1!==i&&this.selection.save();t=this._getElements(t,s);return"all"===e?this._removeAllAttr(t,!1):"style"===e?(t.removeAttr("style"),t.removeAttr("data-redactor-style-cache")):"class"===e?t.removeAttr("class"):"attr"===e&&this._removeAllAttr(t),s=t.getAll(),!1!==i&&this._restoreSelection(s),s},_getElements:function(t,e){return m.dom(e||this._getBlocks(t))},_getBlocks:function(t){for(var e=this.selection.getBlocks({tags:t||this.tags}),i=[],s=0;s<e.length;s++)"DIV"===e[s].tagName&&!e[s].getAttribute("data-redactor-tag")||i.push(e[s]);return i},_getReplacedTag:function(t){return this.opts.breakline?"toggle"===t||"p"===this.params.tag?"div":this.params.tag:"toggle"===t?this.opts.markup:this.params.tag},_isStandardParagraph:function(){return!this.opts.breakline&&"p"===this.opts.markup},_isStandardDiv:function(){return!this.opts.breakline&&"div"===this.opts.markup},_isBreaklineBlock:function(t){return t&&"DIV"===t.tagName&&"br"===t.getAttribute("data-redactor-tag")},_isToggleFormatType:function(t){for(var e=0,i=t.length,s=0;s<i;s++)t[s]&&this.params.tag===t[s].tagName.toLowerCase()&&e++;return e===i},_isCurrentBlockOneAndEmpty:function(t){return this.collapsed&&1===t.length&&this.utils.isEmpty(t[0])},_buildNodes:function(t){return 0<t.length&&(t=this._applyArgs(t,!1),t=this._combinePre(t),t=this._cleanBlocks(t)),t},_replaceBlocks:function(t,e){for(var i=[],s=0;s<t.length;s++){var n=this.utils.replaceToTag(t[s],e);i.push(n.get())}return i},_combinePre:function(t){for(var e=[],i=0;i<t.length;i++){var s,n,o=t[i].nextElementSibling;o&&"PRE"===t[i].tagName&&"PRE"===o.tagName&&(s=m.dom(t[i]),n=m.dom(o),o=document.createTextNode("\n"),s.append(o),s.append(n),n.unwrap("pre")),e.push(t[i])}return e},_cleanBlocks:function(t){for(var e=["h1","h2","h3","h4","h5","h6"],i=this.opts.inlineTags,s=0;s<t.length;s++){var n=t[s].tagName.toLowerCase(),o=m.dom(t[s]);-1!==e.indexOf(n)?o.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker").unwrap():"pre"===n&&o.find(i.join(",")).not(".redactor-selection-marker").unwrap(),!1===this.params.args&&"p"===this.params.tag&&o.removeAttr("class"),this.opts.breakline&&"div"===n?o.attr("data-redactor-tag","br"):o.removeAttr("data-redactor-tag"),this.utils.normalizeTextNodes(t[s])}return t},_cleanEmptyClass:function(t){t.each(function(t){""===t.className&&t.removeAttribute("class")})},_cleanEmptyStyle:function(t){this.utils.removeEmptyAttr(t.get(),"style")?t.removeAttr("data-redactor-style-cache"):t.attr("data-redactor-style-cache",t.attr("style"))},_apply:function(t,e,i,s,n){!1!==s&&this.selection.save();var o,r,i=this._getElements(i,n);return e.class&&("set"===t?(i.removeAttr("class"),i.addClass(e.class)):"add"===t?i.addClass(e.class):"toggle"===t?i.toggleClass(e.class):"remove"===t&&i.removeClass(e.class),this._cleanEmptyClass(i)),e.attr&&("set"===t?(this._removeAllAttr(i),i.attr(e.attr)):"add"===t?i.attr(e.attr):"toggle"===t?(o=e.attr,i.each(function(t){var e,i=m.dom(t);for(e in o)i.attr(e)?i.removeAttr(e):i.attr(e,o[e])})):"remove"===t&&i.removeAttr(e.attr)),e.style&&("set"===t?(i.removeAttr("style"),i.css(e.style),i.each(function(t){t=m.dom(t);t.attr("data-redactor-style-cache",t.attr("style"))})):"add"===t?(o=e.style,i.each(function(t){t=m.dom(t);t.css(o),t.attr("data-redactor-style-cache",t.attr("style")),this._convertStyleQuotes(t)}.bind(this))):"toggle"===t?(o=e.style,i.each(function(t){var e,i=m.dom(t);for(e in o){var s=o[e],n=i.css(e),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,""),s=this.utils.isRgb(s)?this.utils.rgb2hex(s):s.replace(/"/g,"");n=this.utils.hex2long(n),("string"==typeof(s=this.utils.hex2long(s))?s.toLowerCase():s)===("string"==typeof n?n.toLowerCase():n)?i.css(e,""):i.css(e,s)}this._convertStyleQuotes(i),this._cleanEmptyStyle(i)}.bind(this))):"remove"===t&&(r=e.style,i.each(function(t){t=m.dom(t);t.css(r,""),this._cleanEmptyStyle(t)}.bind(this)))),n=i.getAll(),!1!==s&&this._restoreSelection(n),n},_applyArgs:function(t){return t=this.params.args?this._apply(this.params.type,this.params.args,!1,!1,t):this._clear(!1,"all",!1,t)},_removeAllAttr:function(t,o){t.each(function(t){var e=["data-redactor-tag","data-redactor-style-cache"];!1===o&&(e.push("style"),e.push("class"));for(var i=t.attributes.length;0<i--;){var s=t.attributes[i],n=s.name;-1===e.indexOf(n)&&t.removeAttributeNode(s)}})},_restoreSelection:function(t){this._isCurrentBlockOneAndEmpty(t)?this.caret.setStart(t[0]):setTimeout(function(){this.selection.restore()}.bind(this),1)},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))}}),m.add("service","inline",{mixins:["formatter"],init:function(t){this.app=t,this.count=0},format:function(t){if(!this._isFormat())return[];this.type=t.type||"set",this.tag="string"==typeof t?t:t.tag,this.tag=this.tag.toLowerCase(),this.tag=this.arrangeTag(this.tag),"string"==typeof t?this.args=!1:this.buildArgs(t),this.detector.isIe()||this.editor.disableNonEditables();t=this.selection.isCollapsed()?this.formatCollapsed():this.formatUncollapsed();return this.detector.isIe()||this.editor.enableNonEditables(),t},_isFormat:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),i=e.isComponent()&&!e.isComponentType("table")&&!e.isFigcaption();return!(!1!==t||!this.selection.isAll())||!(!t||e.isPre()||e.isCode()||i)},arrangeTag:function(t){var e,i=this.opts.replaceTags;for(e in i)t===e&&(t=i[e]);return t},formatCollapsed:function(){var t,e,i=[],s=this.selection.getInlineFirst(),n=this.selection.getInlines({all:!0}),o=m.dom(s);if(s){var r=this.inspector.parse(s),a=this.utils.isEmptyHtml(s.innerHTML);if(a)s.tagName.toLowerCase()===this.tag?this.hasSameArgs(s)?(this.caret.setAfter(s),o.remove(),a=this.selection.getElement(),this.utils.normalizeTextNodes(a)):"span"===this.tag?(i=this.applyArgs([s],!1),this.caret.setStart(s)):i=this.insertInline(i):r.hasParent([this.tag])?(e=(t=o.closest(this.tag)).get(),this.hasSameArgs(e)?(t.unwrap(),this.caret.setStart(s)):i=this.insertInline(i)):i=this.insertInline(i);else if(s.tagName.toLowerCase()===this.tag)this.hasSameArgs(s)?(c=this.utils.extractHtmlFromCaret(s),d=m.dom("<"+this.tag+" />"),d=this.utils.cloneAttributes(s,d),o.after(d.append(c)),""===d.html().trim()&&d.remove(),this.caret.setAfter(s)):i=this.insertInline(i);else if(r.hasParent([this.tag]))if(e=(t=o.closest(this.tag)).get(),this.hasSameArgs(e)){var l,h,c=this.utils.extractHtmlFromCaret(e,e),d=m.dom("<"+this.tag+" />");d=this.utils.cloneAttributes(e,d);for(var u=0,n=n.reverse(),p=0;p<n.length;p++)n[p]!==e&&(h=m.dom("<"+n[p].tagName.toLowerCase()+">"),0===u?l=h:l.append(h),u++);t.after(d.append(c)),t.after(l),this.caret.setStart(h)}else i=this.insertInline(i);else i=this.insertInline(i)}else i=this.insertInline(i);return i},insertInline:function(t){var e=document.createElement(this.tag);return t=this.insertion.insertNode(e,"start"),this.applyArgs(t,!1)},hasSameArgs:function(t){if(0===t.attributes.length&&!1===this.args)return!0;var e=!0;if(this.args){var i,s=0;for(i in this.args){var n=m.dom(t),o=this.args[i],r=this.utils.toParams(o),a=n.attr(i);if(o)if("style"===i){for(var r=r.trim().replace(/;$/,""),o=this.utils.styleToObj(n.attr("style")),l=r.split(";"),h=0,c=0;c<l.length;c++){var d=l[c].split(":"),u=d[0].trim(),p=d[1].trim();-1!==u.search(/color/)?!(d=n.css(u))||d!==p&&this.utils.rgb2hex(d)!==p||h++:n.css(u)===p&&h++}h===l.length&&Object.keys(o).length===l.length&&s++}else a===r&&s++;else a&&""!==a||s++}e=s===Object.keys(this.args).length}return e},formatUncollapsed:function(){var t=this.selection.getInlines({all:!0,inside:!0});this.detector.isIe()?this.selection.saveMarkers():this.selection.save(),this._convertTags("u"),this._convertTags("del"),this._convertToStrike(t),this.detector.isIe()?this.selection.restoreMarkers():this.selection.restore(),document.execCommand("strikethrough"),this._clearDecoration(),this.selection.save();for(var e=this._revertToInlines(),e=this.applyArgs(e,!1),i=0;i<e.length;i++){var s=e[i],n=s.tagName.toLowerCase(),o=s.attributes.length;n===this.tag&&0===o&&this.args&&(m.dom(s).unwrap(),e.splice(i,1))}return this.selection.restore(),this._clearEmptyStyle(),e=this._normalizeBlocks(e)},_convertTags:function(e){this.tag!==e&&this.editor.getElement().find(e).each(function(t){this.utils.replaceToTag(t,"span").addClass("redactor-convertable-"+e)}.bind(this))},_revertTags:function(e){this.editor.getElement().find("span.redactor-convertable-"+e).each(function(t){t=this.utils.replaceToTag(t,e);t.removeClass("redactor-convertable-"+e),this.utils.removeEmptyAttr(t,"class")&&t.removeAttr("class")}.bind(this))},_convertToStrike:function(t){for(var e=this.selection.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),i=0;i<t.length;i++){var s=this.arrangeTag(t[i].tagName.toLowerCase()),n=t[i],o=m.dom(n),r=this.hasSameArgs(n);if(s===this.tag)if("span"===this.tag&&this._isTextSelected(n,e))o.addClass("redactor-convertable-apply");else if(r&&"a"!==this.tag)this._replaceToStrike(o);else if("span"===this.tag){if(this.args&&this.args.style)for(var a in this.args.style)o.css(a,"");this.utils.removeEmptyAttr(o.get(),"style")?o.addClass("redactor-convertable-apply"):o.addClass("redactor-unconvertable-apply")}else r||o.addClass("redactor-convertable-apply")}},_replaceToStrike:function(t){t.replaceWith(function(){return m.dom("<strike>").append(t.contents())})},_revertToInlines:function(){var i=[],t=this.editor.getElement();return"u"!==this.tag&&t.find("u").unwrap(),t.find(".redactor-convertable-u").each(function(t){i.push(t)}),t.find(".redactor-convertable-apply").each(function(t){var e=m.dom(t);e.find("strike").unwrap(),this._forceRemoveClass(e,"redactor-convertable-apply"),i.push(t)}.bind(this)),t.find("span.redactor-unconvertable-apply").each(function(t){t=m.dom(t);this._forceRemoveClass(t,"redactor-unconvertable-apply")}.bind(this)),t.find("strike").each(function(t){t=this.utils.replaceToTag(t,this.tag);i.push(t.get())}.bind(this)),this._revertTags("u"),this._revertTags("del"),i},_normalizeBlocks:function(e){var t=this.opts.inlineTags,i=this.selection.getBlocks();if(i)for(var s=0;s<i.length;s++)"PRE"===i[s].tagName&&m.dom(i[s]).find(t.join(",")).not(".redactor-selection-marker").each(function(t){-1!==e.indexOf(t)&&(e=this.utils.removeFromArrayByValue(e,t)),m.dom(t).unwrap()}.bind(this));return e},_clearDecoration:function(){this.editor.getElement().find(this.opts.inlineTags.join(",")).each(function(t){"line-through"!==t.style.textDecoration&&"line-through"!==t.style.textDecorationLine||((t=m.dom(t)).css("textDecorationLine",""),t.css("textDecoration",""),t.wrap("<strike>"))})},_clearEmptyStyle:function(){for(var t=this.getInlines(),e=0;e<t.length;e++){this._clearEmptyStyleAttr(t[e]);var i=t[e].childNodes;if(i)for(var s=0;s<i.length;s++)this._clearEmptyStyleAttr(i[s])}},_clearEmptyStyleAttr:function(t){3!==t.nodeType&&this.utils.removeEmptyAttr(t,"style")&&(t.removeAttribute("style"),t.removeAttribute("data-redactor-style-cache"))},_forceRemoveClass:function(t,e){t.removeClass(e),this.utils.removeEmptyAttr(t,"class")&&t.removeAttr("class")},_isTextSelected:function(t,e){t=this.utils.removeInvisibleChars(t.textContent);return e===t||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(t)+"$"))},getInlines:function(t){return t?this.selection.getInlines({tags:t,all:!0}):this.selection.getInlines({all:!0})},getElements:function(t){return m.dom(this.getInlines(t))},clearFormat:function(){this.selection.save();for(var t=this.selection.getInlines({all:!0}),e=0;e<t.length;e++){var i=m.dom(t[e]);this.selection.getInline(t[e])&&i.unwrap()}this.selection.restore()}}),m.add("service","autoparser",{init:function(t){this.app=t,this.cleaner=this.app.cleaner},observe:function(){var t=this.editor.getElement().find(".redactor-autoparser-object").each(function(t){t=m.dom(t);t.removeClass("redactor-autoparser-object"),""===t.attr("class")&&t.removeAttr("class")});0<t.length&&t.each(function(t){var e,i,s=t.tagName;"A"===s?e="link":"IMG"===s?e="image":"IFRAME"===s&&(e="video"),e&&(i=m.create(e+".component",this.app,t),this.app.broadcast(e+".inserted",i),this.app.broadcast("autoparse",e,i))}.bind(this))},format:function(t,e){this._isKey(e)&&this._format(e===this.keycodes.ENTER)},parse:function(t){var e=["figure","html","form","pre","object","video","iframe","code","a","img"],i=[],s=0,n=[];t=this.cleaner.storeComments(t,n),t=(t=(t=this.cleaner.encodeCode(t)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&");for(var o,r,a,l=0;l<e.length;l++){var h="img"===e[l]?"<"+e[l]+"[^>]*>":"<"+e[l]+"([\\w\\W]*?)</"+e[l]+">";if(null!==(u=t.match(new RegExp(h,"gi"))))for(var c=0;c<u.length;c++)t=t.replace(u[c],"#####replaceparse"+s+"#####"),i.push(u[c]),s++}if(this.opts.autoparseImages&&t.match(this.opts.regex.imageurl))for(var d=t.match(this.opts.regex.imageurl),l=0;l<d.length;l++)t=t.replace(d[l],'<img class="redactor-autoparser-object" src="'+d[l]+'">');this.opts.autoparseVideo&&(t.match(this.opts.regex.youtube)||t.match(this.opts.regex.vimeo))&&(r=this.opts.autoparseHttps?"https:":"",t.match(this.opts.regex.youtube)?(a=r+"//www.youtube.com/embed/$1",o=this.opts.regex.youtube):t.match(this.opts.regex.vimeo)&&(a=r+"//player.vimeo.com/video/$2",o=this.opts.regex.vimeo),a=this.component.create("video",'<iframe width="500" height="281" src="'+a+'" frameborder="0" allowfullscreen></iframe>'),t=t.replace(o,a.get().outerHTML));for(l=0;l<e.length;l++){var u,h="img"===e[l]?"<"+e[l]+"[^>]*>":"<"+e[l]+"([\\w\\W]*?)</"+e[l]+">";if(null!==(u=t.match(new RegExp(h,"gi"))))for(c=0;c<u.length;c++)t=t.replace(u[c],"#####replaceparse"+s+"#####"),i.push(u[c]),s++}return this.opts.autoparseLinks&&t.match(this.opts.regex.url)&&(t=this._formatLinks(t)),t=this._restoreReplaced(i,t),t=this._restoreReplaced(i,t),t=this.cleaner.restoreComments(t,n)},_isKey:function(t){return t===this.keycodes.ENTER||t===this.keycodes.SPACE},_format:function(t){var e,i,s,n,o,r=this.selection.getParent(),a=m.dom(r);r&&0!==a.closest("figure, pre, code, img, a, iframe").length||!this.selection.isCollapsed()||(e=this.utils.createInvisibleChar(),this.selection.getRange().insertNode(e),o=this.selection.getCurrent(),r=this.inspector.parse(o),a=m.dom(o),e.parentNode.removeChild(e),o&&3===o.nodeType&&(o=o.textContent,this.opts.autoparseImages&&o.match(this._convertToRegExp(this.opts.regex.imageurl))?(i=r.isList(),r=o.match(this.opts.regex.imageurl),(i=this.component.create("image",i?void 0:"<figure><img></figure>")).setSrc(r[0]),i.addClass("redactor-autoparser-object"),o=o.replace(r[0],i.get().outerHTML),i="image"):this.opts.autoparseVideo&&(o.match(this._convertToRegExp(this.opts.regex.youtube))||o.match(this._convertToRegExp(this.opts.regex.vimeo)))?(o.match(this.opts.regex.youtube)?(n="//www.youtube.com/embed/$1",s=this.opts.regex.youtube):o.match(this.opts.regex.vimeo)&&(n="//player.vimeo.com/video/$2",s=this.opts.regex.vimeo),(n=this.component.create("video",'<iframe width="500" height="281" src="'+n+'" frameborder="0" allowfullscreen></iframe>')).addClass("redactor-autoparser-object"),o=o.replace(s,n.get().outerHTML),i="video"):this.opts.autoparseLinks&&o.match(this._convertToRegExp(this.opts.regex.url))&&(o=this._formatLinks(o,t),i="link"),i&&(t?(this.selection.save(),a.replaceWith(o),this.selection.restore()):a.replaceWith(o),o=this.editor.getElement().find(".redactor-autoparser-object").removeClass("redactor-autoparser-object"),o="link"===i?m.create("link.component",this.app,o):o,"link"===i?(t||this.caret.setAfter(o),this.app.broadcast("link.inserted",o)):(this.caret.setAfter(o),t=o.clone(),o.remove(),o=this.insertion.insertHtml(t),o=this.component.build(o)),this.app.broadcast("autoparse",i,o))))},_formatLinks:function(t){var s=!1!==this.opts.pasteLinkTarget?' target="'+this.opts.pasteLinkTarget+'"':"",n=' class="redactor-autoparser-object"',o=this;return t=(t=t.replace(this.opts.regex.aurl1,function(t){return'<a href="'+t+'"'+s+n+">"+o._subLinkText(t)+"</a>"})).replace(this.opts.regex.aurl2,function(t,e,i){return e+'<a href="http://'+i+'"'+s+n+">"+o._subLinkText(i)+"</a>"})},_subLinkText:function(t){return t=-1===(t=t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t).search("%")?decodeURIComponent(t):t},_restoreReplaced:function(t,e){for(var i=0;i<t.length;i++)e=e.replace("#####replaceparse"+i+"#####",t[i]);return e},_convertToRegExp:function(t){return new RegExp(String(t).replace(/^\//,"").replace(/\/ig$/,"").replace(/\/gi$/,"")+"$","gi")}}),m.add("service","storage",{init:function(t){this.app=t,this.data=[]},observeImages:function(){this.opts.imageObserve&&this.editor.getElement().find("[data-image]").each(this._addImage.bind(this))},observeFiles:function(){this.editor.getElement().find("[data-file]").each(this._addFile.bind(this))},setStatus:function(t,e){this.data[t].status=e},getChanges:function(){var t,e=this.editor.getElement();for(t in this.data){var i=this.data[t],s=e.find("[data-"+i.type+'="'+i.id+'"]');this.setStatus(i.id,0!==s.length)}return this.data},add:function(t,e){var i=m.dom(e),e=i.attr("data-"+t);this.data[e]={type:t,status:!0,node:i.get(),id:i.attr("data-"+t)}},_addImage:function(t){this.add("image",t)},_addFile:function(t){this.add("file",t)}}),m.add("service","utils",{init:function(t){this.app=t},isEmpty:function(t){var e=!1;return e=(t=m.dom(t).get())?3===t.nodeType?""===t.textContent.trim().replace(/\n/,""):""===t.innerHTML:e},isEmptyHtml:function(t,e,i){return t=(t=(t=(t=(t=(t=this.removeInvisibleChars(t)).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,e?"br":"")).replace(/\s/g,"")).replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"")).replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,""),""===(t=(t=(t=(t=(t=(t=(t=i?(t=t.replace(/<ul(.*?[^>])>$/i,"ul")).replace(/<ol(.*?[^>])>$/i,"ol"):t).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).trim())},trimSpaces:function(t){return this.removeInvisibleChars(t.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(t){return t.search(/^\uFEFF$/g)},removeInvisibleChars:function(t){return t.replace(/\uFEFF/g,"")},trimInvisibleChars:function(t){var e,i;this.selection.isCollapsed()&&(i=this.selection.getCurrent(),e="left"===t?this.selection.getTextBeforeCaret():this.selection.getTextAfterCaret(),i&&3===i.nodeType&&0===this.searchInvisibleChars(e)&&("left"===t?m.dom(i).replaceWith(i.textContent.trim()):(i=this.offset.get(),this.offset.set({start:i.start+1,end:i.end+1}))))},buildWrapper:function(t){return m.dom("<div>").html(t)},getWrapperHtml:function(t){var e=t.html();return t.remove(),e},createTmpContainer:function(t){var e=m.dom("<div>");return"string"==typeof t?e.html(t):e.append(m.dom(t).clone(!0)),e.get()},createFragment:function(t){for(var e,i,s=this.createTmpContainer(t),n=document.createDocumentFragment(),o=[],r=0;a=s.firstChild;){r++;var a=n.appendChild(a);1===r&&(e=a),o.push(a),i=a}return{frag:n,first:e,last:i,nodes:o}},isFragment:function(t){return"object"==typeof t&&t.frag},parseHtml:function(t){t=this.createTmpContainer(t);return{html:t.innerHTML,nodes:t.childNodes}},splitNode:function(t,e,i,s){e=this.isFragment(e)?e.frag:e;var n=s?this.inspector.isInlineTag(t.tagName)?t:this.selection.getInline(t):this.inspector.isBlockTag(t.tagName)?t:this.selection.getBlock(t),o=m.dom(n);if(!s&&this.isEmptyHtml(n.innerHTML,!0))return o.after(e),o.remove(),e;var r=o.get().tagName.toLowerCase(),a=this.caret.isEnd(n),t=this.caret.isStart(n);if(a||t||(s=this.extractHtmlFromCaret(s),r=m.dom("<"+r+" />"),r=this.cloneAttributes(n,r),o.after(r.append(s))),t)return o.before(e);if(i)return o.append(e);e=o.after(e);i=o.html();return""===(i=(i=this.removeInvisibleChars(i)).replace(/&nbsp;/gi,""))&&o.remove(),e},extractHtmlFromCaret:function(t,e){var i=this.selection.getRange();if(i&&(e=e||(t?this.selection.getInline():this.selection.getBlock()))){t=i.cloneRange();return t.selectNodeContents(e),t.setStart(i.endContainer,i.endOffset),t.extractContents()}},createMarkup:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),m.dom(t).after(e),this.caret.setStart(e)},createMarkupBefore:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),m.dom(t).before(e),this.caret.setEnd(e)},getNode:function(t){var e=m.dom(t).get(),i=this.editor.getElement().get();return void 0===t?i:e||!1},findSiblings:function(t,e){for(t=m.dom(t).get(),e="next"===e?"nextSibling":"previousSibling";t=t[e];)if((3!==t.nodeType||""!==t.textContent.trim())&&"BR"!==t.tagName)return t;return!1},getElementsFromHtml:function(t,e,i){var s=document.createElement("div");s.innerHTML=t;e=s.querySelectorAll(e);return function(t,e){if("number"==typeof this.length&&"function"==typeof t){var i=[];if("object"==typeof this)for(var s=0;s<this.length;s++){if(!(s in this))return;i[s]=t.call(e||this,this[s],s,this)}return i}}.call(e,function(t){var e=t.getAttribute("data-redactor-type");if(!i||!e||e!==i)return t.outerHTML})},getChildNodes:function(t,e,i){var s=(t=t&&t.nodeType&&11===t.nodeType?t:m.dom(t).get()).childNodes,n=[];if(s)for(var o,r=0;r<s.length;r++)!0===i&&3===s[r].nodeType||3===s[r].nodeType&&this.isEmpty(s[r])||(n.push(s[r]),!1===e||0<(o=this.getChildNodes(s[r],i)).length&&(n=n.concat(o)));return n},getChildElements:function(t){return this.getChildNodes(t,!0,!0)},getFirstNode:function(t){return this._getFirst(this.getChildNodes(t,!1))},getLastNode:function(t){return this._getLast(this.getChildNodes(t,!1))},getFirstElement:function(t){return this._getFirst(this.getChildNodes(t,!1,!0))},getLastElement:function(t){return this._getLast(this.getChildNodes(t,!1,!0))},replaceToTag:function(t,n){return m.dom(t).replaceWith(function(t){var e=m.dom("<"+n+">").append(m.dom(t).contents());if(t.attributes)for(var i=t.attributes,s=0;s<i.length;s++)e.attr(i[s].nodeName,i[s].value);return e})},ucfirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},removeFromArrayByValue:function(t,e){for(var i,s=arguments,n=s.length;1<n&&t.length;)for(e=s[--n];-1!==(i=t.indexOf(e));)t.splice(i,1);return t},removeEmptyAttr:function(t,e){t=m.dom(t);return void 0===t.attr(e)||null===t.attr(e)||""===t.attr(e)&&(t.removeAttr(e),!0)},cloneAttributes:function(t,e){t=m.dom(t).get(),e=m.dom(e);for(var i=t.attributes,s=i.length;s--;){var n=i[s];e.attr(n.name,n.value)}return e},toParams:function(t){if("object"!=typeof t)return t;var e=Object.keys(t);if(!e.length)return"";for(var i="",s=0;s<e.length;s++){var n=e[s];i+=n+":"+t[n]+";"}return i},styleToObj:function(t){var e={};if(t)for(var i=t.replace(/;$/,"").split(";"),s=0;s<i.length;s++){var n=i[s].split(":");e[n[0].trim()]=n[1].trim()}return e},checkProperty:function(t){for(var e=arguments[1]&&Array.isArray(arguments[1])?arguments[1]:[].slice.call(arguments,1),i=0;i<e.length;i++){if(!t||void 0===t[e[i]])return!1;t=t[e[i]]}return t},extendData:function(n,t){for(var e in t)"elements"===e?m.dom(t[e]).each(function(t){var e=m.dom(t);if("FORM"===t.tagName){var i,s=e.serialize(!0);for(i in s)n=this._setData(n,i,s[i])}else{t=e.attr("name")?e.attr("name"):e.attr("id");n=this._setData(n,t,e.val())}}.bind(this)):n=this._setData(n,e,t[e]);return n},_setData:function(t,e,i){return t instanceof FormData?t.append(e,i):t[e]=i,t},normalizeTextNodes:function(t){(t=m.dom(t).get())&&t.normalize()},isRgb:function(t){return 0===t.search(/^rgb/i)},rgb2hex:function(t){return(t=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===t.length?"#"+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""},hex2long:function(t){return t=-1!==t.search(/^#/)&&4===t.length?"#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]:t},escapeRegExp:function(t){return t.replace(/[-\/\\^$*~+?.()|[\]{}]/g,"\\$&")},getRandomId:function(){for(var t="",e="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<12;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},_getFirst:function(t){return 0!==t.length&&t[0]},_getLast:function(t){return 0!==t.length&&t[t.length-1]}}),m.add("service","progress",{init:function(t){this.app=t,this.$box=null,this.$bar=null},show:function(){this._is()||this._build(),this.$box.show()},hide:function(){this._is()&&this.animate.start(this.$box,"fadeOut",this._destroy.bind(this))},update:function(t){this.show(),this.$bar.css("width",t+"%")},_is:function(){return null!==this.$box},_build:function(){this.$bar=m.dom("<span />"),this.$box=m.dom('<div id="redactor-progress" />'),this.$box.append(this.$bar),this.$body.append(this.$box)},_destroy:function(){this._is()&&this.$box.remove(),this.$box=null,this.$bar=null}}),m.add("module","starter",{init:function(t){this.app=t,this.opts=t.opts,this.plugin=t.plugin,this.module=t.module},onstart:function(){this._startStop("start",this.app,["element","container","source","editor","statusbar","toolbar"]),this._startStop("start",this.module,["element","container","source","editor","statusbar","contextbar","input"])},onstop:function(){this._startStop("stop",this.module,["observer","element","container","source","editor","contextbar"])},onenable:function(){var t=this.opts.plugins;this._startStop("start",this.module,["observer","toolbar"]),this._startStop("start",this.plugin,t)},ondisable:function(){var t=this.opts.plugins;this._startStop("stop",this.module,["observer","toolbar"]),this._startStop("stop",this.plugin,t)},_startStop:function(t,e,i){for(var s=0;s<i.length;s++)void 0!==e[i[s]]&&this.app.callInstanceMethod(e[i[s]],t)}}),m.add("module","element",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.namespace=t.namespace,this.element=t.element,this.rootOpts=m.extend({},!0,m.options,t.rootOpts)},start:function(){this._build(),this._buildModes(),this._buildMarkup()},stop:function(){this.element.getElement().removeData(this.namespace+"-uuid")},_build:function(){this.element.getElement().data(this.namespace+"-uuid",this.uuid)},_buildModes:function(){var t=this.element.getType();"inline"===t&&this._redefineOptions(this.opts.modes.inline),"div"===t&&this._redefineOptions(this.opts.modes.original),"inline"!==t&&(this._isRootOption("styles")&&this.rootOpts.styles&&(this.opts.styles=!0),this._isRootOption("source")&&!this.rootOpts.source&&(this.opts.showSource=!1))},_buildMarkup:function(){"inline"===this.element.getType()?this.opts.emptyHtml="":this.opts.breakline?(this.opts.markup="div",this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+"</div>"):this.opts.emptyHtml="<"+this.opts.markup+"></"+this.opts.markup+">"},_redefineOptions:function(t){for(var e in t)this.opts[e]=t[e]},_isRootOption:function(){return void 0!==this.rootOpts.styles}}),m.add("module","editor",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.editor=t.editor,this.source=t.source,this.element=t.element,this.component=t.component,this.container=t.container,this.inspector=t.inspector,this.autoparser=t.autoparser,this.placeholder=!1,this.events=!1},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(t){this.component.setOnEvent(t,!0)},onclick:function(t){this.component.setOnEvent(t)},onkeyup:function(t){this.inspector.parse(t.target).isComponent()||this.component.clearActive()},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build(),this._buildEvents(),this._buildOptions(),this._buildAccesibility()},stop:function(){var t=this.editor.getElement(),e=this.container.getElement(),i=["redactor-in","redactor-in-"+this.uuid,"redactor-structure","redactor-placeholder","notranslate"];""!==this.opts.stylesClass&&i.push(this.opts.stylesClass);t.removeAttr("spellcheck"),t.removeAttr("dir"),t.removeAttr("contenteditable"),t.removeAttr("placeholder"),t.removeAttr("data-gramm_editor"),t.removeClass(i.join(" ")),e.removeClass(["redactor-focus","redactor-blur","redactor-over","redactor-styles-on","redactor-styles-off","redactor-toolbar-on","redactor-text-labeled-on","redactor-source-view"].join(" ")),this._destroyEvents(),0===t.get().classList.length&&t.removeAttr("class")},enable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.addClass("redactor-in redactor-in-"+this.uuid),t.attr({contenteditable:!0}),this.opts.structure&&t.addClass("redactor-structure"),!this.opts.toolbar||this.opts.air||this.opts.toolbarExternal||e.addClass("redactor-toolbar-on"),this._disableBrowsersEditing()},disable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.removeClass("redactor-in redactor-in-"+this.uuid),t.removeClass("redactor-structure"),t.removeAttr("contenteditable"),e.addClass("redactor-toolbar-on")},_build:function(){var t=this.editor.getElement(),e=this.element.getElement(),i=this.container.getElement();i.addClass("redactor-blur"),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.opts.notranslate&&t.addClass("notranslate"),this.opts.styles?(t.addClass(this.opts.stylesClass),i.addClass("redactor-styles-on")):i.addClass("redactor-styles-off"),this.opts.buttonsTextLabeled&&i.addClass("redactor-text-labeled-on"),this.element.isType("textarea")&&e.before(t)},_buildEvents:function(){this.events=m.create("editor.events",this.app)},_buildOptions:function(){var t=this.editor.getElement();t.attr("dir",this.opts.direction),this.opts.spellcheck||t.attr("spellcheck",!1),this.opts.tabindex&&t.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&t.css("min-height",this.opts.minHeight),this.opts.maxHeight&&t.css("max-height",this.opts.maxHeight),this.opts.maxWidth&&t.css({"max-width":this.opts.maxWidth,margin:"auto"})},_buildAccesibility:function(){this.editor.getElement().attr({"aria-labelledby":"redactor-voice-"+this.uuid,role:"presentation"})},_buildPlaceholder:function(){this.placeholder=m.create("editor.placeholder",this.app)},_enableFocus:function(){this.opts.showSource?this._enableFocusSource():this._enableFocusEditor()},_enableFocusSource:function(){var t=this.source.getElement();this.opts.focus?(t.focus(),t.get().setSelectionRange(0,0)):this.opts.focusEnd&&t.focus()},_enableFocusEditor:function(){this.opts.focus?setTimeout(this.editor.startFocus.bind(this.editor),100):this.opts.focusEnd&&setTimeout(this.editor.endFocus.bind(this.editor),100)},_togglePlacehodler:function(){this.placeholder&&this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("AutoUrlDetect",!1,!1);var t=this.editor.getElement().get();t.addEventListener?t.addEventListener("mscontrolselect",function(t){t.preventDefault()}):t.attachEvent("oncontrolselect",function(t){t.returnValue=!1})}catch(t){}},_destroyEvents:function(){this.events&&this.events.destroy()},_enableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).removeAttr("contenteditable"),t.removeAttr("contenteditable"),t.addClass("redactor-read-only"),this.events&&this.events.destroy()},_disableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).attr({contenteditable:!0}),t.removeClass("redactor-read-only"),t.attr({contenteditable:!0}),this._buildEvents()},_getEditables:function(t){return t.find("figcaption, td, th")}}),m.add("class","editor.placeholder",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.element=t.element,this.build()},build:function(){var t=this.element.getElement(),e=this.editor.getElement();!1===this.opts.placeholder&&!t.attr("placeholder")||(t=!1!==this.opts.placeholder?this.opts.placeholder:t.attr("placeholder"),e.attr("placeholder",t),this.toggle())},toggle:function(){return this.editor.isEmpty(!0)?this.show():this.hide()},show:function(){this.editor.getElement().addClass("redactor-placeholder")},hide:function(){this.editor.getElement().removeClass("redactor-placeholder")}}),m.add("class","editor.events",{init:function(t){this.app=t,this.opts=t.opts,this.$doc=t.$doc,this.uuid=t.uuid,this.source=t.source,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection,this.component=t.component,this.blurNamespace=".redactor-blur."+this.uuid,this.eventsList=["paste","click","contextmenu","keydown","keyup","mouseup","touchstart","cut","copy","dragenter","dragstart","drop","dragover","dragleave"],this._init()},destroy:function(){this.editor.getElement().off(".redactor-focus"),this.$doc.off("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace),this._loop("off")},focus:function(t){var e=this.container.getElement();this.editor.isPasting()||e.hasClass("redactor-focus")||(e.addClass("redactor-focus"),e.removeClass("redactor-blur"),this.app.broadcast("observe",t),this.app.broadcast("focus",t),this.isFocused=!0,this.isBlured=!1)},blur:function(t){var e=this.container.getElement(),i=m.dom(t.target),s=[".redactor-in-"+this.uuid,".redactor-toolbar",".redactor-dropdown",".redactor-context-toolbar",".redactor-modal-box","#redactor-image-resizer"];this.app.broadcast("originalblur",t),this.app.stopBlur||this.app.isStarted()&&!this.editor.isPasting()&&0===i.closest(s.join(",")).length&&(this.isBlured||e.hasClass("redactor-blur")||(e.removeClass("redactor-focus"),e.addClass("redactor-blur"),this.app.broadcast("blur",t),this.isFocused=!1,this.isBlured=!0))},cut:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!0),t.preventDefault())},copy:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!1),t.preventDefault())},drop:function(t){if((t=t.originalEvent||t).stopPropagation(),this._removeOverClass(),!1!==this.opts.dragUpload){if(this.app.isDragComponentInside()){var e=m.dom(this.app.getDragComponentInside()),i=e.clone(!0);return this.insertion.insertToPoint(t,i),e.remove(),this.app.setDragComponentInside(!1),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.broadcast("image.observe",t),void t.preventDefault()}if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(t);i=t.dataTransfer.getData("text/html"),e=this.selection.getRange();if(e){var s=this.selection.getBlocks();e.deleteContents();for(var n=0;n<s.length;n++)""===s[n].innerHTML&&m.dom(s[n]).remove()}return m.create("input.paste",this.app,t,!0,i,!0),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.setDragInside(!1),void t.preventDefault()}this.app.broadcast("state",t),this.app.broadcast("paste",t,t.dataTransfer),this.app.broadcast("drop",t)}else t.preventDefault()},dragenter:function(t){t.preventDefault()},dragstart:function(t){this.app.setDragComponentInside(!1),this.app.setDragInside(!1);var e=this.inspector.parse(t.target);!e.isComponent()||e.isComponentEditable()||e.isFigcaption()?this.selection.is()&&!this.selection.isCollapsed()&&(this.app.setDragInside(!0),this._setDragData(t)):this.app.setDragComponentInside(e.getComponent()),this.app.broadcast("dragstart",t)},dragover:function(t){this.app.broadcast("dragover",t)},dragleave:function(t){this.app.broadcast("dragleave",t)},paste:function(t){this.app.broadcast("paste",t)},contextmenu:function(t){},click:function(t){3===t.detail&&(t.preventDefault(),(e=this.selection.getBlock())&&((i=document.createRange()).selectNodeContents(e),this.selection.setRange(i)));var e,i,s=m.dom(t.target);s.hasClass("redactor-in")&&(e=s.offset().top,i=parseFloat(s.css("padding-bottom")),e+s.height()-2*i<t.pageY?this.app.broadcast("bottomclick",t):s.hasClass("redactor-placeholder")&&this.editor.startFocus(this.editor)),this.app.broadcast("state",t),this.app.broadcast("click",t)},keydown:function(t){if(this.app.broadcast("state",t),!1===this.app.broadcast("keydown",t))return t.preventDefault()},keyup:function(t){this.app.broadcast("keyup",t)},mouseup:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},touchstart:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},_init:function(){this.editor.getElement().on("focus.redactor-focus click.redactor-focus",this.focus.bind(this)),this.$doc.on("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace,this.blur.bind(this)),this._loop("on")},_removeOverClass:function(){this.editor.getElement().removeClass("over")},_loop:function(t){for(var e=this.editor.getElement(),i=0;i<this.eventsList.length;i++){var s=this.eventsList[i]+".redactor-events",n=this.eventsList[i];e[t](s,this[n].bind(this))}},_passAllToClipboard:function(t){var e=t.clipboardData,t=this.source.getCode();e.setData("text/html",t),e.setData("text/plain",t.toString().replace(/\n$/,""))},_passSelectionToClipboard:function(t,e,i){var s=t.clipboardData,t=e.getComponent(),e=m.dom(t).clone();e.find(".redactor-component-caret").remove(),e.removeClass("redactor-component-active"),e.removeAttr("contenteditable"),e.removeAttr("tabindex");e=e.get().outerHTML;i&&this.component.remove(t),s.setData("text/html",e),s.setData("text/plain",e.toString().replace(/\n$/,""))},_setDragData:function(t){t=(t=t.originalEvent||t).dataTransfer;t.effectAllowed="move",t.setData("text/Html",this.selection.getHtml())}}),m.add("module","container",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.lang=t.lang,this.element=t.element,this.container=t.container},start:function(){this._build(),this._buildAccesibility()},stop:function(){var t=this.element.getElement(),e=this.container.getElement();e.after(t),e.remove(),t.show()},_build:function(){var t=this.element.getElement(),e=this.container.getElement();e.addClass("redactor-box"),e.attr("dir",this.opts.direction),this.element.isType("inline")&&e.addClass("redactor-inline"),t.after(e),e.append(t)},_buildAccesibility:function(){var t=this.container.getElement(),e=m.dom("<span />");e.addClass("redactor-voice-label"),e.attr({id:"redactor-voice-"+this.uuid,"aria-hidden":!1}),e.html(this.lang.get("accessibility-help-label")),t.prepend(e)}}),m.add("module","source",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.element=t.element,this.source=t.source,this.editor=t.editor,this.toolbar=t.toolbar,this.cleaner=t.cleaner,this.component=t.component,this.container=t.container,this.autoparser=t.autoparser,this.selection=t.selection,this.syncedHtml=""},onstartcode:function(){var t=this.source.getStartedContent(),e=this.editor.getElement(),i=this.source.getElement();this.opts.autoparse&&this.opts.autoparseStart&&(t=this.autoparser.parse(t));var s=this.cleaner.input(t,!0,!0),t=this.cleaner.output(s);e.html(s),i.val(t),this.syncedHtml=t,this.app.broadcast("placeholder.build"),this.app.broadcast("autoparseobserve"),this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},onhardsync:function(){var t=this.editor.getElement().html(),t=this.app.broadcast("syncBefore",t);t=this.cleaner.output(t),this._syncing(t)},start:function(){this._build(),this._buildClasses()},stop:function(){var t=this.element.getElement(),e=this.source.getElement();t.removeClass("redactor-source redactor-source-open"),e.off("input.redactor-source"),e.removeAttr("data-gramm_editor"),0===e.get().classList.length&&e.removeAttr("class"),this.source.isNameGenerated()||t.removeAttr("name"),this.element.isType("textarea")||e.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(this.opts.source)return this.source.getElement().hasClass("redactor-source-open")?this.hide():this.show()},show:function(){var t,e,i,s,n;this.opts.source&&(s=this.editor.getElement(),t=this.source.getElement(),e=this.container.getElement(),n=t.val(),this.app.isStarted()&&(n=this.app.broadcast("source.open",n)),i=s.height(),s.hide(),t.height(i),t.val(n.trim()),t.show(),t.addClass("redactor-source-open"),t.on("input.redactor-source-events",this._onChangedSource.bind(this)),t.on("keydown.redactor-source-events",this._onTabKey.bind(this)),t.on("focus.redactor-source-events",this._onFocus.bind(this)),this.opts.source.hasOwnProperty("codemirror")?(s="object"==typeof this.opts.source.codemirror?this.opts.source.codemirror:{},n=void 0!==this.opts.source.codemirrorSrc?this.opts.source.codemirrorSrc:CodeMirror,this.codemirror=n.fromTextArea(t.get(),s),this.codemirror.setSize(null,i),this.codemirror.on("change",function(t,e){t.save()}),this.codemirror.on("change",this._onChangedSource.bind(this))):e.addClass("redactor-source-view"),setTimeout(function(){this._disableButtons(),this._setActiveSourceButton()}.bind(this),100),this.app.isStarted()&&this.app.broadcast("source.opened"))},hide:function(){var t,e,i,s;this.opts.source&&(t=this.editor.getElement(),e=this.source.getElement(),i=this.container.getElement(),s=e.val(),this.opts.source.hasOwnProperty("codemirror")&&(s=this.codemirror.getValue(),this.codemirror.toTextArea()),s=this.cleaner.input(s,!0),s=this.utils.isEmptyHtml(s)?this.opts.emptyHtml:s,s=this.app.broadcast("source.close",s),this._enableButtons(),this._setInactiveSourceButton(),e.hide(),e.removeClass("redactor-source-open"),e.off(".redactor-source-events"),t.show(),t.html(s),i.removeClass("redactor-source-view"),setTimeout(function(){this.editor.startFocus(),this.component.executeScripts()}.bind(this),0),this.app.broadcast("source.closed"))},sync:function(){var t=this,e=this.editor.getElement().html(),e=this.app.broadcast("syncBefore",e);e=this.cleaner.output(e),this._isSync(e)&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){t._syncing(e)},200))},_build:function(){var t=this.source.getElement(),e=this.element.getElement();t.hide(),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.element.isType("textarea")||e.after(t)},_buildClasses:function(){this.source.getElement().addClass("redactor-source")},_syncing:function(t){t=this.app.broadcast("syncing",t),this.source.getElement().val(t),this.app.broadcast("synced",t),this.app.broadcast("changed",t)},_isSync:function(t){return this.syncedHtml!==t&&(this.syncedHtml=t,!0)},_onChangedSource:function(){var t=this.source.getElement().val();this.app.broadcast("changed",t),this.app.broadcast("source.changed",t)},_onTabKey:function(t){if(9!==t.keyCode)return!0;t.preventDefault();var e=this.source.getElement(),i=e.get(),t=i.selectionStart;e.val(e.val().substring(0,t)+"    "+e.val().substring(i.selectionEnd)),i.selectionStart=i.selectionEnd=t+4},_onFocus:function(){this.app.broadcast("sourcefocus")},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var t=this.toolbar.getButton("html");t.enable(),t.setActive()},_setInactiveSourceButton:function(){this.toolbar.getButton("html").setInactive()}}),m.add("module","observer",{init:function(t){this.app=t,this.editor=t.editor,this.observerUnit=!1},start:function(){var t;window.MutationObserver&&(t=this.editor.getElement().get(),this.observerUnit=this._build(t),this.observerUnit.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0}))},stop:function(){this.observerUnit&&this.observerUnit.disconnect()},_build:function(e){var i=this;return new MutationObserver(function(t){i._observe(t[t.length-1],e)})},_observe:function(t,e){this.app.isReadOnly()||"attributes"===t.type&&t.target===e||(this.app.broadcast("observe"),this.app.broadcast("trytosync"),this.app.broadcast("placeholder.toggle"))}}),m.add("module","clicktoedit",{init:function(t){this.app=t,this.opts=t.opts,this.source=t.source,this.editor=t.editor,this.container=t.container,this.selection=t.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.stop())},ondisablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.start())},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){this.buttonSave&&this.buttonSave.stop(),this.buttonCancel&&this.buttonCancel.stop(),this._destroy(),this.app.broadcast("disable")},enable:function(){this.app.broadcast("clickStart");var t=this.editor.isEmpty();t||this.selection.saveMarkers(),this._setFocus(),this._destroy(),this.app.broadcast("enable"),this.buttonSave.enable(),this.buttonCancel.enable(),t||this.selection.restoreMarkers(),t&&this.editor.focus(),this.container.getElement().addClass("redactor-clicktoedit-enabled"),this.source.rebuildStartedContent(),this.app.broadcast("startcode"),this.app.broadcast("image.observe")},save:function(t){t&&t.preventDefault();t=this.source.getCode();this.app.broadcast("disable"),this.app.broadcast("clickSave",t),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},cancel:function(t){t&&t.preventDefault();t=this.saved;this.editor.getElement().html(t),this.saved="",this.app.broadcast("disable"),this.app.broadcast("clickCancel",t),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},_build:function(){this.buttonSave=m.create("clicktoedit.button","save",this.app,this),this.buttonCancel=m.create("clicktoedit.button","cancel",this.app,this),this.buttonSave.stop(),this.buttonCancel.stop();var t=this.editor.getElement(),e=this.container.getElement();t.on("click.redactor-click-to-edit mouseup.redactor-click-to-edit",this.enable.bind(this)),e.addClass("redactor-over"),e.removeClass("redactor-clicktoedit-enabled")},_isEnabled:function(){return this.container.getElement().hasClass("redactor-clicktoedit-enabled")},_destroy:function(){var t=this.editor.getElement(),e=this.container.getElement();t.off(".redactor-click-to-edit"),e.removeClass("redactor-over redactor-clicktoedit-enabled")},_setFocus:function(){this.saved=this.source.getCode(),this.buttonSave.start(),this.buttonCancel.start()}}),m.add("class","clicktoedit.button",{init:function(t,e,i){this.app=e,this.opts=e.opts,this.toolbar=e.toolbar,this.context=i,this.type=t,this.name="save"===t?"clickToSave":"clickToCancel",this.objected=!1,this.enabled=!1,this.namespace=".redactor-click-to-edit",this._build()},enable:function(){var t;this.objected&&((t=this.opts[this.name]).api="module.clicktoedit."+this.type,this.toolbar.addButton(this.type,t),this.enabled=!0)},start:function(){this.objected||(this.$button.off(this.namespace),this.$button.show(),this.$button.on("click"+this.namespace,this.context[this.type].bind(this.context)))},stop:function(){!this.objected&&this.enabled&&this.$button.hide()},_build:function(){this.objected="object"==typeof this.opts[this.name],this.objected||(this.$button=m.dom(this.opts[this.name]),this.enabled=!0)}}),m.add("module","statusbar",{init:function(t){this.app=t,this.opts=t.opts,this.element=t.element,this.statusbar=t.statusbar,this.container=t.container},start:function(){var t,e;this.element.isType("inline")||(t=this.statusbar.getElement(),e=this.container.getElement(),t.addClass("redactor-statusbar"),e.append(t))}}),m.add("module","contextbar",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body},onstop:function(){this.stop()},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){var t;this.opts.toolbarContext&&(t=this.editor.getElement(),this._build(),t.on("click.redactor-context mouseup.redactor-context",this.open.bind(this)),this.opts.scrollTarget?m.dom(this.opts.scrollTarget).on("scroll.redactor-context",this.close.bind(this)):!1!==this.opts.maxHeight&&t.on("scroll.redactor-context",this.close.bind(this)))},stop:function(){this.editor.getElement().off(".redactor-context"),this.$doc.off(".redactor-context"),this.$win.off(".redactor-context"),this.$contextbar&&this.$contextbar.remove(),this.opts.scrollTarget&&m.dom(this.opts.scrollTarget).off(".redactor-context")},is:function(){return this.$contextbar&&this.$contextbar.hasClass("open")},set:function(t,e,i,s){for(var n in this.$contextbar.html(""),this.$el=m.dom(e),i){n=m.create("contextbar.button",this.app,i[n]);""!==n.html()&&this.$contextbar.append(n)}s=this._buildPosition(t,this.$el,s);this.$contextbar.css(s),this.$contextbar.show(),this.$contextbar.addClass("open"),this.$doc.on("click.redactor-context mouseup.redactor-context",this.close.bind(this)),this.$win.on("resize.redactor-context",this.close.bind(this))},open:function(t){setTimeout(function(){this.app.broadcast("contextbar",t,this)}.bind(this),0)},close:function(t){if(this.$contextbar){if(t){t=m.dom(t.target);if(this.$el&&0!==t.closest(this.$el).length)return}this.$contextbar.hide(),this.$contextbar.removeClass("open"),this.$doc.off(".redactor.context")}},_build:function(){this.$contextbar=m.dom("<div>"),this.$contextbar.attr("id","redactor-context-toolbar-"+this.uuid),this.$contextbar.attr("dir",this.opts.direction),this.$contextbar.addClass("redactor-context-toolbar"),this.$contextbar.hide(),this.$target.append(this.$contextbar)},_buildPosition:function(t,e,i){var s,n,o=this.toolbar.isTarget(),r=o?e.position():e.offset(),a=e.width(),l=e.height(),h=this.$contextbar.width(),c=this.$contextbar.height(),d=o?this.$target.scrollTop()+this.$doc.scrollTop():this.$doc.scrollTop(),u=this.$target.offset(),e=o?u.left:0,u=o?u.top:0;return i?"top"===i?(s=r.top-c,n=r.left+a/2-h/2):"bottom"===i&&(s=r.top+l,n=r.left+a/2-h/2):(s=t.clientY+d-c,n=t.clientX-h/2),{top:s-u+"px",left:(n=n<0?0:n)-e+"px"}}}),m.add("class","contextbar.button",{mixins:["dom"],init:function(t,e){this.app=t,this.obj=e,this._init()},_init:function(){var t;this.parse("<a>"),"string"!=typeof this.obj.title?(t=this.obj.title.attr("href"),this.attr("href",t),-1===t.search(/^#/)&&this.attr("target","_blank"),this.text(this.obj.html||t)):(this.attr("href","#"),this._buildTitle(),this._buildMessage())},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){void 0===this.obj.message&&void 0===this.obj.api||this.on("click",this._toggle.bind(this))},_toggle:function(t){t.preventDefault(),this.obj.message?this.app.broadcast(this.obj.message,this.obj.args):this.obj.api&&this.app.api(this.obj.api,this.obj.args)}}),m.add("module","toolbar",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.toolbar=t.toolbar,this.detector=t.detector,this.buttons=[],this.toolbarModule=!1},onsource:{open:function(){!this.toolbar.isAir()&&this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},opened:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.createSourceHelper(),setTimeout(function(){m.dom(".re-button-tooltip-"+this.uuid).remove()}.bind(this),100)},close:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.destroySourceHelper()},closed:function(){this.toolbar.is()&&this.opts.air&&this.toolbarModule.openSelected()}},ontoolbar:{removeexternal:function(){!this.opts.air&&this.opts.toolbarExternal&&this.opts.clickToEdit&&m.dom(this.opts.toolbarExternal).html("")}},onobserve:function(){this.toolbar.is()&&this.toolbar.observe()},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},onenablereadonly:function(){this.toolbar.isAir()&&this.toolbarModule.close()},start:function(){this.toolbar.is()&&(this._buildButtons(),this._initToolbar(),this._initButtons())},stop:function(){this.toolbarModule&&this.toolbarModule.stop(),m.dom(".re-button-tooltip-"+this.uuid).remove(),m.dom(".redactor-dropdown-"+this.uuid).remove()},_buildButtons:function(){this.buttons=this.opts.buttons.concat(),this._buildImageButton(),this._buildFileButton(),this._buildSourceButton(),this._buildAdditionalButtons(),this._buildHiddenButtons()},_buildImageButton:function(){this.opts.imageUpload||this.opts.imageManagerJson||this.utils.removeFromArrayByValue(this.buttons,"image")},_buildFileButton:function(){this.opts.fileUpload||this.utils.removeFromArrayByValue(this.buttons,"file")},_buildSourceButton:function(){this.opts.source||this.utils.removeFromArrayByValue(this.buttons,"html")},_buildAdditionalButtons:function(){if(0!==this.opts.buttonsAdd.length&&(this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd),this.buttons=this.buttons.concat(this.opts.buttonsAdd)),0!==this.opts.buttonsAddFirst.length&&(this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst),this.buttons.unshift(this.opts.buttonsAddFirst)),!1!==this.opts.buttonsAddAfter)for(var t=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1,e=this.opts.buttonsAddAfter.buttons,i=0;i<e.length;i++)this.buttons.splice(t+i,0,e[i]);if(!1!==this.opts.buttonsAddBefore){t=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1,e=this.opts.buttonsAddBefore.buttons;for(i=0;i<e.length;i++)this.buttons.splice(t-(1-i),0,e[i])}},_buildHiddenButtons:function(){if(0!==this.opts.buttonsHide.length)for(var t=this.opts.buttonsHide,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e]);if(this.detector.isMobile()&&0!==this.opts.buttonsHideOnMobile.length)for(t=this.opts.buttonsHideOnMobile,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e])},_removeExistButtons:function(t){for(var e=0;e<t.length;e++)-1!==this.opts.buttons.indexOf(t[e])&&this.utils.removeFromArrayByValue(t,t[e]);return t},_setExternalOnFocus:function(){!this.opts.air&&this.opts.toolbarExternal&&this.toolbarModule.setExternal()},_initToolbar:function(){this.toolbarModule=this.opts.air?m.create("toolbar.air",this.app):m.create("toolbar.standard",this.app)},_initButtons:function(){this.toolbar.setButtons(this.buttons);for(var t=0;t<this.buttons.length;t++){var e=this.buttons[t];m.buttons[e]&&this.toolbar.addButton(e,m.extend(!0,{},m.buttons[e]),!1,!1,!0)}}}),m.add("class","toolbar.air",{init:function(t){this.app=t,this.uuid=t.uuid,this.$doc=t.$doc,this.$win=t.$win,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.toolbar=t.toolbar,this.container=t.container,this.inspector=t.inspector,this.selection=t.selection,this.clicks=0,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.editor.getElement().off(".redactor-air-trigger-"+this.uuid),this.$doc.off(".redactor-air-"+this.uuid),this.$doc.off(".redactor-air-trigger-"+this.uuid),this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=m.dom("<span>"),this.$airHelper.addClass("redactor-air-helper"),this.$airHelper.html('<i class="re-icon-html"></i>'),this.$airHelper.on("click",function(t){t.preventDefault(),this.app.api("module.source.hide")}.bind(this)),this.container.getElement().append(this.$airHelper)},destroySourceHelper:function(){this.$airHelper&&this.$airHelper.remove()},openSelected:function(){setTimeout(function(){this._isSelection()&&this._open(!1)}.bind(this),0)},close:function(){this.$doc.off(".redactor-air-"+this.uuid);var t=this.toolbar.getElement();t.removeClass("open"),t.hide()},_init:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement(),i=this.editor.getElement(),s=this.container.getElement();t.addClass("redactor-toolbar-wrapper-air"),e.addClass("redactor-air"),e.hide(),t.append(e),s.prepend(t),this.openSelected(),this.$doc.on("mouseup.redactor-air-trigger-"+this.uuid,this._open.bind(this)),i.on("keyup.redactor-air-trigger-"+this.uuid,this._openCmd.bind(this))},_isSelection:function(){return this.selection.is()&&!this.selection.isCollapsed()},_isOpened:function(){return this.toolbar.getElement().hasClass("open")},_open:function(t){var e,i=!!t&&t.target,s=!!t&&m.dom(t.target),n=this.inspector.parse(i),o=n.isComponent()&&!n.isComponentType("table"),r=n.isFigcaption(),i=s&&0!==s.closest(".redactor-modal").length,n=t&&0!==s.closest(".re-button").length;t&&0!==s.closest(".redactor-dropdown").length||n||i||r||o||this.toolbar.isContextBar()||!this._isSelection()||(e=this.selection.getPosition(),setTimeout(function(){this.app.isReadOnly()||this._isSelection()&&this._doOpen(e)}.bind(this),1))},_openCmd:function(){var t,e;this.selection.isAll()&&(t=this.toolbar.getElement(),(e=this.selection.getPosition()).top=e.top<20?0:e.top-t.height(),e.height=0,this._doOpen(e))},_doOpen:function(t){var e=this.toolbar.getWrapper(),i=this.toolbar.getElement(),s=this.container.getElement().offset(),n=0,o=this.$win.width(),r=i.width();o<t.left+r&&(n=r-this.selection.getPosition().width),e.css({left:t.left-s.left-n+"px",top:t.top-s.top+t.height+this.$doc.scrollTop()+"px"}),this.app.broadcast("airOpen"),i.addClass("open"),i.show(),this.$doc.on("click.redactor-air-"+this.uuid,this._close.bind(this)),this.$doc.on("keydown.redactor-air-"+this.uuid,this._close.bind(this)),this.app.broadcast("airOpened")},_close:function(t){var e=!!t&&m.dom(t.target),i=t&&0!==e.closest("[data-dropdown], .redactor-dropdown-not-close").length;(!i&&t&&0!==e.closest(".re-button").length||!i&&this._isOpened())&&(this.app.broadcast("airClose"),this.close(),this.app.broadcast("airClosed"))}}),m.add("class","toolbar.fixed",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$doc=t.$doc,this.$win=t.$win,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.container=t.container,this._init()},stop:function(){this.$fixedTarget.off(".redactor-toolbar-"+this.uuid),this.$win.off(".redactor-toolbar-"+this.uuid)},reset:function(){var t=this.toolbar.getElement();this.toolbar.getWrapper().css("height",""),t.removeClass("redactor-toolbar-fixed"),t.css({position:"",top:"",left:"",width:""});t=this.toolbar.getDropdown();t&&t.updatePosition()},_init:function(){this.$fixedTarget=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$win,this._doFixed(),this.toolbar.isTarget()&&(this.$win.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$win.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))),this.$fixedTarget.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$fixedTarget.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))},_doFixed:function(){var t,e,i,s,n,o=this.editor.getElement(),r=this.container.getElement(),a=this.toolbar.getElement(),l=this.toolbar.getWrapper();this.editor.isSourceMode()||0===r.parents().filter(function(t){return"none"===getComputedStyle(t,null).display&&t}).length&&(s=o.height()<100,i=this.editor.isEmpty(),s||i?this.reset():this.editor.isSourceMode()||(t=a.height(),n=(e=(this.toolbar.isTarget()?r.position():r.offset()).top)+r.height()-60,o=this.$fixedTarget.scrollTop()+this.opts.toolbarFixedTopOffset,s=this.toolbar.isTarget()?this.$fixedTarget.offset().top-this.$win.scrollTop():0,this.toolbar.isTarget()&&"fixed"===this.$fixedTarget.css("position")&&(i=this.$fixedTarget.hasClass("modal")&&this.$fixedTarget.hasClass("fade")?r.closest(".modal-dialog").position().top:0,s=this.$fixedTarget.scrollTop()-i),e<o&&o<n?(n=this.detector.isDesktop()?"fixed":"absolute",s=this.detector.isDesktop()?s:o-e,this.detector.isMobile()&&(this.fixedScrollTimeout&&clearTimeout(this.fixedScrollTimeout),a.hide(),this.fixedScrollTimeout=setTimeout(function(){a.show()},250)),l.height(t),a.addClass("redactor-toolbar-fixed"),r.hasClass("redactor-box-fullscreen")?a.css({position:n,top:"0px",width:r.width()+"px"}):a.css({position:n,top:s+this.opts.toolbarFixedTopOffset+"px",width:r.width()+"px"}),(r=this.toolbar.getDropdown())&&r.updatePosition(),this.app.broadcast("toolbar.fixed")):(this.reset(),this.app.broadcast("toolbar.unfixed"))))}}),m.add("class","toolbar.standard",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$body=t.$body,this.toolbar=t.toolbar,this.container=t.container,this.isExternalMultiple=!1,this.toolbarFixed=!1,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.toolbarFixed&&this.toolbarFixed.stop(),this.opts.toolbarExternal&&this._findToolbars(),this.toolbar.stopObservers(),this.$body.find(".re-button-tooltip-"+this.uuid).remove()},setExternal:function(){this._findToolbars(),this.isExternalMultiple&&(this.$toolbars.hide(),this.$external.find(".redactor-toolbar-external-"+this.uuid).show())},resetPosition:function(){this.toolbarFixed&&this.toolbarFixed.reset()},_init:function(){this._build(),this.opts.toolbarExternal?this._buildExternal():(this._buildFixed(),this.toolbar.getElement().show())},_build:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-wrapper"),e.addClass("redactor-toolbar"),e.hide(),t.append(e),this.opts.toolbarExternal||this.container.getElement().prepend(t)},_buildExternal:function(){this._initExternal(),this._findToolbars(),this.isExternalMultiple?this._hideToolbarsExceptFirst():this.toolbar.getElement().show()},_buildFixed:function(){this.opts.toolbarFixed&&(this.toolbarFixed=m.create("toolbar.fixed",this.app))},_initExternal:function(){var t=this.toolbar.getElement(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-external redactor-toolbar-external-"+this.uuid),this.$external=m.dom(this.opts.toolbarExternal),this.$external.append(e)},_findToolbars:function(){this.$toolbars=this.$external.find(".redactor-toolbar-external"),this.isExternalMultiple=1<this.$toolbars.length},_hideToolbarsExceptFirst:function(){this.$toolbars.hide(),this.$toolbars.first().show()}}),m.add("module","line",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion},oncontextbar:function(t,e){var i,s=this.inspector.parse(t.target);s.isComponentType("line")&&(i=s.getComponent(),s={remove:{title:this.lang.get("delete"),api:"module.line.remove",args:i}},e.set(t,i,s,"bottom"))},insert:function(){var t=this.component.create("line");this.insertion.insertRaw(t)},remove:function(t){this.component.remove(t)}}),m.add("class","line.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e,i,s;void 0!==t&&("HR"===(t=(s=m.dom(t)).get()).tagName?i=t:"FIGURE"===t.tagName&&(e=t,i=s.find("hr").get())),this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_buildElement:function(t){t?this.$element=m.dom(t):(this.$element=m.dom("<hr>"),this.append(this.$element))},_buildWrapper:function(t){this.parse(t=t||"<figure>")},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"line",tabindex:"-1",contenteditable:!1})}}),m.add("module","link",{modals:{link:'<form action="">                 <div class="form-item">                     <label for="modal-link-url">URL <span class="req">*</span></label>                     <input type="text" id="modal-link-url" name="url">                 </div>                 <div class="form-item">                     <label for="modal-link-text">## text ##</label>                     <input type="text" id="modal-link-text" name="text">                 </div>                 <div class="form-item form-item-title">                     <label for="modal-link-title">## title ##</label>                     <input type="text" id="modal-link-title" name="title">                 </div>                 <div class="form-item form-item-target">                     <label class="checkbox">                         <input type="checkbox" name="target"> ## link-in-new-tab ##                     </label>                 </div>             </form>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.inline=t.inline,this.editor=t.editor,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.isCurrentLink=!1,this.currentText=!1},onmodal:{link:{open:function(t,e){this._setFormData(e,t)},opened:function(t,e){this._setFormFocus(e)},update:function(t,e){var i=e.getData();this._validateData(e,i)&&this._update(i)},insert:function(t,e){var i=e.getData();this._validateData(e,i)&&this._insert(i)},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(t){this._observeButton(t)}}},ondropdown:{link:{observe:function(t){this._observeUnlink(t),this._observeEdit(t)}}},oncontextbar:function(t,e){var i,s=this._getCurrent(),n=this.inspector.parse(s);(n.isLink()||n.isFile())&&(i=n.isFile()?n.getFile():n.getLink(),s=m.dom(i),n=m.dom("<a>"),s=s.attr("href"),n.text(this._truncateText(s)),n.attr("href",s),n.attr("target","_blank"),s={link:{title:n,html:this._truncateText(s)},edit:{title:this.lang.get("edit"),api:"module.link.open"},unlink:{title:this.lang.get("unlink"),api:"module.link.unlink"}},e.set(t,i,s,"bottom"))},open:function(){this.$link=this._buildCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},update:function(t){this._update(t)},unlink:function(){this._unlink()},_observeButton:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e);e.isPre()||e.isCode()?t.disable():t.enable()},_observeUnlink:function(t){t=t.getItem("unlink");0===this._getLinks().length?t.disable():t.enable()},_observeEdit:function(t){var e=this._getCurrent(),t=t.getItem("link"),e=this.inspector.parse(e),e=e.isLink()||e.isFile()?this.lang.get("link-edit"):this.lang.get("link-insert");t.setTitle(e)},_unlink:function(){this.app.api("module.modal.close");var t=[],e=this._getLinks();this.selection.save();for(var i=0;i<e.length;i++){var s=m.create("link.component",this.app,e[i]);t.push(this.selection.getElement(e[i])),s.unwrap(),this.app.broadcast("link.deleted",s)}this.selection.restore();for(i=0;i<t.length;i++){var n=t[i]||this.editor.getElement();this.utils.normalizeTextNodes(n)}this._resetCurrent()},_update:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._setLinkData(e,t,"updated"),this._resetCurrent(),this.app.broadcast("link.changed",e)},_insert:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._insertSingle(e,t)||(this._removeInSelection(e),this._insertMultiple(t)),this._resetCurrent()},_removeInSelection:function(t){this.selection.save();for(var e=0;e<t.length;e++){var i=m.create("link.component",this.app,t[e]),s=i.clone();i.unwrap(),this.app.broadcast("link.deleted",s)}this.selection.restore()},_insertMultiple:function(t){var e=this.selection.getRange();e&&this._isCurrentTextChanged(t)&&this._deleteContents(e);e=this.inline.format({tag:"a"});this._setLinkData(e,t,"inserted")},_insertSingle:function(t,e){var i=this.selection.getInline();if(1===t.length&&(t[0].textContext===this.selection.getText()||i&&"A"===i.tagName)){t=m.create("link.component",this.app,t[0]);return t.setData(e),this.caret.setAfter(t),this.app.broadcast("link.inserted",t),!0}return!1},_setLinkData:function(t,e,i){e.text=""===e.text.trim()?this._truncateText(e.url):e.text;var s=!this.currentText||this.currentText!==e.text;this.selection.save();for(var n=0;n<t.length;n++){var o=m.create("link.component",this.app,t[n]),r={};e.text&&s&&(r.text=e.text),e.url&&(r.url=e.url),void 0!==e.title&&(r.title=e.title),void 0!==e.target&&(r.target=e.target),o.setData(r),this.app.broadcast("link."+i,o)}setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(t){var e=this.selection.getHtml(),e=this.utils.parseHtml(e).nodes[0];e&&3!==e.nodeType?(e=e.tagName.toLowerCase(),e=document.createElement(e),this.insertion.insertNode(e,"start")):t.deleteContents()},_getModalData:function(){var t=this._isLink()?{update:{title:this.lang.get("save")},unlink:{title:this.lang.get("unlink"),type:"danger"},cancel:{title:this.lang.get("cancel")}}:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}};return{name:"link",title:this._isLink()?this.lang.get("link-edit"):this.lang.get("link-insert"),handle:this._isLink()?"update":"insert",commands:t}},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(t){return this.currentText&&this.currentText!==t.text},_buildCurrent:function(){var t,e=this._getCurrent(),e=this.inspector.parse(e);return e.isLink()||e.isFile()?(this.currentLink=!0,t=e.isFile()?e.getFile():e.getLink(),t=m.create("link.component",this.app,t)):(this.currentLink=!1,t=m.create("link.component",this.app),e={text:this.selection.getText()},t.setData(e)),t},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:["a"]})[0]},_getLinks:function(){for(var t=this.selection.getInlines({all:!0,tags:["a"]}),e=[],i=0;i<t.length;i++){var s=this.inspector.parse(t[i]);(s.isLink()||s.isFile())&&e.push(t[i])}return e},_resetCurrent:function(){this.isCurrentLink=!1,this.currentText=!1},_truncateText:function(t){return t&&t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t},_validateData:function(t,e){return""!==e.url.trim()||t.setError("url")},_setFormFocus:function(t){t.getField("url").focus()},_setFormData:function(t,e){var i=this.$link.getData(),i={url:i.url,text:i.text,title:i.title,target:this.opts.linkTarget||i.target};this.opts.linkNewTab||e.find(".form-item-target").hide(),this.opts.linkTitle||e.find(".form-item-title").hide(),t.setData(i),this.currentText=t.getField("text").val()}}),m.add("class","link.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["url","text","target","title"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},_init:function(t){var e=m.dom(t);void 0===t?this.parse("<a>"):this.parse(e)},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_get_target:function(){return!!this.attr("target")&&this.attr("target")},_get_url:function(){return this.attr("href")},_get_title:function(){return this.attr("title")},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(t){!1===t?this.removeAttr("target"):t&&this.attr("target",!0===t?"_blank":t)},_set_text:function(t){t=this._escapeHtml(t),this._getContext().html(t)},_set_title:function(t){t&&""!==t?this.attr("title",t):this.removeAttr("title")},_set_url:function(t){this.opts.linkValidation&&(t=this._cleanUrl(t),this._isMailto(t)?t="mailto:"+t.replace("mailto:",""):this._isUrl(t)&&-1===t.search(/^(ftp|https?)/i)&&(t="http://"+t.replace(/(ftp|https?):\/\//i,""))),this.attr("href",t)},_isMailto:function(t){return-1!==t.search("@")&&!1===/(ftp|https?):\/\//i.test(t)},_isUrl:function(t){return this.reUrl.test(t)},_cleanUrl:function(t){return(t=this._escapeHtml(t)).trim().replace(/[^\W\w\D\d+&\'@#/%?=~_|!:,.;\(\)]/gi,"")},_escapeHtml:function(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},_findDeepestChild:function(i){var s={depth:0,element:i};return i.children().each(function(t){var e=m.dom(t);t.outerHTML!==i.html()||(e=this._findDeepestChild(e)).depth+1>s.depth&&(s={depth:1+e.depth,element:e.element})}.bind(this)),s}}),m.add("module","modal",{init:function(t){this.app=t,this.uuid=t.uuid,this.lang=t.lang,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.detector=t.detector,this.selection=t.selection,this.$box=!1,this.$modal=!1,this.selectionMarkers=!1,this.defaults={name:!1,url:!1,title:!1,width:"600px",height:!1,handle:!1,commands:!1}},build:function(t){this._open(t)},close:function(){this._close()},onstop:function(){this.$body.find("#redactor-modal-"+this.uuid).remove(),this.$body.find("#redactor-overlay-"+this.uuid).remove()},stop:function(){this.$box&&(this.$box.remove(),this.$box=!1,this.$modal=!1),this.$overlay&&this.$overlay.remove(),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal")},resize:function(){this.$modal.setWidth(this.p.width),this.$modal.updatePosition()},_isOpened:function(){return this.$modal&&this.$modal.hasClass("open")},_open:function(t){this._buildDefaults(t),this.p.url?this._openUrl():this._openTemplate()},_openUrl:function(){m.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){var t;void 0!==m.modals[this.p.name]&&(t=this.lang.parse(m.modals[this.p.name]),this._doOpen(t))},_doOpen:function(t){this.stop(),this.selection.isCollapsed()?(this.selection.save(),this.selectionMarkers=!1):(this.selection.saveMarkers(),this.selectionMarkers=!0),this.detector.isDesktop()||document.activeElement.blur(),this._createModal(t),this._buildModalBox(),this._buildOverlay(),this._buildModal(),this._buildModalForm(),this._buildModalCommands(),this._broadcast("open"),this.$modal.updatePosition(),this._buildModalTabs(),this.animate.start(this.$box,"fadeIn",this._opened.bind(this)),this.animate.start(this.$overlay,"fadeIn")},_opened:function(){this.$modal.addClass("open"),this.$box.on("mousedown.redactor.modal",this._close.bind(this)),this.$doc.on("keyup.redactor.modal",this._handleEscape.bind(this)),this.$win.on("resize.redactor.modal",this.resize.bind(this)),this.$modal.getBody().find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor.modal",this._handleEnter.bind(this)),window.jQuery&&window.jQuery(document).off("focusin.modal"),this._broadcast("opened")},_close:function(t){if(this.$box&&this._isOpened()){if(t){if(!this._needToClose(t.target))return;t.stopPropagation(),t.preventDefault()}this.selectionMarkers?this.selection.restoreMarkers():this.selection.restore(),this.selectionMarkers=!1,this._broadcast("close"),this.animate.start(this.$box,"fadeOut",this._closed.bind(this)),this.animate.start(this.$overlay,"fadeOut")}},_closed:function(){this.$modal.removeClass("open"),this.$box.off(".redactor.modal"),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal"),this._broadcast("closed")},_createModal:function(t){this.$modal=m.create("modal.element",this.app,t)},_broadcast:function(t){this.app.broadcast("modal."+t,this.$modal,this.$modalForm),this.app.broadcast("modal."+this.p.name+"."+t,this.$modal,this.$modalForm)},_buildDefaults:function(t){this.p=m.extend({},this.defaults,t)},_buildModalBox:function(){this.$box=m.dom("<div>"),this.$box.attr("id","redactor-modal-"+this.uuid),this.$box.addClass("redactor-modal-box redactor-animate-hide"),this.$box.html(""),this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=m.dom("#redactor-overlay-"+this.uuid),0===this.$overlay.length&&(this.$overlay=m.dom("<div>"),this.$overlay.attr("id","redactor-overlay-"+this.uuid),this.$overlay.addClass("redactor-overlay redactor-animate-hide"),this.$body.prepend(this.$overlay))},_buildModal:function(){this.$box.append(this.$modal),this.$modal.setTitle(this.p.title),this.$modal.setHeight(this.p.height),this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){if(this.p.commands){var t,e=this.p.commands,i=this.$modal.getFooter();for(t in e){var s=m.dom("<button>");s.html(e[t].title),s.attr("data-command",t),"cancel"===t&&(s.attr("data-action","close"),s.addClass("redactor-button-unstyled")),void 0!==e[t].type&&"danger"===e[t].type&&s.addClass("redactor-button-danger"),s.on("click",this._handleCommand.bind(this)),i.append(s)}}},_buildModalTabs:function(){var t=this.$modal.getBody(),e=t.find(".redactor-modal-tab"),s=t.find(".redactor-modal-tabs");1<e.length&&((s=0===s.length?m.dom("<div>"):s.html("")).addClass("redactor-modal-tabs"),e.each(function(t,e){var i=m.dom(t),t=m.dom("<a>");t.attr("href","#"),t.attr("rel",e),t.text(i.attr("data-title")),t.on("click",this._showTab.bind(this)),0===e&&t.addClass("active"),s.append(t)}.bind(this)),t.prepend(s)),1===e.length&&e.show()},_buildModalForm:function(){this.$modalForm=m.create("modal.form",this.app,this.$modal.getForm())},_showTab:function(t){t.preventDefault();var e=m.dom(t.target),i=e.attr("rel"),s=this.$modal.getBody(),t=s.find(".redactor-modal-tab");t.hide(),t.eq(i).show(),s.find(".redactor-modal-tabs a").removeClass("active"),e.addClass("active")},_needToClose:function(t){var e=m.dom(t);return!("close"!==e.attr("data-action")&&!this.$modal.isCloseNode(t)&&0!==e.closest(".redactor-modal").length)},_handleCommand:function(t){var e=m.dom(t.target).closest("button").attr("data-command");"cancel"!==e&&t.preventDefault(),this._broadcast(e)},_handleEnter:function(t){13===t.which&&this.p.handle&&(t.preventDefault(),this._broadcast(this.p.handle))},_handleEscape:function(t){27===t.which&&this._close()}}),m.add("class","modal.element",{mixins:["dom"],init:function(t,e){this.app=t,this.opts=t.opts,this.$win=t.$win,this._init(e)},getForm:function(){return this.find("form")},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(t){t&&this.$modalHeader.html(t)},setWidth:function(t){t=parseInt(t)>=this.$win.width()?"96%":t,this.css("max-width",t)},setHeight:function(t){!1!==t&&this.$modalBody.css("height",t)},updatePosition:function(){var t=this.width();this.css({left:"50%","margin-left":"-"+t/2+"px"});var e=this.$win.height(),i=this.height(),t=e/2-i/2;i<e&&0!=t&&this.css("margin-top",t+"px")},isCloseNode:function(t){return t===this.$modalClose.get()},_init:function(t){this._build(),this._buildClose(),this._buildHeader(),this._buildBody(),this._buildFooter(),this._buildTemplate(t)},_build:function(){this.parse("<div>"),this.addClass("redactor-modal"),this.attr("dir",this.opts.direction)},_buildClose:function(){this.$modalClose=m.dom("<span>"),this.$modalClose.addClass("redactor-close"),this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=m.dom("<div>"),this.$modalHeader.addClass("redactor-modal-header"),this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=m.dom("<div>"),this.$modalBody.addClass("redactor-modal-body"),this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=m.dom("<div>"),this.$modalFooter.addClass("redactor-modal-footer"),this.append(this.$modalFooter)},_buildTemplate:function(t){this.$modalBody.html(t)}}),m.add("class","modal.form",{mixins:["dom"],init:function(t,e){this.app=t,this.build(e)},build:function(t){this.parse(t)},getData:function(){var e={};return this.find("[name]").each(function(t){t=m.dom(t);e[t.attr("name")]=t.val()}),e},setData:function(s){this.find("[name]").each(function(t){var e=m.dom(t),i=e.attr("name");s.hasOwnProperty(i)&&(t.type&&"checkbox"===t.type?t.checked=s[i]:e.val(s[i]))})},getField:function(t){return this.find("[name="+t+"]")},setError:function(t){t=this.getField(t);return t.addClass("error"),t.one(this._getFieldEventName(t.get()),this._clearError),!1},_clearError:function(){return m.dom(this).removeClass("error")},_getFieldEventName:function(t){return"SELECT"===t.tagName||"checkbox"===t.type||"radio"===t.type?"change":"keyup"}}),m.add("module","block",{init:function(t){this.app=t,this.block=t.block},format:function(t){t=this.block.format(t);this.app.broadcast("format","block",t)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(t,e){this.block.add(t,e)},toggle:function(t,e){this.block.toggle(t,e)},set:function(t,e){this.block.set(t,e)},remove:function(t,e){this.block.remove(t,e)}}),m.add("module","inline",{init:function(t){this.app=t,this.inline=t.inline},format:function(t){t=this.inline.format(t);this.app.broadcast("format","inline",t)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(t,e){this.inline.add(t,e)},toggle:function(t,e){this.inline.toggle(t,e)},set:function(t,e){this.inline.set(t,e)},remove:function(t,e){this.inline.remove(t,e)}}),m.add("module","autosave",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.source=t.source},onsynced:function(){this.opts.autosave&&this._send()},_send:function(){var e=this.opts.autosaveName||this.source.getName(),i={};i[e]=this.source.getCode(),i=this.utils.extendData(i,this.opts.autosaveData),m.ajax.request(this.opts.autosaveMethod,{url:this.opts.autosave,data:i,success:function(t){this._complete(t,e,i)}.bind(this)})},_complete:function(t,e,i){var s=t&&t.error?"autosaveError":"autosave";this.app.broadcast(s,e,i,t)}}),m.add("module","input",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.keycodes=t.keycodes,this.element=t.element,this.selection=t.selection,this.insertion=t.insertion,this.inspector=t.inspector,this.autoparser=t.autoparser,this.lastShiftKey=!1},onpaste:function(t,e){if(this.opts.input)return m.create("input.paste",this.app,t,e)},onkeydown:function(t){if(this.opts.input){var e=t.which;if(!m.create("input.shortcut",this.app,t).is()){if((t.ctrlKey||t.metaKey)&&!t.altKey&&65===e)return t.preventDefault(),this._selectAll();var i=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE],s=[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.LEFT,this.keycodes.RIGHT],n=-1!==i.indexOf(e),o=-1!==s.indexOf(e),i=(t.ctrlKey||t.metaKey)&&88===e,s=!t.ctrlKey&&!t.metaKey&&(48<=e&&e<=57||65<=e&&e<=90);if(this.selection.isAll()&&o&&(i||!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey)){if(i)return this.editor.disableNonEditables(),void this.app.broadcast("empty");if(this._isArrowKey(e))return!0;if(n&&t.preventDefault(),this.element.isType("inline")?(this.editor.getElement().html(""),this.editor.startFocus()):this.insertion.set(this.opts.emptyHtml),n)return;this.app.broadcast("empty")}if(this.opts.autoparse&&this.autoparser.format(t,e),!s||!this.selection.hasNonEditable())return e===this.keycodes.ENTER?m.create("input.enter",this.app,t,e):t.metaKey&&219===e?(t.preventDefault(),void this.app.api("module.list.outdent")):e===this.keycodes.TAB||t.metaKey&&221===e?m.create("input.tab",this.app,t,e):e===this.keycodes.SPACE?m.create("input.space",this.app,t,e,this.lastShiftKey):this._isDeleteKey(e)?m.create("input.delete",this.app,t,e):this._isArrowKey(e)?m.create("input.arrow",this.app,t,e):void 0;t.preventDefault()}}},onkeyup:function(t){if(this.opts.input){var e=t.which;if(this.lastShiftKey=t.shiftKey,this.app.broadcast("contextbar.close"),!m.create("input.shortcode",this.app,t,e).is()){if(e===this.keycodes.BACKSPACE){e=this.editor.getElement(),e=this.utils.trimSpaces(e.html());if(""===(e=(e=e.replace(/<br\s?\/?>/g,"")).replace(/<div><\/div>/,"")))return t.preventDefault(),this.editor.setEmpty(),void this.editor.startFocus()}this.editor.isEmpty()&&this.app.broadcast("empty")}}},start:function(){this.opts.shortcutsAdd&&(this.opts.shortcuts=m.extend({},!0,this.opts.shortcuts,this.opts.shortcutsAdd))},_selectAll:function(){var t,e=this.selection.getCurrent(),e=this.inspector.parse(e);return e.isComponentType("table")?(t=e.getTable(),void this.selection.setAll(t)):e.isComponentType("code")?(t=e.getComponentCodeElement(),void this.selection.setAll(t)):void this.selection.setAll()},_isArrowKey:function(t){return-1!==[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(t)},_isDeleteKey:function(t){return t===this.keycodes.BACKSPACE||t===this.keycodes.DELETE}}),m.add("class","input.arrow",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.offset=t.offset,this.marker=t.marker,this.editor=t.editor,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.key=i,this._init(e)},_init:function(t){if(!this._isRightLeftKey()||!this._isExitVariable(t)){if(this._isRightDownKey()){if(this._isExitOnDownRight(t))return;if(this._selectComponent(t,"End","next"))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(t))return;if(this._selectComponent(t,"Start","prev"))return}this.key===this.keycodes.LEFT?this.utils.trimInvisibleChars("left"):this.key===this.keycodes.RIGHT&&this.utils.trimInvisibleChars("right")}},_isRightDownKey:function(){return-1!==[this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)},_isLeftUpKey:function(){return-1!==[this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)},_isRightLeftKey:function(){return-1!==[this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)},_isExitVariable:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),e=i.getComponent();i.isComponentType("variable")&&i.isComponentActive()&&(t.preventDefault(),t=this.key===this.keycodes.LEFT?"setBefore":"setAfter",this.caret[t](e))},_isExitOnUpLeft:function(t){var e=this.selection.getCurrent(),i=this.selection.getBlock(e),s=this.inspector.parse(e),n=i.previousElementSibling;if((e=this.caret.isStart(i))&&n&&"TABLE"===n.tagName)return t.preventDefault(),this.caret.setEnd(n),!0;if(s.isFigcaption()){i=s.getFigcaption(),e=this.caret.isStart(i),n=m.dom(i).closest(".redactor-component");if(e&&0!==n.length)return t.preventDefault(),this.caret.setEnd(n),!0}else{if(s.isTable()&&e)return t.preventDefault(),this.caret.setEnd(i.previousElementSibling),!0;if(!s.isComponentEditable()&&s.isComponent()&&!s.isComponentType("variable")){i=s.getComponent();return i.previousElementSibling?i.previousElementSibling?(t.preventDefault(),this.component.clearActive(),this.caret.setEnd(i.previousElementSibling),!0):void 0:(t.preventDefault(),this.component.clearActive(),this._exitPrevElement(t,s.getComponent()))}}},_isExitOnDownRight:function(t){var e,i=this.editor.getElement(),s=this.selection.getCurrent(),n=this.inspector.parse(s),o=this.caret.isEnd();if(n.isTable()){if(e=n.getTable(),(l=this.caret.isEnd(e))||o)return this._exitNextElement(t,n.getComponent())}else if(n.isFigcaption()){if(e=n.getFigcaption(),(l=this.caret.isEnd(e))||o)return this._exitNextElement(t,n.getComponent())}else if(n.isComponentType("code")){var r=n.getComponent(),a=m.dom(n.getComponentCodeElement()).closest("pre"),l=this.caret.isEnd(e),a=a&&a.get().nextElementSibling;if(l&&!a)return this._exitNextElement(t,r)}else if(n.isPre()||n.isBlockquote()||n.isDl()){if(o)return n.isPre()?this._exitNextElement(t,n.getPre()):n.isBlockquote()?this._exitNextElement(t,n.getBlockquote()):n.isDl()?this._exitNextElement(t,n.getDl()):void 0}else if(n.isList()){i=m.dom(s).parents("ul, ol",i).last();if((l=this.caret.isEnd(i))||o)return this._exitNextElement(t,i.get())}else if(n.isComponent()&&!n.isComponentType("variable")&&"span"!==n.getTag())return this.component.clearActive(),this._exitNextElement(t,n.getComponent())},_exitPrevElement:function(t,e){return t.preventDefault(),e.previousElementSibling?this.caret.setEnd(e.previousElementSibling):this.utils.createMarkupBefore(e),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextElementSibling?this.caret.setStart(e.nextElementSibling):this.utils.createMarkup(e),!0},_selectComponent:function(t,e,i){var s=this.selection.getCurrent(),n=this.selection.getBlock(s),o=this.utils.findSiblings(s,i),i=this.utils.findSiblings(n,i);o&&this.caret["is"+e](s)?this._selectComponentItem(t,o,e):i&&this.caret["is"+e](n)&&this._selectComponentItem(t,i,e)},_selectComponentItem:function(t,e,i){if(this.component.isNonEditable(e))return t.preventDefault(),this.caret["set"+i](e),!0}}),m.add("class","input.delete",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.marker=t.marker,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.insertion=t.insertion,this.key=i,this._init(e)},_init:function(t){if(!this._removeActiveComponent(t)&&!this._removeAllSelectedTable(t)){if(this.key===this.keycodes.BACKSPACE){var e=this.editor.getElement();if(this.utils.trimSpaces(e.html())===this.opts.emptyHtml)return void t.preventDefault()}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable())t.preventDefault();else{if(this.selection.isAll())return t.preventDefault(),void this.insertion.set(this.opts.emptyHtml);this.selection.isCollapsed()&&(this.key===this.keycodes.BACKSPACE?this._traverseBackspace(t):this.key===this.keycodes.DELETE&&this._traverseDelete(t)),this.key===this.keycodes.BACKSPACE&&this.utils.trimInvisibleChars("left"),this._removeUnwantedStyles(),this._removeEmptySpans(),this._removeSpanTagsInHeadings(),this._removeInlineTagsInPre()}}},_detectVariableOrNonEditable:function(){var t,e=this.selection.getBlock(),i=this.caret.isStart(e),s=this.caret.isEnd(e);if(this.key===this.keycodes.BACKSPACE&&i){if(t=e.previousSibling,this._isNonEditable(t))return!0}else if(this.key===this.keycodes.DELETE&&s&&(t=e.nextSibling,this._isNonEditable(t)))return!0;var n=this.selection.getCurrent(),o=this.caret.isStart(n),i=this.caret.isEnd(n),s=""===this.selection.getTextBeforeCaret().trim(),e=""===this.selection.getTextAfterCaret().trim();return this.key===this.keycodes.BACKSPACE&&o&&!s?(t=n.previousSibling,this._isVariable(t)?(this.caret.setEnd(t),!0):!!this._isNonEditable(t)||void 0):this.key===this.keycodes.DELETE&&i&&!e?(t=n.nextSibling,this._isVariable(t)?(this.caret.setStart(t),!0):!!this._isNonEditable(t)||void 0):void 0},_isVariable:function(t){return 0!==m.dom(t).closest('[data-redactor-type="variable"]').length},_isNonEditable:function(t){return 0!==m.dom(t).closest(".non-editable").length},_getBlock:function(){var t=this.editor.getElement(),e=this.selection.getBlock(),i=this.inspector.parse(e),e=i.isList()?m.dom(e).parents("ul, ol",t).last().get():e;return e=i.isDl()?i.getDl():e,e=i.isTable()?i.getTable():e},_traverseDelete:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);if(i.isFigcaption()){if(l=i.getFigcaption(),s=this.caret.isEnd(l))return void t.preventDefault()}else if(i.isComponentType("code")&&(l=i.getComponent(),s=this.caret.isEnd(l)))return void t.preventDefault();var s,n,o,r,a,l=this._getBlock(),h=this.utils.findSiblings(l,"next");h&&(s=this.caret.isEnd(l),r=this.inspector.parse(h),n="P"===h.tagName||"DIV"===h.tagName,s&&r.isComponentType("table")?(t.preventDefault(),this.caret.setStart(h)):s&&r.isComponentEditable()?(t.preventDefault(),this.component.remove(h,!1)):s&&r.isComponent()?(t.preventDefault(),this.caret.setStart(h),this.utils.isEmptyHtml(l.innerHTML)&&m.dom(l).remove()):s&&r.isList()?(o=m.dom(l),a=m.dom(h),i.isList()?(t.preventDefault(),o.append(a),a.unwrap()):0!==(r=(e=a.children("li").first()).find("ul, ol")).length&&(t.preventDefault(),a.prepend(r),r.unwrap(),o.append(e),e.unwrap())):!s||i.isList()||i.isTable()||!n||this.utils.isEmptyHtml(l.innerHTML)||(t.preventDefault(),l=m.dom(l),a=m.dom(h),l.append(a),a.unwrap()))},_traverseBackspace:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);if(i.isFigcaption()){if(a=i.getFigcaption(),s=this.caret.isStart(a))return void t.preventDefault()}else if(i.isComponentType("code")&&(a=i.getComponent(),(s=this.caret.isStart(a))&&a.previousElementSibling))return t.preventDefault(),this.caret.setEnd(a.previousElementSibling),!0;var s,n,o,r,a=this._getBlock(),l=this.utils.findSiblings(a,"prev");l?(s=this.caret.isStart(a),o=this.inspector.parse(l),n="P"===l.tagName||"DIV"===l.tagName,s&&o.isComponentType("code")?(t.preventDefault(),this.component.remove(l,!1)):s&&o.isComponentType("table")?(t.preventDefault(),this.caret.setEnd(l)):s&&o.isComponent()?(t.preventDefault(),this.caret.setStart(l),this.utils.isEmptyHtml(a.innerHTML)&&m.dom(a).remove()):s&&i.isList()?(t.preventDefault(),e=m.dom(a),r=m.dom(l),o.isList()?(e.children("li").first().prepend(this.marker.build("start")),r.append(e),e.unwrap(),this.selection.restoreMarkers()):(o=(i=e.children("li").first()).get(),i=i.find("ul, ol"),o=this.utils.replaceToTag(o,this.opts.markup),this.opts.breakline&&o.attr("data-redactor-tag","br"),e.before(o),this.caret.setStart(o),0!==i.length&&(e.prepend(i),i.unwrap()))):s&&n&&(t.preventDefault(),this.utils.isEmpty(l)?(r=m.dom(l)).remove():(t=this.utils.createInvisibleChar(),a=m.dom(a),r=m.dom(l),this.caret.setEnd(r),a.prepend(t),r.append(a.contents()),a.remove()))):setTimeout(this._replaceBlock.bind(this),1)},_replaceBlock:function(){var t,e=this.selection.getBlock(),i=m.dom(e);"p"===this.opts.markup&&e&&this._isNeedToReplaceBlock(e)&&(t=document.createElement(this.opts.markup),i.replaceWith(t),this.caret.setStart(t)),this.opts.breakline&&e&&"DIV"===e.tagName&&i.attr("data-redactor-tag","br")},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_removeActiveComponent:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),e=i.getComponent();if(i.isComponent()&&this.component.isActive(e))return t.preventDefault(),this.component.remove(e),!0},_removeAllSelectedTable:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e).getTable();if(e&&this.selection.isAll(e))return t.preventDefault(),this.component.remove(e),!0},_removeUnwantedStyles:function(){var t=this.editor.getElement();setTimeout(function(){t.find("*[style]").not("img, figure, figcaption, iframe, [data-redactor-style-cache], [data-redactor-span]").removeAttr("style")},0)},_removeEmptySpans:function(){var t=this.editor.getElement();setTimeout(function(){t.find("span").each(function(t){0===t.attributes.length&&m.dom(t).replaceWith(t.childNodes)})},0)},_removeSpanTagsInHeadings:function(){var t=this.editor.getElement();setTimeout(function(){t.find("h1, h2, h3, h4, h5, h6").each(function(t){t=m.dom(t);0===t.closest("figure").length&&t.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]").unwrap()})},1)},_removeInlineTagsInPre:function(){var t=this.editor.getElement(),e=this.opts.inlineTags;setTimeout(function(){t.find("pre").each(function(t){t=m.dom(t);0===t.closest("figure").length&&t.find(e.join(",")).not("code, .redactor-selection-marker").unwrap()})},1)}}),m.add("class","input.enter",{init:function(t,e){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.editor=t.editor,this.keycodes=t.keycodes,this.detector=t.detector,this.insertion=t.insertion,this.selection=t.selection,this.inspector=t.inspector,this._init(e)},_init:function(t){return this.opts.enterKey?!1===this.app.broadcast("enter",t)?t.preventDefault():this.selection.hasNonEditable()?void t.preventDefault():t.ctrlKey||t.shiftKey?this._insertBreak(t):void(this._isExit(t)||this._traverse(t)):this._disable(t)},_disable:function(t){t.preventDefault();t=this.selection.getRange();t&&!t.collapsed&&t.deleteContents()},_insertBreak:function(t){t.preventDefault();var e=this.selection.getCurrent(),i=this.selection.getBlock(),t=this.inspector.parse(e);t.isHeading()&&this.caret.isStart(i)?(i=(e=m.dom(i)).clone().html(""),e.before(i),this.caret.setStart(e)):t.isComponent()&&!t.isComponentEditable()||t.isCode()||(t.isPre()?this.insertion.insertNewline():this.insertion.insertBreakLine())},_isExit:function(t){var e=this.editor.getElement(),i=this.selection.getBlock(),s=this.inspector.parse(i),n=this.caret.isEnd(i),o=this.selection.getCurrent(),r=o.previousSibling;if(s.isBlockquote()){var a=n&&this._isExitableBlock(i,"P"),l=n&&this._isExitableDblBreak(r);if(a||l)return this._exitFromElement(t,l?r:i,s.getBlockquote())}else if(!s.isComponentType("code")&&s.isPre()){if(n){l=i.innerHTML;if(null!==(l=this.utils.removeInvisibleChars(l)).match(/(\n\n\n)$/))return m.dom(r.previousSibling.previousSibling).remove(),this._exitFromElement(t,r,i)}}else if(s.isDl()){if(n&&this._isExitableBlock(i,"DT"))return this._exitFromElement(t,i,s.getDl())}else if(s.isList()){e=m.dom(o).parents("ul, ol",e).last();if((n=this.caret.isEnd(e))&&this._isExitableBlock(i,"LI"))return this._exitFromElement(t,i,e)}else if(s.isComponent()&&s.isComponentActive()&&!s.isFigcaption()&&!s.isComponentEditable())return this._exitFromElement(t,!1,s.getComponent())},_isExitableDblBreak:function(t){var e=!!t&&t.nextSibling;if(e){t=this.utils.removeInvisibleChars(e.textContent);return 3===e.nodeType&&""===t.trim()}},_isExitableBlock:function(t,e){return t&&t.tagName===e&&this.utils.isEmptyHtml(t.innerHTML)},_exitFromElement:function(t,e,i){return t.preventDefault(),e&&m.dom(e).remove(),this.utils.createMarkup(i),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextSibling?this.caret.setStart(e.nextSibling):this.utils.createMarkup(e),!0},_traverse:function(t){var e=this.selection.getCurrent(),i=this.selection.isText(),s=this.selection.getBlock(),n=this.inspector.parse(e),o=!!s&&s.tagName.toLowerCase(),r=m.dom(e).closest("[data-redactor-type=variable]");if(0!==r.length&&this.caret.setAfter(r),n.isPre())return t.preventDefault(),this.insertion.insertNewline();if(n.isBlockquote()){if((s=this.selection.getBlock(e))&&"BLOCKQUOTE"===s.tagName)return t.preventDefault(),this.insertion.insertBreakLine()}else if(n.isFigcaption()){s=n.getFigcaption(),r=this.caret.isEnd(s),s=this.caret.isEnd();if(r||s)return this._exitNextElement(t,n.getComponent());t.preventDefault()}else{if(n.isDl())return t.preventDefault(),this._traverseDl(e);if(this.opts.breakline&&"div"===o)setTimeout(this._replaceBlock.bind(this),1);else{if(i)return t.preventDefault(),this.insertion.insertBreakLine();n.isList()||(n=this.detector.isDesktop()?50:1,setTimeout(this._replaceBlock.bind(this),n))}}},_traverseDl:function(t){var e=this.selection.getBlock(t),i=this.inspector.parse(e).getTag(),s=m.dom(e),n=s.get().nextSibling||!1,o=m.dom(n),t=n&&o.is("dd"),o=n&&o.is("dt"),e=this.caret.isEnd(e);if("dt"===i&&!t&&e){t=document.createElement("dd");return s.after(t),void this.caret.setStart(t)}if("dd"!==i||o||!e)return this.insertion.insertBreakLine();e=document.createElement("dt");s.after(e),this.caret.setStart(e)},_replaceBlock:function(){var t,e=this.selection.getBlock(),i=m.dom(e);"p"===this.opts.markup&&e&&this._isNeedToReplaceBlock(e)?(t=document.createElement(this.opts.markup),i.replaceWith(t),this.caret.setStart(t)):e&&(this.utils.isEmptyHtml(e.innerHTML)?this._clearBlock(i,e):(t=this.utils.getFirstNode(e))&&"BR"===t.tagName&&(m.dom(t).remove(),this.caret.setStart(e))),i.removeAttr("id"),e&&this._isNeedToCleanBlockStyle(e)&&this.opts.cleanOnEnter&&i.removeAttr("class style"),this.opts.breakline&&e&&e.tagName},_clearBlock:function(t,e){"DIV"===e.tagName&&t.find("br").remove(),!this.opts.cleanInlineOnEnter&&"<br>"!==e.innerHTML||t.html(""),this.caret.setStart(e)},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_isNeedToCleanBlockStyle:function(t){return"P"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)}}),m.add("class","input.paste",{init:function(t,e,i,s,n){this.app=t,this.opts=t.opts,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.autoparser=t.autoparser,this.pasteHtml=s,this.pointInserted=n,this.dataTransfer=i,this._init(e)},_init:function(t){var e=this.dataTransfer||t.clipboardData,i=this.selection.getCurrent(),i=this.inspector.parse(i);if(this.dropPasted=this.dataTransfer,this.isRawCode=i.isPre()||i.isCode(),this.editor.enablePasting(),this.editor.saveScroll(),this.dropPasted||this.selection.saveMarkers(),this.isRawCode||!e){var s=this.isRawCode||e||!window.clipboardData?e.getData("text/plain"):window.clipboardData.getData("text");t.preventDefault(),this._insert(t,s)}else if(this.pasteHtml)t.preventDefault(),this._insert(t,this.pasteHtml);else{i=e.getData("URL"),s=this._isPlainText(e)?this.cleaner.encodeEntities(e.getData("text/plain")):e.getData("text/html"),s=i&&""!==i?i:s;if(null!==e.files&&0<e.files.length&&""===s){for(var n=[],o=0;o<e.files.length;o++){var r=e.files[o]||e.items[o].getAsFile();r&&n.push(r)}if(0<n.length)return t.preventDefault(),void this._insertFiles(t,n)}t.preventDefault(),this._insert(t,s)}},_isPlainText:function(t){var e=t.getData("text/plain"),i=t.getData("text/html");if(!e||!i)return null!==e;t=document.createElement("div");return t.innerHTML=i,t.textContent===e?!t.querySelector(":not(meta)"):void 0},_restoreSelection:function(){this.editor.restoreScroll(),this.editor.disablePasting(),this.dropPasted||this.selection.restoreMarkers()},_insert:function(t,e){var i,s=this.app.broadcast("pasteBefore",e);e=(e=void 0===s?e:s).trim(),e=(e=this.isRawCode?e:this.cleaner.paste(e)).trim(),e=this.isRawCode?this.cleaner.encodePhpCode(e):e,e=void 0===(s=this.app.broadcast("pasting",e))?e:s,this._restoreSelection(),this.opts.input&&(this.app.broadcast("state",!1),i=[],this.isRawCode?(e=e.replace("&lt;?php","<?php"),s=document.createTextNode(e),i=this.insertion.insertNode(s,"after"),this.app.broadcast("pasted",i)):(this.opts.autoparse&&this.opts.autoparsePaste&&(e=this.autoparser.parse(e)),i=this.dropPasted?this.insertion.insertToPoint(t,e,this.pointInserted):this.insertion.insertHtml(e),this.app.broadcast("pasted",i),this.app.broadcast("autoparseobserve")))},_insertFiles:function(t,e){this._restoreSelection();var i=-1!==this.opts.imageTypes.indexOf(e[0].type),s=void 0===this.dropPasted;i?this.app.broadcast("dropimage",t,e,s):this.app.broadcast("dropfile",t,e,s)}}),m.add("class","input.shortcode",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.marker=t.marker,this.keycodes=t.keycodes,this.selection=t.selection,this.worked=!1,i===this.keycodes.SPACE&&this._init()},is:function(){return this.worked},_init:function(){var t=this.selection.getCurrent();if(t&&3===t.nodeType){var e,i=this.utils.removeInvisibleChars(t.textContent),s=this.opts.shortcodes;for(e in s){var n=new RegExp("^"+this.utils.escapeRegExp(e)),o=i.match(n);if(null!==o&&void 0!==s[e].format)return this._format(s[e].format,t,n)}}},_format:function(t,e,i){var s=(e=this.marker.insert("start").previousSibling).textContent;s=(s=this.utils.trimSpaces(s)).replace(i,""),e.textContent=s,this.app.api("ul"===t||"ol"===t?"module.list.toggle":"module.block.format",t),this.selection.restoreMarkers(),this.worked=!0}}),m.add("class","input.shortcut",{init:function(t,e){this.app=t,this.opts=t.opts,this.worked=!1,this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},this._init(e)},is:function(){return this.worked},_init:function(t){if(!1!==this.opts.shortcuts)for(var e in this.opts.shortcuts)this._build(t,e,this.opts.shortcuts[e]);else!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault()},_build:function(t,e,i){for(var s=e.split(","),n=s.length,o=0;o<n;o++)"string"==typeof s[o]&&this._handler(t,s[o].trim(),i)},_handler:function(t,e,i){e=e.toLowerCase().split(" ");for(var s=this.hotkeys[t.keyCode],n=String.fromCharCode(t.which).toLowerCase(),o="",r={},a=["meta","ctrl","alt","shift"],l=0;l<a.length;l++){var h=a[l];t[h+"Key"]&&s!==h&&(o+=h+"+")}s&&(r[o+s]=!0),n&&(r[o+n]=!0,r[o+this.hotkeysShiftNums[n]]=!0,"shift+"===o&&(r[this.hotkeysShiftNums[n]]=!0));for(var c=e.length,l=0;l<c;l++)if(r[e[l]])return t.preventDefault(),this.worked=!0,void(i.message?(this.app.broadcast(i.message,i.args),this.app.broadcast("buffer.trigger")):i.api&&(this.app.api(i.api,i.args),this.app.broadcast("buffer.trigger")))}}),m.add("class","input.space",{init:function(t,e,i,s){this.app=t,this.keycodes=t.keycodes,this.insertion=t.insertion,this.selection=t.selection,this.key=i,this.lastShiftKey=s,this._init(e)},_init:function(t){this.selection.hasNonEditable()?t.preventDefault():this.lastShiftKey||this.key!==this.keycodes.SPACE||!t.ctrlKey&&!t.shiftKey||t.metaKey||(t.preventDefault(),this.insertion.insertChar("&nbsp;"))}}),m.add("class","input.tab",{init:function(t,e){this.app=t,this.opts=t.opts,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this._init(e)},_init:function(t){if(this.opts.tabKey){if(!1===this.app.broadcast("tab",t))return t.preventDefault();this._traverse(t)}},_traverse:function(t){var e=this.selection.getCurrent(),e=this.inspector.parse(e);return!e.isComponent()&&t.shiftKey?this._insertHardTab(t,4):e.isList()?(t.preventDefault(),this.app.api("module.list.indent")):e.isPre()||e.isComponentType("code")&&!e.isFigcaption()?this._tabCode(t):!1!==this.opts.tabAsSpaces?this._insertHardTab(t,this.opts.tabAsSpaces):void 0},_insertHardTab:function(t,e){t.preventDefault();e=document.createTextNode(Array(e+1).join(" "));return this.insertion.insertNode(e,"end")},_tabCode:function(t){t.preventDefault();t=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join(" ")):document.createTextNode("\t");return this.insertion.insertNode(t,"end")}}),m.add("module","upload",{init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.utils=t.utils,this.editor=t.editor,this.progress=t.progress,this.defaults={event:!1,element:!1,name:!1,files:!1,url:!1,data:!1,paramName:!1}},build:function(t){this.p=m.extend(this.defaults,t),this.$el=m.dom(this.p.element),"INPUT"===this.$el.get().tagName?this._buildInput():this._buildBox()},send:function(t){this.p=m.extend(this.defaults,t),this.$uploadbox=this.editor.getElement(),this._send(this.p.event,this.p.files)},complete:function(t,e){this._complete(t,e)},_buildInput:function(){this.box=!1,this.prefix="",this.$uploadbox=m.dom('<div class="upload-redactor-box" />'),this.$el.hide(),this.$el.after(this.$uploadbox),this.opts.multipleUpload?this.$el.attr("multiple","multiple"):this.$el.removeAttr("multiple"),"file"!==this.p.name&&this.$el.attr("accept","image/*"),this._buildPlaceholder(),this._buildEvents()},_buildBox:function(){this.box=!0,this.prefix="box-",this.$uploadbox=this.$el,this.$uploadbox.attr("ondragstart","return false;"),this.$uploadbox.on("drop.redactor.upload",this._onDropBox.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=m.dom('<div class="upload-redactor-placeholder" />'),this.$placeholder.html(this.lang.get("upload-label")),this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on("change.redactor.upload",this._onChange.bind(this)),this.$uploadbox.on("click.redactor.upload",this._onClick.bind(this)),this.$uploadbox.on("drop.redactor.upload",this._onDrop.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_onClick:function(t){t.preventDefault(),this.$el.click()},_onChange:function(t){this._send(t,this.$el.get().files)},_onDrop:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_onDragOver:function(t){return t.preventDefault(),this._setStatusHover(),!1},_onDragLeave:function(t){return t.preventDefault(),this._removeStatusHover(),!1},_onDropBox:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_removeStatusHover:function(){this.$uploadbox.removeClass("upload-redactor-"+this.prefix+"hover")},_setStatusDrop:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"drop")},_setStatusHover:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"hover")},_setStatusError:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"error")},_setStatusSuccess:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"success")},_clear:function(){for(var t=["drop","hover","error","success"],e=0;e<t.length;e++)this.$uploadbox.removeClass("upload-redactor-"+this.prefix+t[e]);this.$uploadbox.removeAttr("ondragstart")},_send:function(t,e){t=t.originalEvent||t,e=e||t.dataTransfer.files;var i=new FormData,s=this._getUploadParam(),i=this._buildData(s,e,i);i=this.utils.extendData(i,this.p.data),!1!==this.app.broadcast("upload.start",t,i,e)&&this._sendData(i,e,t)},_sendData:function(t,e,s){this.progress.show(),"function"==typeof this.p.url?(e=this.p.url(t,e,s,this))instanceof Promise||this._complete(e,s):m.ajax.post({url:this.p.url,data:t,before:function(t){return this.app.broadcast("upload.beforeSend",t)}.bind(this),success:function(t){this._complete(t,s)}.bind(this),error:function(t,e,i){this._complete(t,s,i)}.bind(this)})},_getUploadParam:function(){return this.p.paramName||"file"},_buildData:function(t,e,i){if(1===e.length)i.append(t+"[]",e[0]);else if(1<e.length&&!1!==this.opts.multipleUpload)for(var s=0;s<e.length;s++)i.append(t+"[]",e[s]);return i},_complete:function(t,e,i){this._clear(),this.progress.hide(),t&&t.error?(this._setStatusError(),this.app.broadcast("upload."+this.p.name+".error",t,e,i),this.app.broadcast("upload.error",t,i)):(this._setStatusSuccess(),this.app.broadcast("upload."+this.p.name+".complete",t,e),this.app.broadcast("upload.complete",t),setTimeout(this._clear.bind(this),500))}}),m.add("class","code.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?(0!==(e=m.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.append(t)),e=this.find("pre code, pre").last()):(e=m.dom("<pre>"),this.parse("<figure>"),this.append(e)),this._initElement(e),this._initWrapper()},_initElement:function(t){t.attr({tabindex:"-1",contenteditable:!0})},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"code",tabindex:"-1",contenteditable:!1})}}),m.add("module","form",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector},onform:{remove:function(t){this._remove(t)}},oncontextbar:function(t,e){var i,s=this.inspector.parse(t.target);s.isComponentType("form")&&(i=s.getComponent(),s={remove:{title:this.lang.get("delete"),api:"module.form.remove",args:i}},e.set(t,i,s,"top"))},_remove:function(t){this.component.remove(t)}}),m.add("class","form.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.utils=t.utils,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?0!==m.dom(t).closest("form").length?(e=this.utils.replaceToTag(t,"figure"),this.parse(e)):(this.parse("<figure>"),this.append(t)):this.parse("<figure>"),this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"form",tabindex:"-1",contenteditable:!1})}}),m.add("module","image",{modals:{image:'<div class="redactor-modal-tab redactor-modal-tab-upload" data-title="## upload ##"><form action="">                 <input type="file" name="file">             </form></div>',imageedit:'<div class="redactor-modal-group">                 <div id="redactor-modal-image-preview" class="redactor-modal-side"></div>                 <form action="" class="redactor-modal-area">                     <div class="form-item">                         <label for="modal-image-title"> ## title ##</label>                         <input type="text" id="modal-image-title" name="title" />                     </div>                     <div class="form-item form-item-caption">                         <label for="modal-image-caption">## caption ##</label>                         <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                     </div>                     <div class="form-item form-item-align">                         <label>## image-position ##</label>                         <select name="align" aria-label="## image-position ##">                             <option value="none">## none ##</option>                             <option value="left">## left ##</option>                             <option value="center">## center ##</option>                             <option value="right">## right ##</option>                         </select>                     </div>                     <div class="form-item form-item-link">                         <label for="modal-image-url">## link ##</label>                         <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                     </div>                     <div class="form-item form-item-link">                         <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##</label>                     </div>                 </form>             </div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.justResized=!1},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages(),this.opts.imageResizable&&(this.resizer=m.create("image.resize",this.app)),this._observeImages()},ondropimage:function(t,e,i){this.opts.imageUpload&&(e={url:this.opts.imageUpload,event:!i&&t,files:e,name:"imagedrop",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.send",e))},onstop:function(){this.resizer&&this.resizer.stop()},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"image")},onimageresizer:{stop:function(){this.resizer&&this.resizer.hide()}},onsource:{open:function(){this.resizer&&this.resizer.hide()},closed:function(){this._observeImages(),this.resizer&&this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(t){this._insert(t),this.app.broadcast("state",!1)},error:function(t){this._uploadError(t)}},imageedit:{complete:function(t){this._change(t)},error:function(t){this._uploadError(t)}},imagedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}},imagereplace:{complete:function(t){this._change(t,!1)},error:function(t){this._uploadError(t)}}},onmodal:{image:{open:function(t,e){this._setUpload(t,e)}},imageedit:{open:function(t,e){this._setFormData(t,e)},opened:function(t,e){this._setFormFocus(e)},remove:function(){this._remove(this.$image)},save:function(t,e){this._save(t,e)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=!0}},oncontextbar:function(t,e){var i,s;this.justResized?this.justResized=!1:(i=this.selection.getCurrent(),s=this.inspector.parse(i),i=m.dom(i).closest("img"),(!s.isFigcaption()&&s.isComponentType("image")||0!==i.length)&&(i=0!==i.length?i.get():s.getComponent(),s={edit:{title:this.lang.get("edit"),api:"module.image.open"},remove:{title:this.lang.get("delete"),api:"module.image.remove",args:i}},e.set(t,i,s)))},open:function(){this.$image=this._getCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_getModalData:function(){var t=this._isImage()&&this.opts.imageEditable?{name:"imageedit",width:"800px",title:this.lang.get("edit"),handle:"save",commands:{save:{title:this.lang.get("save")},remove:{title:this.lang.get("delete"),type:"danger"},cancel:{title:this.lang.get("cancel")}}}:{name:"image",title:this.lang.get("image")};return t},_isImage:function(){return this.$image},_getCurrent:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),t=m.dom(t).closest("img");return 0!==t.length?this.component.create("image",t):!(!e.isComponentType("image")||!e.isComponentActive())&&this.component.create("image",e.getComponent())},_insert:function(t,e){if(this.app.api("module.modal.close"),Array.isArray(t)){for(var i={},s=0;s<t.length;s++)i=m.extend(i,t[s]);t=i}else"string"==typeof t&&(t={file:{url:t}});if("object"==typeof t){var n,o=0;for(n in t)"object"==typeof t[n]&&o++;1<o?this._insertMultiple(t,e):this._insertSingle(t,e)}},_insertSingle:function(t,e){for(var i in t)"object"==typeof t[i]&&(i=this._createImageAndStore(t[i]),i=e?this.insertion.insertToPoint(e,i,!1,!1):this.insertion.insertHtml(i,!1),this._removeSpaceBeforeFigure(i[0]),this.component.setActive(i[0]),this.app.broadcast("image.uploaded",i[0],t))},_insertMultiple:function(t,e){var i,s,n,o=0,r=[];for(s in t)"object"==typeof t[s]&&(o++,n=this._createImageAndStore(t[s]),1===o?r=e?this.insertion.insertToPoint(e,n,!1,!1):this.insertion.insertHtml(n,!1):(m.dom(r[0]).after(n),r=[n.get()],this.app.broadcast("image.inserted",n)),i=r[0],this._removeSpaceBeforeFigure(r[0]),this.app.broadcast("image.uploaded",r[0],t));this.component.setActive(i)},_createImageAndStore:function(t){var e=this.component.create("image");return e.addClass("redactor-uploaded-figure"),e.setData({src:t.url,id:t.id||this.utils.getRandomId()}),this.storage.add("image",e.getElement()),e},_removeSpaceBeforeFigure:function(t){var e,i,s;t&&(e=t.previousSibling,i=t.nextSibling,s=m.dom(e),t=m.dom(i),this.opts.breakline&&(i&&"br"===t.attr("data-redactor-tag")&&t.find("br").first().remove(),e&&"br"===s.attr("data-redactor-tag")&&s.find("br").last().remove()),e&&(this._removeInvisibleSpace(e),this._removeInvisibleSpace(e.previousSibling)))},_removeInvisibleSpace:function(t){t&&3===t.nodeType&&-1!==this.utils.searchInvisibleChars(t.textContent)&&t.parentNode.removeChild(t)},_save:function(t,e){var i=e.getData(),e={title:i.title};this.opts.imageLink&&(e.link={url:i.url,target:i.target}),this.opts.imageCaption&&(e.caption=i.caption),this.opts.imagePosition&&(e.align=i.align),this.$image.setData(e),this.resizer&&this.resizer.rebuild(),this.app.broadcast("image.changed",this.$image),this.app.api("module.modal.close")},_change:function(t,e){if("object"==typeof(t="string"==typeof t?{file:{url:t}}:t)){var i,s;for(s in t)if("object"==typeof t[s]){(i=m.dom("<img>")).attr("src",t[s].url),this.$image.changeImage(t[s]),this.app.broadcast("image.changed",this.$image,t),this.app.broadcast("image.uploaded",this.$image,t),this.app.broadcast("hardsync");break}!1!==e&&i.on("load",function(){this.$previewBox.html(i)}.bind(this))}},_uploadError:function(t){this.app.broadcast("image.uploadError",t)},_remove:function(t){this.app.api("module.modal.close"),this.component.remove(t)},_observeImages:function(){var t=this.editor.getElement(),i=this;t.find("img").each(function(t){var e=m.dom(t);e.off(".drop-to-replace"),e.on("dragover.drop-to-replace dragenter.drop-to-replace",function(t){t.preventDefault()}),e.on("drop.drop-to-replace",function(t){if(!i.app.isDragComponentInside())return i._setReplaceUpload(t,e)})})},_setFormData:function(t,e){this._buildPreview(t),this._buildPreviewUpload();var i=this.$image.getData(),s={title:i.title};this.opts.imageCaption?s.caption=i.caption:t.find(".form-item-caption").hide(),this.opts.imagePosition?s.align=i.align:t.find(".form-item-align").hide(),this.opts.imageLink?i.link&&(s.url=i.link.url,i.link.target&&(s.target=!0)):t.find(".form-item-link").hide(),e.setData(s)},_setFormFocus:function(t){t.getField("title").focus()},_setReplaceUpload:function(t,e){(t=t.originalEvent||t).stopPropagation(),t.preventDefault(),this.opts.imageUpload&&(this.$image=this.component.create("image",e),t={url:this.opts.imageUpload,files:t.dataTransfer.files,name:"imagereplace",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.send",t))},_setUpload:function(t,e){this.opts.imageUpload||t.getBody().find(".redactor-modal-tab-upload").remove();e={url:this.opts.imageUpload,element:e.getField("file"),name:"image",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",e)},_buildPreview:function(t){this.$preview=t.find("#redactor-modal-image-preview");var e=this.$image.getData(),t=m.dom("<img>");t.attr("src",e.src),this.$previewBox=m.dom("<div>"),this.$previewBox.append(t),this.$preview.html(""),this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){var t;this.opts.imageUpload&&((t=m.dom('<div class="desc">')).html(this.lang.get("upload-change-label")),this.$preview.append(t),t={url:this.opts.imageUpload,element:this.$previewBox,name:"imageedit",data:this.opts.imageData,paramName:this.opts.imageUploadParam},this.app.api("module.upload.build",t))}}),m.add("class","image.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.selection=t.selection,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["src","title","caption","align","link","id"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},getElement:function(){return this.$element},changeImage:function(t){this.$element.attr("src",t.url)},_init:function(t){var e=m.dom(t),i=e.closest("figure");void 0===t?(this.$element=m.dom("<img>"),this.parse("<figure>"),this.append(this.$element)):0===i.length?(this.parse("<figure>"),this.$element=e,this.$element.wrap(this)):(this.parse(i),this.$element=this.find("img")),this._initWrapper()},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_set_src:function(t){this.$element.attr("src",t)},_set_id:function(t){this.opts.imageObserve&&this.$element.attr("data-image",t)},_set_title:function(t){""===(t=t.trim().replace(/(<([^>]+)>)/gi,""))?this.$element.removeAttr("alt"):this.$element.attr("alt",t)},_set_caption:function(t){var e=this.find("figcaption");return 0===e.length&&((e=m.dom("<figcaption>")).attr("contenteditable","true"),this.append(e)),""===t?e.remove():e.html(t),e},_set_align:function(t){var e="",i="",s="",n=this,o=this.find("img"),r=this.find("figcaption");if("object"==typeof this.opts.imagePosition){var a,l=this.opts.imagePosition;for(a in l)n.removeClass(l[a]);var h=void 0!==l[t]&&l[t];h&&n.addClass(h)}else{o=o.width();switch(t){case"left":e="left",i=this.opts.imageFloatMargin;break;case"right":e="right",i=this.opts.imageFloatMargin;break;case"center":s="center",i="auto"}n.css({float:e,width:o+"px",maxWidth:o+"px","margin-left":i,"margin-right":i,"text-align":s}),n.attr("rel",n.attr("style")),"none"===t&&(n.css("max-width",""),n.css("width","")),"center"===t?(n.css("max-width",""),n.css("width",""),r.css("text-align","center")):r.css("text-align","")}},_set_link:function(t){var e=this._findLink();if(""!==t.url)return e||(e=m.dom("<a>"),this.$element.wrap(e)),e.attr("href",t.url),t.target?e.attr("target",!0===t.target?"_blank":t.target):e.removeAttr("target"),e;e&&e.unwrap()},_get_src:function(){return this.$element.attr("src")},_get_id:function(){return this.$element.attr("data-image")},_get_title:function(){var t=this.$element.attr("alt");return t||""},_get_caption:function(){var t=this.find("figcaption");return 0===t.length?"":t.html()},_get_align:function(){var t="";if("object"==typeof this.opts.imagePosition){var e,t="none",i=this.opts.imagePosition;for(e in i)if(this.hasClass(i[e])){t=e;break}}else t="center"===this.css("text-align")?"center":this.css("float");return t},_get_link:function(){var t=this._findLink();if(t){var e=!!t.attr("target");return{url:t.attr("href"),target:e}}},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"image",tabindex:"-1",contenteditable:!1})},_findLink:function(){var t=this.find("a").filter(function(t){return 0===m.dom(t).closest("figcaption").length});return 0!==t.length&&t}}),m.add("class","image.resize",{init:function(t){this.app=t,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find("#redactor-image-resizer").remove()},stop:function(){this.editor.getElement().off(".redactor.image-resize"),this.$doc.off(".redactor.image-resize"),this.$win.off("resize.redactor.image-resize"),this.hide()},_init:function(){this.editor.getElement().on("click.redactor.image-resize",this._build.bind(this)),this.$win.on("resize.redactor.image-resize",this._setResizerPosition.bind(this))},_build:function(t){var e;this.$target.find("#redactor-image-resizer").remove(),this.app.isReadOnly()||(e=this.inspector.parse(t.target),t=this.editor.getElement(),e.isComponentType("image")&&(this.$resizableBox=t,this.$resizableImage=m.dom(e.getImageElement()),this.$resizer=m.dom("<span>"),this.$resizer.attr("id","redactor-image-resizer"),this.$target.append(this.$resizer),this._setResizerPosition(),this.$resizer.on("mousedown touchstart",this._set.bind(this))))},_setResizerPosition:function(){var t,e,i,s,n,o,r;this.$resizer&&(o=this.toolbar.isTarget(),r=this.$target.offset(),t=o?7-r.top+this.$target.scrollTop():7,e=o?7-r.left:7,i=this.$resizableImage.offset(),s=this.$resizableImage.width(),n=this.$resizableImage.height(),o=this.$resizer.width(),r=this.$resizer.height(),this.$resizer.css({top:Math.round(i.top+n-r+t)+"px",left:Math.round(i.left+s-o+e)+"px"}))},_set:function(t){t.preventDefault(),this.resizeHandle={x:t.pageX,y:t.pageY,el:this.$resizableImage,$figure:this.$resizableImage.closest("figure"),ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()},(t=t.originalEvent||t).targetTouches&&(this.resizeHandle.x=t.targetTouches[0].pageX,this.resizeHandle.y=t.targetTouches[0].pageY),this.app.broadcast("contextbar.close"),this.app.broadcast("image.resize",this.$resizableImage),this._start()},_start:function(){this.$doc.on("mousemove.redactor.image-resize touchmove.redactor.image-resize",this._move.bind(this)),this.$doc.on("mouseup.redactor.image-resize touchend.redactor.image-resize",this._stop.bind(this))},_stop:function(){this.$doc.off(".redactor.image-resize"),this.app.broadcast("image.resized",this.$resizableImage)},_move:function(t){t.preventDefault(),t=t.originalEvent||t;var e=this.resizeHandle.h;t.targetTouches?e+=t.targetTouches[0].pageY-this.resizeHandle.y:e+=t.pageY-this.resizeHandle.y;t=e*this.resizeHandle.ratio,t=Math.round(t);(e=Math.round(e))<20||t<100||this._getResizableBoxWidth()<=t||(0!==this.resizeHandle.$figure.length&&""!==this.resizeHandle.$figure.css("max-width")&&this.resizeHandle.$figure.css({width:t+"px","max-width":t+"px"}),this.resizeHandle.el.attr({width:t,height:e}),this.resizeHandle.el.width(t),this.resizeHandle.el.css("max-width",t+"px"),this.resizeHandle.el.height(e),this._setResizerPosition())},_getResizableBoxWidth:function(){return this.$resizableBox.width()-parseInt(this.$resizableBox.css("padding-left"))-parseInt(this.$resizableBox.css("padding-right"))}}),m.add("module","file",{modals:{file:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <div class="form-item form-item-title">                     <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)</span></label>                     <input type="text" id="modal-file-title" name="title" />                 </div>                 <input type="file" name="file">             </form></div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(t,e,i){this.opts.fileUpload&&(e={url:this.opts.fileUpload,event:!i&&t,files:e,name:"filedrop",data:this.opts.fileData},this.app.api("module.upload.send",e))},onmodal:{file:{open:function(t,e){this._setFormData(t,e),this._setUpload(e)},opened:function(t,e){this._setFormFocus(e),this.$form=e}}},onupload:{file:{complete:function(t){this._insert(t)},error:function(t){this._uploadError(t)}},filedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}}},open:function(){this._open()},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_open:function(){this.app.api("module.modal.build",this._getModalData())},_getModalData:function(){return{name:"file",title:this.lang.get("file")}},_insert:function(t,e){if(this.app.api("module.modal.close"),"object"==typeof t){if(Array.isArray(t)){for(var i={},s=0;s<t.length;s++)i=m.extend(i,t[s]);t=i}1<Object.keys(t).length?this._insertMultiple(t,e):this._insertSingle(t,e),this.$form=!1}},_insertSingle:function(t,e){var i,s=[];for(i in t){var n=this._createFileAndStore(t[i]),s=this.opts.fileAttachment?this._insertAsAttachment(n):e?this.insertion.insertToPoint(e,n):this.insertion.insertRaw(n);this.app.broadcast("file.uploaded",s[0],t)}},_insertMultiple:function(t,e){var i,s,n=0,o=[];for(s in t){n++;var r=this._createFileAndStore(t[s]);this.opts.fileAttachment?o=this._insertAsAttachment(r,t):1===n?o=e?this.insertion.insertToPoint(e,r):this.insertion.insertRaw(r):(m.dom(o[0]).after(r).after(" "),o=[r.get()],this.app.broadcast("file.inserted",r)),i=r,this.app.broadcast("file.uploaded",o[0],t)}this.opts.fileAttachment||this.caret.setAfter(i)},_insertAsAttachment:function(t,e){var i=m.dom(this.opts.fileAttachment),t=t.wrapAttachment();i.append(t);t=[t.get()];return this.app.broadcast("file.appended",t[0],e),t},_createFileAndStore:function(t){var e=!!this.$form&&this.$form.getData(),i=t.name||t.url,e=!this.opts.fileAttachment&&e&&""!==e.title?e.title:this._truncateUrl(i),i=this.component.create("file");return i.attr("href",t.url),i.attr("data-file",t.id||this.utils.getRandomId()),i.attr("data-name",t.name),i.html(e),this.storage.add("file",i),i},_remove:function(t){this.selection.save();t=this.component.create("file",t);!1!==this.app.broadcast("file.delete",t)?(t.unwrap(),this.selection.restore(),this.app.broadcast("file.deleted",t)):this.selection.restore()},_truncateUrl:function(t){return-1!==t.search(/^http/)&&20<t.length?t.substring(0,20)+"...":t},_setUpload:function(t){t={url:this.opts.fileUpload,element:t.getField("file"),name:"file",data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api("module.upload.build",t)},_setFormData:function(t,e){this.opts.fileAttachment?t.find(".form-item-title").hide():e.setData({title:this.selection.getText()})},_setFormFocus:function(t){t.getField("title").focus()},_uploadError:function(t){this.app.broadcast("file.uploadError",t)}}),m.add("class","file.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,e&&void 0!==e.cmnt?e:this._init(e)},wrapAttachment:function(){return this.$wrapper=m.dom('<span class="redactor-file-item">'),this.$remover=m.dom('<span class="redactor-file-remover">'),this.$remover.html("&times;"),this.$remover.on("click",this.removeAttachment.bind(this)),this.$wrapper.append(this),this.$wrapper.append(this.$remover),this.$wrapper},removeAttachment:function(t){t.preventDefault(),!1!==this.app.broadcast("file.delete",this,this.$wrapper)&&(this.$wrapper.remove(),this.app.broadcast("file.deleted",this),this.app.broadcast("file.removeAttachment",this))},_init:function(t){void 0===t?this.parse("<a>"):(t=m.dom(t).closest("a"),this.parse(t))}}),m.add("module","buffer",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.offset=t.offset,this.keycodes=t.keycodes,this.selection=t.selection,this.state=!1,this.passed=!1,this.keyPressed=!1,this.undoStorage=[],this.redoStorage=[]},onkeydown:function(t){this._listen(t)},onsyncing:function(){this.keyPressed||this.trigger(),this.keyPressed=!1},onbuffer:{trigger:function(){this.trigger()}},onstate:function(t,e,i){t&&(t.ctrlKey||t.metaKey)||t&&(this._isUndo(t)||this._isRedo(t))||(this.passed=!1,this._saveState(e,i),!1===t&&this._setUndo())},onenable:function(){this.clear()},clear:function(){this.state=!1,this.undoStorage=[],this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){this.state&&!1===this.passed&&this._setUndo()},_saveState:function(t,e){var i=this.editor.getElement();this.state={html:t||i.html(),offset:e||this.offset.get()}},_listen:function(t){var e=t.which,i=t.ctrlKey||t.metaKey,s=i||t.shiftKey||t.altKey,n=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];return this._isUndo(t)?(t.preventDefault(),void this.undo()):this._isRedo(t)?(t.preventDefault(),void this.redo()):((i||-1===n.indexOf(e))&&(!i||88!==e&&67!==e)||(s=!0,this.trigger()),s||this._hasUndo()||this.trigger(),void(this.keyPressed=!0))},_isUndo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&90===e&&!t.shiftKey&&!t.altKey},_isRedo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&(90===e&&t.shiftKey||89===e&&!t.shiftKey)&&!t.altKey},_setUndo:function(){var t=this.undoStorage[this.undoStorage.length-1];void 0!==t&&t[0]===this.state.html||(this.undoStorage.push([this.state.html,this.state.offset]),this._removeOverStorage())},_setRedo:function(){var t=this.editor.getElement(),e=this.offset.get(),t=t.html();this.redoStorage.push([t,e]),this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){var t,e;this._hasUndo()&&(this.passed=!0,t=this.editor.getElement(),e=this.undoStorage.pop(),this._setRedo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.app.broadcast("undo",e[0],e[1]))},_getRedo:function(){var t,e;this._hasRedo()&&(this.passed=!0,t=this.editor.getElement(),e=this.redoStorage.pop(),this._setUndo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.app.broadcast("redo",e[0],e[1]))},_removeOverStorage:function(){this.undoStorage.length>this.opts.bufferLimit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.bufferLimit))},_hasUndo:function(){return 0!==this.undoStorage.length},_hasRedo:function(){return 0!==this.redoStorage.length}}),m.add("module","list",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.block=t.block,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection},onbutton:{list:{observe:function(t){this._observeButton(t)}}},ondropdown:{list:{observe:function(t){this._observeDropdown(t)}}},toggle:function(t){var e=this._getBlocks(),i=this.selection.getBlock(),s=m.dom(i).parents("ul, ol",this.editor.getElement()).last();return 0===e.length&&0!==s.length&&(e=[s.get()]),!i||"TD"!==i.tagName&&"TH"!==i.tagName||(e=this.block.format("div")),this.selection.saveMarkers(),e=0!==e.length&&this._isUnformat(t,e)?this._unformat(t,e):this._format(t,e),this.selection.restoreMarkers(),e},indent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),s=!!i.isList()&&i.getListItem(),n=m.dom(s),e=n.prevElement(),i=e.get();t&&s&&i&&"LI"===i.tagName&&(this.selection.saveMarkers(),s=(e=m.dom(i)).children("ul, ol"),i=n.closest("ul, ol"),0!==s.length?s.append(n):(i=i.get().tagName.toLowerCase(),(i=m.dom("<"+i+">")).append(n),e.append(i)),this.selection.restoreMarkers(),this.utils.isEmptyHtml(n.html())&&this.app.caret.setStart(n))},outdent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),s=!!i.isList()&&i.getListItem(),n=m.dom(s);if(t&&s){var o=n.parent(),r=o.closest("li",".redactor-in-"+this.uuid),e=n.prevElement(),i=n.nextElement(),t=e.get(),s=i.get(),e=!1===t,i=!1!==t&&!1!==s,t=!e&&!1===s;if(this.selection.saveMarkers(),0!==r.length)if(i){for(var a=this._getAllNext(n.get()),l=m.dom("<"+o.get().tagName.toLowerCase()+">"),h=0;h<a.length;h++)l.append(a[h]);r.after(n),n.append(l)}else r.after(n),0===o.children().length?o.remove():e&&n.append(o);else{s=this._createUnformatContainer(n),r=s.find("ul, ol").first();if(e)o.before(s);else if(t)o.after(s);else if(i){l=m.dom("<"+o.get().tagName.toLowerCase()+">"),a=this._getAllNext(n.get());for(h=0;h<a.length;h++)l.append(a[h]);o.after(s),s.after(l)}0!==r.length&&((i=s.nextElement().get())&&i.tagName===o.get().tagName?(m.dom(i).prepend(r),r.unwrap()):s.after(r)),n.remove()}this.selection.restoreMarkers()}},_getAllNext:function(t){for(var e=[];t;){if(!(t=m.dom(t).nextElement().get()))return e;e.push(t)}return e},_isUnformat:function(t,e){for(var i,s=0,n=0;n<e.length;n++)3!==e[n].nodeType&&((i=e[n].tagName.toLowerCase())!==t&&"figure"!==i||s++);return s===e.length},_format:function(t,e){var i,s=this._uniteBlocks(e,["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6","ul","ol"]),n=[];for(i in s){for(var o,r,a=s[i],l=this._createList(t,s[i]),h=0;h<a.length;h++)3===a[h].nodeType||"UL"!==a[h].tagName&&"OL"!==a[h].tagName?((o=(r=this._createListItem(a[h])).get().lastChild)&&"BR"===o.tagName&&m.dom(o).remove(),this.utils.normalizeTextNodes(r),l.append(r)):(r=(o=m.dom(a[h])).contents(),l.append(r),this.utils.isEmpty(o)&&o.remove());n.push(l.get())}return n},_uniteBlocks:function(t,e){for(var i=0,s={0:[]},n=!1,o=0;o<t.length;o++){var r=m.dom(t[o]).closest("th, td");0!==r.length?(r.get()!==n&&(s[++i]=[]),this._isUniteBlock(t[o],e)&&s[i].push(t[o])):this._isUniteBlock(t[o],e)?s[i].push(t[o]):s[++i]=[],n=r.get()}return s},_isUniteBlock:function(t,e){return 3===t.nodeType||-1!==e.indexOf(t.tagName.toLowerCase())},_createList:function(t,e){e=e[e.length-1],e=m.dom(e),t=m.dom("<"+t+">");return e.after(t),t},_createListItem:function(t){var e=m.dom("<li>");return 3===t.nodeType?e.append(t):(t=m.dom(t),e.append(t.contents()),t.remove()),e},_unformat:function(t,e){if(1===e.length){var i=m.dom(e[0]),s=i.find("li"),n=this.selection.getNodes({tags:["li"]}),o=this.selection.getBlock(),o=m.dom(o).closest("li");if((n=0===n.length&&0!==o.length?[o.get()]:n).length===s.length)return this._unformatEntire(e[0]);o=this._getItemsPosition(s,n);if("Top"===o)return this._unformatAtSide("before",n,i);if("Bottom"===o)return n.reverse(),this._unformatAtSide("after",n,i);if("Middle"===o){var r=m.dom(n[n.length-1]),a=!1,l=!1,h=m.dom("<"+i.get().tagName.toLowerCase()+">");s.each(function(t){var e;a&&(0!==(e=m.dom(t)).closest(".redactor-split-item").length||!1!==l&&0!==e.closest(l).length||e.addClass("redactor-split-item"),l=e),t===r.get()&&(a=!0)}),s.filter(".redactor-split-item").each(function(t){m.dom(t).removeClass("redactor-split-item"),h.append(t)}),i.after(h),n.reverse();for(var c=0;c<n.length;c++){var d=m.dom(n[c]),u=this._createUnformatContainer(d);i.after(u),u.find("ul, ol").remove(),d.remove()}}}else for(c=0;c<e.length;c++)3!==e[c].nodeType&&e[c].tagName.toLowerCase()===t&&this._unformatEntire(e[c])},_unformatEntire:function(t){var i=m.dom(t);i.find("li").each(function(t){var e=m.dom(t),t=this._createUnformatContainer(e);e.remove(),i.before(t)}.bind(this)),i.remove()},_unformatAtSide:function(t,i,e){for(var s=0;s<i.length;s++){var n=m.dom(i[s]),o=this._createUnformatContainer(n);e[t](o);o=o.find("ul, ol").first();n.append(o),o.each(function(t){var e=m.dom(t),t=e.closest("li");t.get()===i[s]&&(e.unwrap(),t.addClass("r-unwrapped"))}),this.utils.isEmptyHtml(n.html())&&n.remove()}e.find(".r-unwrapped").each(function(t){t=m.dom(t);""===t.html().trim()?t.remove():t.removeClass("r-unwrapped")})},_getItemsPosition:function(t,e){var i="Middle",s=e[0],n=e[e.length-1],e=t.first().get(),t=t.last().get();return e===s&&t!==n?i="Top":e!==s&&t===n&&(i="Bottom"),i},_createUnformatContainer:function(t){var e=m.dom("<"+this.opts.markup+">");return this.opts.breakline&&e.attr("data-redactor-tag","br"),e.append(t.contents()),e},_getBlocks:function(){return this.selection.getBlocks({first:!0})},_observeButton:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),t=e.isPre()||e.isCode()||e.isFigcaption();this._observeButtonsList(t,["lists","ul","ol","outdent","indent"]);e=this.toolbar.getButton("outdent"),t=this.toolbar.getButton("indent");this._observeIndent(t,e)},_observeDropdown:function(t){var e=t.getItem("outdent"),t=t.getItem("indent");this._observeIndent(t,e)},_observeIndent:function(t,e){var i=this.selection.isCollapsed(),s=this.selection.getCurrent(),n=this.inspector.parse(s),s=!!n.isList()&&n.getListItem(),n=m.dom(s).prevElement().get(),n=i&&s&&n&&"LI"===n.tagName;e&&(s&&i?e.enable():e.disable()),t&&(s&&n?t.enable():t.disable())},_observeButtonsList:function(t,e){for(var i=0;i<e.length;i++){var s=this.toolbar.getButton(e[i]);s&&(t?s.disable():s.enable())}}}),m.add("class","video.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;void 0!==t?0!==(e=m.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.append(t)):this.parse("<figure>"),this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"video",tabindex:"-1",contenteditable:!1})}}),m.add("class","widget.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},getData:function(){return{html:this._getHtml()}},_init:function(t){var e;void 0!==t?0!==(e=m.dom(t).closest("figure")).length?this.parse(e):(this.parse("<figure>"),this.html(t)):this.parse("<figure>"),this._initWrapper()},_getHtml:function(){var t=m.dom("<div>");return t.html(this.html()),t.find(".redactor-component-caret").remove(),t.html()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"widget",tabindex:"-1",contenteditable:!1})}});var t=m;window.Redactor=window.$R=m,window.addEventListener("load",function(){m("[data-redactor]")}),"object"==typeof module&&module.exports&&(module.exports=t,module.exports.Redactor=t)}(),Redactor.add("plugin","alignment",{translations:{en:{align:"Align","align-left":"Align Left","align-center":"Align Center","align-right":"Align Right","align-justify":"Align Justify"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.block=t.block,this.toolbar=t.toolbar},start:function(){var t={};t.left={title:this.lang.get("align-left"),api:"plugin.alignment.set",args:"left"},t.center={title:this.lang.get("align-center"),api:"plugin.alignment.set",args:"center"},t.right={title:this.lang.get("align-right"),api:"plugin.alignment.set",args:"right"},t.justify={title:this.lang.get("align-justify"),api:"plugin.alignment.set",args:"justify"};var e=this.toolbar.addButton("alignment",{title:this.lang.get("align")});e.setIcon('<i class="re-icon-alignment"></i>'),e.setDropdown(t)},set:function(t){if("left"===t&&"ltr"===this.opts.direction)return this._remove();this.block.toggle({style:{"text-align":t}})},_remove:function(){this.block.remove({style:"text-align"})}}),function(i){i.add("plugin","beyondgrammar",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.cleaner=t.cleaner},onoriginalblur:function(t){var e;i.dom(t.target).hasClass("pwa-suggest")?(t.preventDefault(),this.app.stopBlur=!0,e=this.app.offset.get(),setTimeout(function(){this.app.offset.set(e)}.bind(this),10)):this.app.stopBlur=!1},onsource:{closed:function(){this.editor.focus(),this._activate()}},start:function(){this.GrammarChecker=this._getGrammarChecker(),this.opts.beyondgrammar&&this.GrammarChecker&&(this.cleaner.addUnconvertRules("spellcheck",function(t){t.find(".pwa-mark").unwrap()}),this._activate())},_activate:function(){var t=this.editor.getElement();t.attr("spellcheck",!1);var e=new this.GrammarChecker(t.get(),this.opts.beyondgrammar.service,this.opts.beyondgrammar.grammar);e.init().then(function(){e.activate()})},_getGrammarChecker:function(){return void 0!==window.BeyondGrammar&&window.BeyondGrammar.GrammarChecker}})}(Redactor),function(o){o.add("plugin","clips",{translations:{en:{clips:"Clips","clips-select":"Please, select a clip"}},modals:{clips:""},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.toolbar=t.toolbar,this.insertion=t.insertion},onmodal:{clips:{open:function(t){this._build(t)}}},start:function(){var t;this.opts.clips&&(t={title:this.lang.get("clips"),api:"plugin.clips.open"},this.toolbar.addButton("clips",t).setIcon('<i class="re-icon-clips"></i>'))},open:function(t){var e={title:this.lang.get("clips"),width:"600px",name:"clips"};this.app.api("module.modal.build",e)},_build:function(t){var e=t.getBody(),i=this._buildLabel(),t=this._buildList();this._buildItems(t),e.html(""),e.append(i),e.append(t)},_buildLabel:function(){var t=o.dom("<label>");return t.html(this.lang.parse("## clips-select ##:")),t},_buildList:function(){var t=o.dom("<ul>");return t.addClass("redactor-clips-list"),t},_buildItems:function(t){for(var e=this.opts.clips,i=0;i<e.length;i++){var s=o.dom("<li>"),n=o.dom("<span>");n.attr("data-index",i),n.html(e[i][0]),n.on("click",this._insert.bind(this)),s.append(n),t.append(s)}},_insert:function(t){t=o.dom(t.target).attr("data-index"),t=this.opts.clips[t][1];this.app.api("module.modal.close"),this.insertion.insertHtml(t)}})}(Redactor),Redactor.add("plugin","counter",{translations:{en:{words:"words",chars:"chars"}},init:function(t){this.app=t,this.lang=t.lang,this.utils=t.utils,this.editor=t.editor,this.statusbar=t.statusbar},start:function(){this.editor.getElement().on("keyup.redactor-plugin-counter paste.redactor-plugin-counter",this.count.bind(this)),this.count()},stop:function(){this.editor.getElement().off(".redactor-plugin-counter"),this.statusbar.remove("words"),this.statusbar.remove("chars")},count:function(){var t,e,i=0,s=0,n=0,o=this.editor.getElement().html();""!==(o=this._clean(o))&&(t=o.split(/\s+/),e=o.match(/\s/g),i=t?t.length:0,n=e?e.length:0,s=o.length);n={words:i,characters:s,spaces:n};this.app.broadcast("counter",n),this.statusbar.add("words",this.lang.get("words")+": "+n.words),this.statusbar.add("chars",this.lang.get("chars")+": "+n.characters)},_clean:function(t){return t=(t=(t=(t=(t=(t=(t=t.replace(/<\/(.*?)>/gi," ")).replace(/<(.*?)>/gi,"")).replace(/\t/gi,"")).replace(/\n/gi," ")).replace(/\r/gi," ")).replace(/&nbsp;/g,"1")).trim(),t=this.utils.removeInvisibleChars(t)}}),function(r){r.add("plugin","definedlinks",{init:function(t){this.app=t,this.opts=t.opts,this.component=t.component,this.links=[]},onmodal:{link:{open:function(t,e){this.opts.definedlinks&&(this.$modal=t,this.$form=e,this._load())}}},_load:function(){"object"==typeof this.opts.definedlinks?this._build(this.opts.definedlinks):r.ajax.get({url:this.opts.definedlinks,success:this._build.bind(this)})},_build:function(t){var e,i,s,n,o=this.$modal.find("#redactor-defined-links");for(s in 0===o.length&&(e=this.$modal.getBody(),i=r.dom('<div class="form-item" />'),o=r.dom('<select id="redactor-defined-links" />'),i.append(o),e.prepend(i)),this.links=[],o.html(""),o.off("change"),t)t.hasOwnProperty(s)&&"object"==typeof t[s]&&(this.links[s]=t[s],(n=r.dom("<option>")).val(s),n.html(t[s].name),o.append(n));o.on("change",this._select.bind(this))},_select:function(t){var e=this.$form.getData(),i=r.dom(t.target).val(),t={text:"",url:""};"0"!==i&&(t.text=this.links[i].name,t.url=this.links[i].url),""!==e.text&&(t={url:t.url}),this.$form.setData(t)}})}(Redactor),function(a){a.add("plugin","filemanager",{translations:{en:{choose:"Choose"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts},onmodal:{file:{open:function(t,e){this.opts.fileManagerJson&&this._load(t)}}},_load:function(t){t=t.getBody();this.$box=a.dom("<div>"),this.$box.attr("data-title",this.lang.get("choose")),this.$box.addClass("redactor-modal-tab"),this.$box.hide(),this.$box.css({overflow:"auto",height:"300px","line-height":1}),t.append(this.$box),a.ajax.get({url:this.opts.fileManagerJson,success:this._parse.bind(this)})},_parse:function(t){var e,i=a.dom('<ul id="redactor-filemanager-list">');for(e in t){var s,n,o,r=t[e];"object"==typeof r&&(s=a.dom("<li>"),(n=a.dom("<a>")).attr("href","#"),n.addClass("redactor-file-manager-link"),n.attr("data-params",encodeURI(JSON.stringify(r))),n.text(r.title||r.name),n.on("click",this._insert.bind(this)),(o=a.dom("<span>")).addClass("r-file-name"),o.text(r.name),n.append(o),(o=a.dom("<span>")).addClass("r-file-size"),o.text("("+r.size+")"),n.append(o),s.append(n),i.append(s))}this.$box.append(i)},_insert:function(t){t.preventDefault();t=a.dom(t.target).closest(".redactor-file-manager-link"),t=JSON.parse(decodeURI(t.attr("data-params")));this.app.api("module.file.insert",{file:t})}})}(Redactor),function(c){c.add("plugin","fontcolor",{translations:{en:{fontcolor:"Text Color",text:"Text",highlight:"Highlight"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.selection=t.selection,this.colors=this.opts.fontcolors||["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"]},onfontcolor:{set:function(t,e){this._set(t,e)},remove:function(t){this._remove(t)}},start:function(){var t={title:this.lang.get("fontcolor")},e=this._buildDropdown();this.$button=this.toolbar.addButton("fontcolor",t),this.$button.setIcon('<i class="re-icon-fontcolor"></i>'),this.$button.setDropdown(e)},_buildDropdown:function(){var t=c.dom('<div class="redactor-dropdown-cells">');return this.$selector=this._buildSelector(),this.$selectorText=this._buildSelectorItem("text",this.lang.get("text")),this.$selectorText.addClass("active"),this.$selectorBack=this._buildSelectorItem("back",this.lang.get("highlight")),this.$selector.append(this.$selectorText),this.$selector.append(this.$selectorBack),this.$pickerText=this._buildPicker("textcolor"),this.$pickerBack=this._buildPicker("backcolor"),t.append(this.$selector),t.append(this.$pickerText),t.append(this.$pickerBack),this._buildSelectorEvents(),t.width(242),t},_buildSelector:function(){var t=c.dom("<div>");return t.addClass("redactor-dropdown-selector"),t},_buildSelectorItem:function(t,e){var i=c.dom("<span>");return i.attr("rel",t).html(e),i.addClass("redactor-dropdown-not-close"),i},_buildSelectorEvents:function(){this.$selectorText.on("mousedown",function(t){t.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerBack.hide(),this.$pickerText.show(),this.$selectorText.addClass("active")}.bind(this)),this.$selectorBack.on("mousedown",function(t){t.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerText.hide(),this.$pickerBack.show(),this.$selectorBack.addClass("active")}.bind(this))},_buildPicker:function(t){function e(t){t.preventDefault(),t=c.dom(t.target),o._set(t.data("rule"),t.attr("rel"))}for(var i=c.dom('<div class="re-dropdown-box-'+t+'">'),s="backcolor"==t?"background-color":"color",n=this.colors.length,o=this,r=0;r<n;r++){var a=this.colors[r],l=c.dom("<span>");l.attr({rel:a,"data-rule":s}),l.css({"background-color":a,"font-size":0,border:"2px solid #fff",width:"22px",height:"22px"}),l.on("mousedown",e),i.append(l)}var h=c.dom("<a>");return h.attr({href:"#"}),h.css({display:"block",clear:"both",padding:"8px 5px","font-size":"12px","line-height":1}),h.html(this.lang.get("none")),h.on("click",function(t){t.preventDefault(),o._remove(s)}),i.append(h),"backcolor"==t&&i.hide(),i},_set:function(t,e){var i={};i[t]=e,this.inline.format({tag:"span",style:i,type:"toggle"})},_remove:function(t){this.inline.remove({style:t})}})}(Redactor),Redactor.add("plugin","fontfamily",{translations:{en:{fontfamily:"Font","remove-font-family":"Remove Font Family"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.fonts=this.opts.fontfamily||["Arial","Helvetica","Georgia","Times New Roman","Monospace"]},start:function(){for(var t={},e=0;e<this.fonts.length;e++){var i=this.fonts[e];t[e]={title:i.replace(/'/g,""),api:"plugin.fontfamily.set",args:i}}t.remove={title:this.lang.get("remove-font-family"),api:"plugin.fontfamily.remove"};var s=this.toolbar.addButton("fontfamily",{title:this.lang.get("fontfamily")});s.setIcon('<i class="re-icon-fontfamily"></i>'),s.setDropdown(t)},set:function(t){this.inline.format({tag:"span",style:{"font-family":t},type:"toggle"})},remove:function(){this.inline.remove({style:"font-family"})}}),Redactor.add("plugin","fontsize",{translations:{en:{size:"Size","remove-size":"Remove Font Size"}},init:function(t){this.app=t,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.sizes=[10,11,12,14,16,18,20,24,28,30]},start:function(){for(var t={},e=0;e<this.sizes.length;e++){var i=this.sizes[e];t[e]={title:i+"px",api:"plugin.fontsize.set",args:i}}t.remove={title:this.lang.get("remove-size"),api:"plugin.fontsize.remove"};var s=this.toolbar.addButton("fontsize",{title:this.lang.get("size")});s.setIcon('<i class="re-icon-fontsize"></i>'),s.setDropdown(t)},set:function(t){this.inline.format({tag:"span",style:{"font-size":t+"px"},type:"toggle"})},remove:function(){this.inline.remove({style:"font-size"})}}),function(s){s.add("plugin","fullscreen",{translations:{en:{fullscreen:"Fullscreen"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.container=t.container,this.selection=t.selection,this.isOpen=!1,this.docScroll=0},start:function(){var t={title:this.lang.get("fullscreen"),api:"plugin.fullscreen.toggle"};this.toolbar.addButton("fullscreen",t).setIcon('<i class="re-icon-expand"></i>'),this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this.opts.fullscreen&&this.toggle()},toggle:function(){return this.isOpen?this.close():this.open()},open:function(){this.docScroll=this.$doc.scrollTop(),this._createPlacemarker(),this.selection.save();var t=this.container.getElement(),e=this.editor.getElement(),i=this.toolbar.isTarget()?s.dom("body, html"):this.$target;this.opts.toolbarExternal&&this._buildInternalToolbar(),this.$target.prepend(t),this.$target.addClass("redactor-body-fullscreen"),t.addClass("redactor-box-fullscreen"),this.isTarget&&t.addClass("redactor-box-fullscreen-target"),i.css("overflow","hidden"),this.opts.maxHeight&&e.css("max-height",""),this.opts.minHeight&&e.css("min-height",""),this._resize(),this.$win.on("resize.redactor-plugin-fullscreen",this._resize.bind(this)),this.$doc.scrollTop(0),this.toolbar.getButton("fullscreen").setIcon('<i class="re-icon-retract"></i>'),this.selection.restore(),this.isOpen=!0,this.opts.zindex=1051,window.jQuery&&window.jQuery(document).off("focusin.modal")},close:function(){this.isOpen=!1,this.opts.zindex=!1,this.selection.save();var t=this.container.getElement(),e=this.editor.getElement(),i=s.dom("body, html");this.opts.toolbarExternal&&this._buildExternalToolbar(),this.$target.removeClass("redactor-body-fullscreen"),this.$win.off("resize.redactor-plugin-fullscreen"),i.css("overflow",""),t.removeClass("redactor-box-fullscreen redactor-box-fullscreen-target"),e.css("height","auto"),this.opts.minHeight&&e.css("minHeight",this.opts.minHeight),this.opts.maxHeight&&e.css("maxHeight",this.opts.maxHeight),this.toolbar.getButton("fullscreen").setIcon('<i class="re-icon-expand"></i>'),this._removePlacemarker(t),this.selection.restore(),this.$doc.scrollTop(this.docScroll)},_resize:function(){var t=this.toolbar.getElement(),e=this.editor.getElement(),t=this.$win.height()-t.height();e.height(t)},_buildInternalToolbar:function(){var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-wrapper"),t.append(e),e.removeClass("redactor-toolbar-external"),$container.prepend(t)},_buildExternalToolbar:function(){var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();this.$external=s.dom(this.opts.toolbarExternal),e.addClass("redactor-toolbar-external"),this.$external.append(e),t.remove()},_createPlacemarker:function(){var t=this.container.getElement();this.$placemarker=s.dom("<span />"),t.after(this.$placemarker)},_removePlacemarker:function(t){this.$placemarker.before(t),this.$placemarker.remove()}})}(Redactor),function(o){o.add("plugin","handle",{init:function(t){this.app=t,this.opts=t.opts,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.marker=t.marker,this.keycodes=t.keycodes,this.container=t.container,this.selection=t.selection,this.handleTrigger=void 0!==this.opts.handleTrigger?this.opts.handleTrigger:"@",this.handleStart=void 0!==this.opts.handleStart?this.opts.handleStart:0,this.handleStr="",this.handleLen=this.handleStart},start:function(){var t;this.opts.handle&&((t=this.editor.getElement()).on("keyup.redactor-plugin-handle",this._handle.bind(this)),t.on("keydown.redactor-plugin-handle",this._listen.bind(this)))},stop:function(){this.editor.getElement().off(".redactor-plugin-handle"),this.$doc.off(".redactor-plugin-handle"),o.dom("#redactor-handle-list").remove()},_handle:function(t){var e=t.which,t=t.ctrlKey||t.metaKey;if(e===this.keycodes.BACKSPACE){if(!(this._isShown()&&this.handleLen>this.handleStart))return;this.handleLen=this.handleLen-2,this.handleLen<=this.handleStart&&this._hide()}e===this.keycodes.DELETE||e===this.keycodes.ESC||e===this.keycodes.SHIFT||t||-1!==[37,38,39,40].indexOf(e)||(e=new RegExp("^"+this.handleTrigger),this.handleStr=this.selection.getTextBeforeCaret(this.handleLen+1),e.test(this.handleStr)&&(this.handleStr=this.handleStr.replace(this.handleTrigger,""),this.handleLen++,this._load()))},_listen:function(t){var e,i=t.which,s=this.keycodes;if(this._isShown()&&i===s.ENTER)return 0===(e=this._getActiveItem()).length||(t.preventDefault(),this._replace(t,e)),void this._hideForce();!this._isShown()||40!==i&&38!==i||(t.preventDefault(),0===(e=this._getActiveItem()).length?(t=this._getFirstItem(),this._setActive(t)):40===i?this._setNextActive(e):38===i&&this._setPrevActive(e))},_getItems:function(){return this.$list.find("a")},_getActiveItem:function(){return this._getItems().filter(function(t){return o.dom(t).hasClass("active")})},_getFirstItem:function(){return this._getItems().first()},_getLastItem:function(){return this._getItems().last()},_setActive:function(t){this._getItems().removeClass("active"),t.addClass("active");var e=t.outerHeight(),i=t.position().top,s=this.$list.scrollTop(),n=i+2*e,t=this.$list.outerHeight();this.$list.scrollTop(s+t<n?n-t:i-e<s?i-e:s)},_setNextActive:function(t){t=t.next();0!==t.length?this._setActive(t):(t=this._getFirstItem(),this._setActive(t))},_setPrevActive:function(t){t=t.prev();0!==t.length?this._setActive(t):(t=this._getLastItem(),this._setActive(t))},_load:function(){o.ajax.post({url:this.opts.handle,data:"handle="+this.handleStr,success:this._parse.bind(this)})},_parse:function(t){""!==t&&(t="object"==typeof t?t:JSON.parse(t),this._build(),this._buildData(t))},_build:function(){this.$list=o.dom("#redactor-handle-list"),0===this.$list.length&&(this.$list=o.dom('<div id="redactor-handle-list">'),this.$body.append(this.$list))},_buildData:function(t){this.data=t,this._update(),this._show()},_update:function(){for(var t in this.$list.html(""),this.data){var e=o.dom('<a href="#">');e.html(this.data[t].item),e.attr("data-key",t),e.on("click",this._replace.bind(this)),this.$list.append(e)}this.container.getElement().offset();var i=this.selection.getPosition();this.$list.addClass("open"),this.$list.css({top:i.top+i.height+this.$doc.scrollTop()+"px",left:i.left+"px"})},_isShown:function(){return this.$list&&this.$list.hasClass("open")},_show:function(){this.$list.addClass("open"),this.$list.show(),this.$doc.off(".redactor-plugin-handle"),this.$doc.on("click.redactor-plugin-handle keydown.redactor-plugin-handle",this._hide.bind(this))},_hide:function(t){var e=!1,i=t&&t.which;(e=!t||"click"===t.type||i===this.keycodes.ESC||i===this.keycodes.SPACE?!0:e)&&this._hideForce()},_hideForce:function(){this.$list.removeClass("open"),this.$list.hide(),this._reset()},_reset:function(){this.handleStr="",this.handleLen=this.handleStart},_replace:function(t,e){t.preventDefault();var i=(e||o.dom(t.target)).attr("data-key"),s=this.data[i].replacement,n=this.marker.insert("start"),e=o.dom(n),t=n.previousSibling,i=t.textContent,n=new RegExp(this.handleTrigger+this.handleStr+"$"),i=i.replace(n,"");t.textContent=i,e.before(s),this.selection.restoreMarkers()}})}(Redactor),function(n){n.add("plugin","imagemanager",{translations:{en:{choose:"Choose"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts},onmodal:{image:{open:function(t,e){this.opts.imageManagerJson&&this._load(t)}}},_load:function(t){t=t.getBody();this.$box=n.dom("<div>"),this.$box.attr("data-title",this.lang.get("choose")),this.$box.addClass("redactor-modal-tab"),this.$box.hide(),this.$box.css({overflow:"auto",height:"300px","line-height":1}),t.append(this.$box),n.ajax.get({url:this.opts.imageManagerJson,success:this._parse.bind(this)})},_parse:function(t){for(var e in t){var i,s=t[e];"object"==typeof s&&(i=n.dom("<img>"),e=s.thumb||s.url,i.attr("src",e),i.attr("data-params",encodeURI(JSON.stringify(s))),i.css({width:"96px",height:"72px",margin:"0 4px 2px 0",cursor:"pointer"}),i.on("click",this._insert.bind(this)),this.$box.append(i))}},_insert:function(t){t.preventDefault();t=n.dom(t.target),t=JSON.parse(decodeURI(t.attr("data-params")));this.app.api("module.image.insert",{image:t})}})}(Redactor),Redactor.add("plugin","inlinestyle",{translations:{en:{style:"Style"}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.styles={marked:{title:"Marked",args:"mark"},code:{title:"Code",args:"code"},variable:{title:"Variable",args:"var"},shortcut:{title:"Shortcut",args:"kbd"},sup:{title:"Superscript",args:"sup"},sub:{title:"Subscript",args:"sub"}}},start:function(){var t,e={};for(t in this.styles){var i=this.styles[t];e[t]={title:i.title,api:"module.inline.format",args:i.args}}var s=this.toolbar.addButtonAfter("format","inline",{title:this.lang.get("style")});s.setIcon('<i class="re-icon-inline"></i>'),s.setDropdown(e)}}),Redactor.add("plugin","limiter",{init:function(t){this.app=t,this.utils=t.utils,this.opts=t.opts,this.editor=t.editor,this.keycodes=t.keycodes},onpasting:function(t){var e;this.opts.limiter&&(t=this.utils.removeInvisibleChars(t),e=this._getText(),e=t.length+e.length,this.opts.input=!(e>=this.opts.limiter))},start:function(){this.opts.limiter&&(this._count(),this.editor.getElement().on("keydown.redactor-plugin-limiter",this._limit.bind(this)))},stop:function(){this.editor.getElement().off(".redactor-plugin-limiter"),this.opts.input=!0},_limit:function(t){var e=t.which,i=t.ctrlKey||t.metaKey;e===this.keycodes.BACKSPACE||e===this.keycodes.DELETE||e===this.keycodes.ESC||e===this.keycodes.SHIFT||i&&65===e||i&&88===e||i&&82===e||i&&116===e||-1!==[37,38,39,40].indexOf(e)||this._count(t)},_count:function(t){if(this._getText().length>=this.opts.limiter)return t&&t.preventDefault(),this.opts.input=!1;this.opts.input=!0},_getText:function(){var t=this.editor.getElement().text();return this.utils.removeInvisibleChars(t)}}),function(s){s.add("plugin","properties",{modals:{properties:'<form action="">                     <div class="form-item">                         <label>Id</label>                         <input type="text" name="id">                     </div>                     <div class="form-item">                         <label>Class</label>                         <input type="text" name="classname">                     </div>                 </form>'},translations:{en:{properties:"Properties"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$body=t.$body,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection,this.labelStyle={"font-family":"monospace",position:"absolute",padding:"2px 5px","line-height":1,"border-radius":"3px","font-size":"11px",color:"rgba(255, 255, 255, .9)"}},onmodal:{properties:{open:function(t,e){var i;this.$block&&(i=this._getData(this.$block),e.setData(i))},opened:function(t,e){e.getField("id").focus()},save:function(t,e){e=e.getData();this._save(e)}}},onbutton:{properties:{observe:function(t){this._observeButton(t)}}},onclick:function(){},start:function(){var t={title:this.lang.get("properties"),api:"plugin.properties.open",observe:"properties"};this.toolbar.addButton("properties",t).setIcon('<i class="re-icon-properties"></i>'),this._createLabel()},stop:function(){this._removeLabel()},open:function(){var t=this.selection.getBlock();t&&(this.$block=s.dom(t),t={title:this.lang.get("properties"),width:"500px",name:"properties",handle:"save",commands:{save:{title:this.lang.get("save")},cancel:{title:this.lang.get("cancel")}}},this.app.api("module.modal.build",t))},_save:function(t){this.app.api("module.modal.close"),""===t.id?this.$block.removeAttr("id"):this.$block.attr("id",t.id),""===t.classname?this.$block.removeAttr("class"):this.$block.attr("class",t.classname)},_getData:function(t){t=s.dom(t);return{id:t.attr("id"),classname:t.attr("class")}},_showData:function(t,e){var i="";e.id&&(i+="#"+e.id+" "),e.classname&&(i+="."+e.classname),""!==i?(t=s.dom(t).offset(),this.$label.css({top:t.top-12+"px",left:t.left+"px","z-index":this.opts.zindex?this.opts.zindex+3:"auto"}),this.$label.html(i),this.$label.show()):this.$label.hide()},_createLabel:function(){this.$label=s.dom("<span />"),this.$label.hide(),this.$label.css(this.labelStyle).css("background","rgba(229, 57, 143, .7)"),this.$body.append(this.$label)},_removeLabel:function(){this.$label&&this.$label.remove()},_observeButton:function(t){var e=this.selection.getBlock(),i=this.inspector.parse(e);e&&!i.isComponent()?(i=this._getData(e),this._showData(e,i),t.enable()):(t.disable(),this.$label&&this.$label.hide())}})}(Redactor),function(o){o.add("plugin","specialchars",{translations:{en:{specialchars:"Special Characters"}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.insertion=t.insertion,this.chars=["&lsquo;","&rsquo;","&ldquo;","&rdquo;","&ndash;","&mdash;","&divide;","&hellip;","&trade;","&bull;","&rarr;","&asymp;","$","&euro;","&cent;","&pound;","&yen;","&iexcl;","&curren;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&raquo;","&not;","&reg;","&macr;","&deg;","&sup1;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&ordm;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&OElig;","&oelig;","&#372;","&#374","&#373","&#375;"]},start:function(){var t={title:this.lang.get("specialchars")},e=this._buildDropdown();this.$button=this.toolbar.addButton("specialchars",t),this.$button.setIcon('<i class="re-icon-specialcharacters"></i>'),this.$button.setDropdown(e)},_set:function(t){this.insertion.insertChar(t)},_buildDropdown:function(){function t(t){t.preventDefault(),t=o.dom(t.target),e._set(t.data("char"))}for(var e=this,i=o.dom('<div class="redactor-dropdown-cells">'),s=0;s<this.chars.length;s++){var n=o.dom("<a>");n.attr({href:"#","data-char":this.chars[s]}),n.css({"line-height":"32px",width:"32px",height:"32px"}),n.html(this.chars[s]),n.on("click",t),i.append(n)}return i}})}(Redactor),function(o){o.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.caret=t.caret,this.editor=t.editor,this.toolbar=t.toolbar,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},ondropdown:{table:{observe:function(t){this._observeDropdown(t)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var t={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"}},e={title:this.lang.get("table")},e=this.toolbar.addButtonBefore("link","table",e);e.setIcon('<i class="re-icon-table"></i>'),e.setDropdown(t)},insert:function(){for(var t=this.component.create("table"),e=0;e<2;e++)t.addRow(3);t=this.insertion.insertHtml(t),this.caret.setStart(t)},addRowAbove:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),t=e.addRowTo(t,"before"),this.caret.setStart(t))},addRowBelow:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),t=e.addRowTo(t,"after"),this.caret.setStart(t))},addColumnLeft:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),this.selection.save(),e.addColumnTo(t,"left"),this.selection.restore())},addColumnRight:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),this.selection.save(),e.addColumnTo(t,"right"),this.selection.restore())},addHead:function(){var t=this._getComponent();t&&(this.selection.save(),t.addHead(),this.selection.restore())},deleteHead:function(){var t,e=this._getComponent();e&&(t=this.selection.getCurrent(),0!==o.dom(t).closest("thead").length?(e.removeHead(),this.caret.setStart(e)):(this.selection.save(),e.removeHead(),this.selection.restore()))},deleteColumn:function(){var t,e,i,s=this._getComponent();s&&(t=this.selection.getCurrent(),e=(i=o.dom(t).closest("td, th")).nextElement().get(),i=i.prevElement().get(),s.removeColumn(t),e?this.caret.setStart(e):i?this.caret.setEnd(i):this.deleteTable())},deleteRow:function(){var t,e,i,s,n=this._getComponent();n&&(t=this.selection.getCurrent(),e=(s=o.dom(t).closest("tr")).nextElement().get(),i=s.prevElement().get(),s=o.dom(t).closest("thead"),n.removeRow(t),e?this.caret.setStart(e):i?this.caret.setEnd(i):0!==s.length?(n.removeHead(),this.caret.setStart(n)):this.deleteTable())},deleteTable:function(){var t=this._getTable();t&&this.component.remove(t)},_getTable:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isTable())return t.getTable()},_getComponent:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isTable()){t=t.getTable();return this.component.create("table",t)}},_observeDropdown:function(t){var e=this._getTable(),i=t.getItemsByClass("redactor-table-item-observable"),t=t.getItem("insert-table");e?(this._observeItems(i,"enable"),t.disable()):(this._observeItems(i,"disable"),t.enable())},_observeItems:function(t,e){for(var i=0;i<t.length;i++)t[i][e]()}})}(Redactor),function(o){o.add("class","table.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},addHead:function(){this.removeHead();var t=this.$element.find("tr").first().children("td, th").length,e=o.dom("<thead>"),t=this._buildRow(t,"<th>");e.append(t),this.$element.prepend(e)},addRow:function(t){t=this._buildRow(t);return this.$element.append(t),t},addRowTo:function(t,e){return this._addRowTo(t,e)},addColumnTo:function(t,i){var e=o.dom(t),t=e.closest("tr"),s=e.closest("td, th"),n=0;t.find("td, th").each(function(t,e){t===s.get()&&(n=e)}),this.$element.find("tr").each(function(t){var e=o.dom(t).find("td, th").get(n),t=o.dom(e),e=t.clone();e.html('<div data-redactor-tag="tbr"></div>'),"right"===i?t.after(e):t.before(e)})},removeHead:function(){var t=this.$element.find("thead");0!==t.length&&t.remove()},removeRow:function(t){o.dom(t).closest("tr").remove()},removeColumn:function(t){var e=o.dom(t),t=e.closest("tr"),i=e.closest("td, th"),s=0;t.find("td, th").each(function(t,e){t===i.get()&&(s=e)}),this.$element.find("tr").each(function(t){t=o.dom(t).find("td, th").get(s);o.dom(t).remove()})},_init:function(t){var e,i,s;void 0!==t&&(t=(s=o.dom(t)).get(),0!==(s=s.closest("figure")).length?i=(e=s).find("table").get():"TABLE"===t.tagName&&(i=t)),this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_addRowTo:function(t,e){var i=o.dom(t).closest("tr");if(0!==i.length){t=i.children("td, th").length,t=this._buildRow(t);return i[e](t),t}},_buildRow:function(t,e){e=e||"<td>";for(var i=o.dom("<tr>"),s=0;s<t;s++){var n=o.dom(e);n.attr("contenteditable",!0),n.html('<div data-redactor-tag="tbr"></div>'),i.append(n)}return i},_buildElement:function(t){t?this.$element=o.dom(t):(this.$element=o.dom("<table>"),this.append(this.$element))},_buildWrapper:function(t){this.parse(t=t||"<figure>")},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1}),this.app.detector.isIe()&&this.removeAttr("contenteditable")}})}(Redactor),function(i){i.add("plugin","textdirection",{translations:{en:{"change-text-direction":"RTL-LTR","left-to-right":"Left to Right","right-to-left":"Right to Left"}},init:function(t){this.app=t,this.lang=t.lang,this.block=t.block,this.editor=t.editor,this.toolbar=t.toolbar,this.selection=t.selection},start:function(){var t={};t.ltr={title:this.lang.get("left-to-right"),api:"plugin.textdirection.set",args:"ltr"},t.rtl={title:this.lang.get("right-to-left"),api:"plugin.textdirection.set",args:"rtl"};var e=this.toolbar.addButton("textdirection",{title:this.lang.get("change-text-direction")});e.setIcon('<i class="re-icon-textdirection"></i>'),e.setDropdown(t)},set:function(t){var e=this.selection.getBlock();e&&"LI"===e.tagName?(e=i.dom(e).parents("ul, ol",this.editor.getElement()).last(),this.block.add({attr:{dir:t}},!1,e)):this.block.add({attr:{dir:t}})}})}(Redactor),Redactor.add("plugin","textexpander",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.marker=t.marker,this.keycodes=t.keycodes,this.selection=t.selection},start:function(){this.opts.textexpander&&this.editor.getElement().on("keyup.redactor-plugin-textexpander",this._expand.bind(this))},stop:function(){this.editor.getElement().off(".redactor-plugin-textexpander")},_expand:function(t){if(t.which===this.keycodes.SPACE)for(var e=this.opts.textexpander.length,i=0;i<e;i++){var s=this.opts.textexpander[i],n=new RegExp(this.utils.escapeRegExp(s[0])+"\\s$"),o=this.selection.getTextBeforeCaret(s[0].length+1).replace(/\s$/,"");if(s[0]===o)return this._replaceSelection(n,s[1])}},_replaceSelection:function(t,e){var i=this.marker.insert("start").previousSibling,s=i.textContent;s=(s=s.replace(/&nbsp;/," ")).replace(t,e),i.textContent=s,this.selection.restoreMarkers()}}),function(a){a.add("plugin","variable",{translations:{en:{change:"Change",variable:"Variable","variable-select":"Please, select a variable"}},modals:{variable:""},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.toolbar=t.toolbar,this.component=t.component,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection},onmodal:{variable:{open:function(t,e){this._build(t)}}},oncontextbar:function(t,e){var i,s=this.inspector.parse(t.target);s.isComponentType("variable")&&(i=s.getComponent(),s={change:{title:this.lang.get("change"),api:"plugin.variable.open",args:i},remove:{title:this.lang.get("delete"),api:"plugin.variable.remove",args:i}},e.set(t,i,s,"bottom"))},start:function(){var t;this.opts.variables&&(t={title:this.lang.get("variable"),api:"plugin.variable.open"},this.toolbar.addButton("variable",t).setIcon('<i class="re-icon-variable"></i>'))},open:function(){var t={title:this.lang.get("variable"),width:"600px",name:"variable"};this.$currentItem=this._getCurrent(),this.app.api("module.modal.build",t)},insert:function(t){this.app.api("module.modal.close");var e=t.attr("data-type"),t=this.component.create("variable");t.html(e),this.insertion.insertRaw(t)},remove:function(t){this.component.remove(t)},_getCurrent:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isComponentType("variable"))return this.component.build(t.getComponent())},_build:function(t){var e=t.getBody(),i=this._buildLabel(),t=this._buildList();this._buildItems(t),e.html(""),e.append(i),e.append(t)},_buildLabel:function(){var t=a.dom("<label>");return t.html(this.lang.parse("## variable-select ##:")),t},_buildList:function(){var t=a.dom("<ul>");return t.addClass("redactor-variables-list"),t},_buildItems:function(t){for(var e=this._getCurrentType(),i=this.opts.variables,s=0;s<i.length;s++){var n=i[s].trim(),o=a.dom("<li>"),r=a.dom("<span>");r.attr("data-type",n),r.html(n),r.on("click",this._toggle.bind(this)),e===n&&r.addClass("redactor-variables-item-selected"),o.append(r),t.append(o)}},_getCurrentType:function(){return!!this.$currentItem&&this.$currentItem.getData().type},_toggle:function(t){t=a.dom(t.target);this.app.api("plugin.variable.insert",t)}})}(Redactor),Redactor.add("class","variable.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.utils=t.utils,e&&void 0!==e.cmnt?e:this._init(e)},getData:function(){return{type:this._getType()}},_init:function(t){this.parse(t=t||"<span>"),this._initWrapper()},_getType:function(){var t=this.text().trim();return this.utils.removeInvisibleChars(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"variable",tabindex:"-1",contenteditable:!1})}}),Redactor.add("plugin","video",{translations:{en:{video:"Video","video-html-code":"Video Embed Code or Youtube/Vimeo Link"}},modals:{video:'<form action="">                     <div class="form-item">                         <label for="modal-video-input">## video-html-code ##</label>                         <textarea id="modal-video-input" name="video" style="height: 160px;"></textarea>                     </div>                 </form>'},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.toolbar=t.toolbar,this.component=t.component,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection},onmodal:{video:{opened:function(t,e){$video=e.getField("video"),$video.focus()},insert:function(t,e){e=e.getData();this._insert(e)}}},oncontextbar:function(t,e){var i,s=this.inspector.parse(t.target);s.isComponentType("video")&&(i=s.getComponent(),s={remove:{title:this.lang.get("delete"),api:"plugin.video.remove",args:i}},e.set(t,i,s,"bottom"))},start:function(){var t={title:this.lang.get("video"),api:"plugin.video.open"};this.toolbar.addButtonAfter("image","video",t).setIcon('<i class="re-icon-video"></i>')},open:function(){var t={title:this.lang.get("video"),width:"600px",name:"video",handle:"insert",commands:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}}};this.app.api("module.modal.build",t)},remove:function(t){this.component.remove(t)},_insert:function(t){this.app.api("module.modal.close"),""!==t.video.trim()&&(t.video=this._matchData(t.video),this._isVideoIframe(t.video)&&(t=this.component.create("video",t.video),this.insertion.insertHtml(t)))},_isVideoIframe:function(t){return null!==t.match(/<iframe|<video/gi)},_matchData:function(t){var i,e,s='<iframe style="width: 500px; height: 281px;" src="',n='" frameborder="0" allowfullscreen></iframe>';return this._isVideoIframe(t)?(i=["iframe","video","source"],t=(t=t.replace(/<p(.*?[^>]?)>([\w\W]*?)<\/p>/gi,"")).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,e){return-1===i.indexOf(e.toLowerCase())?"":t})):t.match(this.opts.regex.youtube)?(e="//www.youtube.com",-1!==t.search("youtube-nocookie.com")&&(e="//www.youtube-nocookie.com"),t=t.replace(this.opts.regex.youtube,s+e+"/embed/$1"+n)):t.match(this.opts.regex.vimeo)&&(t=t.replace(this.opts.regex.vimeo,s+"//player.vimeo.com/video/$2"+n)),t}}),Redactor.add("plugin","widget",{translations:{en:{widget:"Widget","widget-html-code":"Widget HTML Code"}},modals:{widget:'<form action="">                     <div class="form-item">                         <label for="modal-widget-input">## widget-html-code ##</label>                         <textarea id="modal-widget-input" name="widget" style="height: 200px;"></textarea>                     </div>                 </form>'},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.toolbar=t.toolbar,this.component=t.component,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection},onmodal:{widget:{opened:function(t,e){var i;e.getField("widget").focus(),this.$currentItem&&(i=decodeURI(this.$currentItem.attr("data-widget-code")),e.getField("widget").val(i))},insert:function(t,e){e=e.getData();this._insert(e)}}},oncontextbar:function(t,e){var i,s=this.inspector.parse(t.target);!s.isFigcaption()&&s.isComponentType("widget")&&(i=s.getComponent(),s={edit:{title:this.lang.get("edit"),api:"plugin.widget.open",args:i},remove:{title:this.lang.get("delete"),api:"plugin.widget.remove",args:i}},e.set(t,i,s,"bottom"))},onbutton:{widget:{observe:function(t){this._observeButton(t)}}},start:function(){var t={title:this.lang.get("widget"),api:"plugin.widget.open",observe:"widget"};this.toolbar.addButton("widget",t).setIcon('<i class="re-icon-widget"></i>')},open:function(){this.$currentItem=this._getCurrent();var t={title:this.lang.get("widget"),width:"600px",name:"widget",handle:"insert",commands:{insert:{title:this.$currentItem?this.lang.get("save"):this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}}};this.app.api("module.modal.build",t)},remove:function(t){this.component.remove(t)},_getCurrent:function(){var t=this.selection.getCurrent(),t=this.inspector.parse(t);if(t.isComponentType("widget"))return this.component.build(t.getComponent())},_insert:function(t){var e;this.app.api("module.modal.close"),""!==t.widget.trim()&&(e=this._isHtmlString(t.widget)?t.widget:document.createTextNode(t.widget),(e=this.component.create("widget",e)).attr("data-widget-code",encodeURI(t.widget.trim())),this.insertion.insertHtml(e))},_isHtmlString:function(t){return!("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))},_observeButton:function(t){var e=this.selection.getCurrent();this.inspector.parse(e).isComponentType("table")?t.disable():t.enable()}});
//# sourceMappingURL=redactor.min.js.map